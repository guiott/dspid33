<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>dsPid33: src/dsPID33.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="Ico.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">dsPid33
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('ds_p_i_d33_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">src/dsPID33.c</div>  </div>
</div>
<div class="contents">
<a href="ds_p_i_d33_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* ////////////////////////////////////////////////////////////////////////////</span>
<a name="l00002"></a>00002 <span class="comment">** File:      dsPid33.c</span>
<a name="l00003"></a>00003 <span class="comment">*/</span>                                  
<a name="l00004"></a><a class="code" href="ds_p_i_d33_8c.html#a7417cfdacc213b0d90c30c0a81097032">00004</a>  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>  <a class="code" href="ds_p_i_d33_8c.html#a7417cfdacc213b0d90c30c0a81097032">Ver</a>[] = <span class="stringliteral">&quot;dsPid33 2.2.6 Guiott 12-11&quot;</span>; <span class="comment">// 26+1 char</span>
<a name="l00039"></a>00039 <span class="comment"></span><span class="preprocessor">#include &quot;<a class="code" href="ds_p_i_d33__definitions_8h.html">dsPID33_definitions.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="_d_e_e_01_emulation_0116-bit_8h.html">DEE Emulation 16-bit.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="ds_p_i_d33_8c.html#a840291bc02cba5474a4cb46a9b9566fe">00042</a> <span class="keywordtype">int</span> <a class="code" href="ds_p_i_d33_8c.html#a840291bc02cba5474a4cb46a9b9566fe">main</a> (<span class="keywordtype">void</span>)
<a name="l00043"></a>00043 {
<a name="l00053"></a>00053 <a class="code" href="ds_p_i_d33__prototypes_8h.html#a76a2d0d871b5d35b5cab2de8d7173856">Settings</a>();
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">//[1]</span>
<a name="l00056"></a>00056 LED1 = 1; 
<a name="l00057"></a>00057 LED2 = 0;
<a name="l00058"></a>00058 <span class="comment">// MOTOR_ENABLE1 = 0;</span>
<a name="l00059"></a>00059 <span class="comment">// MOTOR_ENABLE2 = 0;</span>
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <a class="code" href="ds_p_i_d33__definitions_8h.html#acedf0e3776cd3c63d65c0d02bbde08a6">Tmr2OvflwCount1</a>=0;
<a name="l00062"></a>00062 <a class="code" href="ds_p_i_d33__definitions_8h.html#ad63f62ab5ed4d15c4de921414dacbc2e">Tmr2OvflwCount2</a>=0;
<a name="l00063"></a>00063 <a class="code" href="ds_p_i_d33__definitions_8h.html#a955742b4d3aa6e546452f6157d58bfe6">IC1_FIRST</a> = 0;
<a name="l00064"></a>00064 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6e3011a1d22ee08bfd8a5eb0b7368b45">IC2_FIRST</a> = 0;
<a name="l00065"></a>00065 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdb5ebd40a9d20e527a8a08e50af4409">RAMP_FLAG1</a> = 0;
<a name="l00066"></a>00066 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4aaf95d79a76519a4e96a4b83b7fd2f3">RAMP_FLAG2</a> = 0;
<a name="l00067"></a>00067 <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> = 0;
<a name="l00068"></a>00068 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> = 0;
<a name="l00069"></a>00069 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="comment">// to start first and second slower cycles over 1ms cycle</span>
<a name="l00072"></a>00072 <a class="code" href="ds_p_i_d33__definitions_8h.html#a0a2f7948d9868f999b43741f0ba82750">Cycle1</a> = 0;
<a name="l00073"></a>00073 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae49c420b00c8440683da20d4078ffedd">Cycle2</a> = 0;
<a name="l00074"></a>00074 <a class="code" href="ds_p_i_d33__definitions_8h.html#a046ceb5294473f63ac9554e05db73dba">CYCLE1_FLAG</a> = 0;
<a name="l00075"></a>00075 <a class="code" href="ds_p_i_d33__definitions_8h.html#af0dcd631114229755ad63f9b08af523e">CYCLE2_FLAG</a> = 0;
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <a class="code" href="ds_p_i_d33__definitions_8h.html#a30e68f049d4b4acf8f80003200ea854e">ORIENTATION_FLAG</a> = 0;
<a name="l00078"></a>00078 <a class="code" href="ds_p_i_d33__definitions_8h.html#a76843a12060f1df6c869de1ac4fba202">MAP_SEND_FLAG</a>=0;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">/*Delay needed to ensure the program memory is not modified before </span>
<a name="l00081"></a>00081 <span class="comment">  verification in programming procedure</span>
<a name="l00082"></a>00082 <span class="comment">        http://forum.microchip.com/tm.aspx?m=326442 */</span>
<a name="l00083"></a>00083 <a class="code" href="ds_p_i_d33_8c.html#aac92344238c1de7c10a17dac75bc2847">DelayN1ms</a>(30);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a14d7d82b2b34b281df3495ee31b1df15">DataEEInit</a>();   <span class="comment">// Initialize flash memory writing [33]</span>
<a name="l00086"></a>00086 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ae89631d9683c00e0d8c4644a5b20012e">dataEEFlags</a>.<a class="code" href="union_d_a_t_a___e_e___f_l_a_g_s.html#a9571d9dd25fa8fc606b149078de63492">val</a> = 0;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 <a class="code" href="com_8h.html#a9c9d42cf8b66102e2b24a182594f6211">BlinkPeriod</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#aa9bf532ae58ec32b8b1cef6fd9af7fb8">NORM_BLINK_PER</a>;   <span class="comment">// LED1 blinking period (ms)</span>
<a name="l00089"></a>00089 <a class="code" href="com_8h.html#abd61f9304bb5c6902bc8b45a818e2f87">BlinkOn</a>     = <a class="code" href="ds_p_i_d33__definitions_8h.html#a29a7a2eb33d76c77b362c97a95f257e6">NORM_BLINK_ON</a>;    <span class="comment">// LED1 on time (ms)</span>
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <a class="code" href="ds_p_i_d33_8c.html#aba1cd658ed9e0945ba5953a07b3fe873">ConstantsRead</a>();        <span class="comment">// get stored constant values from FLASH</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <a class="code" href="ds_p_i_d33_8c.html#a6064a7952a17249d66661e03dbcea753">InitPid1</a>();
<a name="l00094"></a>00094 <a class="code" href="ds_p_i_d33_8c.html#a29e3f7da68ea11f3a29916acc588c7dc">InitPid2</a>();
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <a class="code" href="ds_p_i_d33__definitions_8h.html#a53bb5d1f40e3e633fef41b210da86654">ANGLE_PID_DES</a>=0;
<a name="l00097"></a>00097 <a class="code" href="ds_p_i_d33_8c.html#ac3ed2ee8bf58d974554b636fce82b2e2">InitAnglePid</a>();
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <a class="code" href="ds_p_i_d33__definitions_8h.html#a027d83a57a888a2d8156847c4c494f8e">DIST_PID_DES</a>=0;
<a name="l00100"></a>00100 <a class="code" href="ds_p_i_d33_8c.html#a29b430d2e786c1e8ab27a2f787f4df1c">InitDistPid</a>();
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a> = 0;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4a4f245b2f0fef97b86e2c5ef04377c8">ADC_CALC_FLAG</a> = 0;
<a name="l00106"></a>00106 <a class="code" href="ds_p_i_d33__definitions_8h.html#a11910bdc7598cd4e2c1f73f3911b62f0">IdleSample</a> = 0;
<a name="l00107"></a>00107 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9bab2e9adf859d28f537ddab34e75d67">IdleCount</a> = 0;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 <a class="code" href="ds_p_i_d33__definitions_8h.html#af7ea439aef95c4e0dc878c1411c0eb16">DIST_OK_FLAG</a>  = 1;      <span class="comment">// to kick start the scheduler sequence</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a> = 0;           <span class="comment">// [32]</span>
<a name="l00112"></a>00112         
<a name="l00113"></a>00113 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6ce32b0adb9261aebe9c582fe98403b0">RT_TIMER_FLAG</a> = 0;      <span class="comment">// disable real time timer</span>
<a name="l00114"></a>00114 <a class="code" href="com_8c.html#a7a42b4fb244c559f0c95399a6f20aa42">UsartSetting</a>();         <span class="comment">// initialize Usart1</span>
<a name="l00115"></a>00115 <a class="code" href="com_8c.html#a96b75b3cece3c5866bc4861d707d595e">Usart2Setting</a>();        <span class="comment">// initialize Usart2</span>
<a name="l00116"></a>00116 <a class="code" href="ds_p_i_d33__definitions_8h.html#a3a8afd2657f6103e1174a7a72aa7d8d5">TxContFlag</a> = 0;         
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae1262a92a316b9a38cf32badf9e3025e">ResetCount</a> = 0;
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <a class="code" href="ds_p_i_d33__prototypes_8h.html#a00a828a852cf73810e4b69fe462ab3c8">ISR_Settings</a>(); <span class="comment">// Configures and enables ISRs  </span>
<a name="l00121"></a>00121         
<a name="l00122"></a>00122 <span class="comment">// Send string &#39;Ver&#39;</span>
<a name="l00123"></a>00123 <span class="keywordflow">for</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;26; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00124"></a>00124 {
<a name="l00125"></a>00125         UartTxBuff[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]=<a class="code" href="ds_p_i_d33_8c.html#a7417cfdacc213b0d90c30c0a81097032">Ver</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; 
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 DMA6CNT = 25;                   <span class="comment">// # of DMA requests</span>
<a name="l00128"></a>00128 DMA6CONbits.CHEN  = 1;  <span class="comment">// Re-enable DMA Channel</span>
<a name="l00129"></a>00129 DMA6REQbits.FORCE = 1;  <span class="comment">// Manual mode: Kick-start the first transfer   </span>
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6094c00b22c8cff7ac35581b37385dd0">MAP_BUFF_FLAG</a>=1;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133                         
<a name="l00134"></a>00134 <span class="comment">/*===========================================================================*/</span>
<a name="l00135"></a>00135 <span class="comment">/* Main loop                                                                 */</span>
<a name="l00136"></a>00136 <span class="comment">/*===========================================================================*/</span>
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="keywordflow">while</span> (1)       <span class="comment">// start of idle cycle [25a]</span>
<a name="l00139"></a>00139 {       
<a name="l00140"></a>00140 <span class="comment">/* ----------------------------------------- one character coming from UART1 */</span> 
<a name="l00141"></a>00141 <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#ab232ab3429cca2b282252960c1e2a275">UartRxPtrIn</a> != <a class="code" href="com_8h.html#ab8f2067ed057fadf64efc525dee00527">UartRxPtrOut</a>) <a class="code" href="com_8c.html#a085ba4dd017f305aae6edcebfd3ee3ca">UartRx</a>();      <span class="comment">// [6d]</span>
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="comment">/* ----------------------------------------- one character coming from UART2 */</span> 
<a name="l00144"></a>00144 <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#ad4010f20f46f633b2d9a255c5b18cc3e">Uart2RxPtrIn</a> != <a class="code" href="com_8h.html#a6472c72e777b7b75e940627004bdc3a2">Uart2RxPtrOut</a>) <a class="code" href="com_8c.html#ad1ff795b69a6c71758e31c58a78bc4a8">Uart2Rx</a>();   <span class="comment">// [6zd]</span>
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">/* ------------------------ a command is coming from serial interface 1 or 2 */</span>  
<a name="l00147"></a>00147 <span class="keywordflow">if</span> ((<a class="code" href="com_8h.html#a94d09f88968f6f1079de93751301ebb3">UartRxStatus</a> == 99) || (<a class="code" href="com_8h.html#acfa6242d276db29d9b77519b44bf85fd">Uart2RxStatus</a> == 99)) <a class="code" href="ds_p_i_d33_8c.html#aeb1ea26e1834939d00391bc98c6eef19">Parser</a>();
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="comment">/* ------------------------------------- PID and speed calculation every 1ms */</span> 
<a name="l00150"></a>00150 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a311ccc470172ffb6eaedb52ef383955a">PID1_CALC_FLAG</a>)     <a class="code" href="ds_p_i_d33_8c.html#a0d2658e37f8f1a6d3466c74e7244a7f8">Pid1</a>();
<a name="l00151"></a>00151 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#ad14ab2821b8f27e9d0ba9d4d79d3e4e4">PID2_CALC_FLAG</a>)     <a class="code" href="ds_p_i_d33_8c.html#a3660e62a3b7d7a9b39a21d35e947b03f">Pid2</a>();
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">/* ----------------------------------------- DeadReckonig field mapping [22] */</span>  
<a name="l00154"></a>00154 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a046ceb5294473f63ac9554e05db73dba">CYCLE1_FLAG</a>) <a class="code" href="ds_p_i_d33_8c.html#a6b240a37d541c2c2b128ff3f74a21a7f">DeadReckoning</a>();
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="comment">/* ---------------------------------------------------- Orientation PID [23] */</span>  
<a name="l00157"></a>00157 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a30e68f049d4b4acf8f80003200ea854e">ORIENTATION_FLAG</a>) <a class="code" href="ds_p_i_d33_8c.html#abf3685fb9a5c5a777ac2d0712f8e501a">Orientation</a>();
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/* ----------------------------------------------------------- Distance [24] */</span> 
<a name="l00160"></a>00160 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#af0dcd631114229755ad63f9b08af523e">CYCLE2_FLAG</a>) <a class="code" href="ds_p_i_d33_8c.html#a940b55006b1caa885449d669bcd094bf">Navigation</a>();
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">/*-- continuos parameters transmission without request (just for debug) [31] */</span>         
<a name="l00163"></a>00163 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a3a8afd2657f6103e1174a7a72aa7d8d5">TxContFlag</a> &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a06af0346de02b4af7df612af6e131878">UartContTxTimer</a>&lt;=0) <a class="code" href="ds_p_i_d33_8c.html#ac7fea72c4e68b14bb464adc12fb94908">TxCont</a>(); 
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="comment">/*----------------------------------------- ADC value average calculus  [2a] */</span>         
<a name="l00166"></a>00166 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a4a4f245b2f0fef97b86e2c5ef04377c8">ADC_CALC_FLAG</a>) <a class="code" href="ds_p_i_d33_8c.html#a63ff5d10ae06640d7684853793960861">AdcCalc</a>();
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">/*---------------------------------------------------------- Real time timer */</span>         
<a name="l00169"></a>00169 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a6ce32b0adb9261aebe9c582fe98403b0">RT_TIMER_FLAG</a>) 
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a9143ee7b83c3016f37b301761c2d0ae6">RtTimer</a> &lt;= 0) 
<a name="l00172"></a>00172         {
<a name="l00173"></a>00173                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a373d3f761ff9c5fff2a44aaec95bf73c">TIMER_OK_FLAG</a> = 1;
<a name="l00174"></a>00174                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6ce32b0adb9261aebe9c582fe98403b0">RT_TIMER_FLAG</a> = 0;
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="comment">/*-------------------------------------------------- Actions scheduler  [32] */</span>
<a name="l00179"></a>00179 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a>)     <span class="comment">// [32a]        </span>
<a name="l00180"></a>00180 {       
<a name="l00181"></a>00181         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aca83bbf78c4f9caa63078080a8ed5a80">ANGLE_OK_FLAG</a> || <a class="code" href="ds_p_i_d33__definitions_8h.html#af7ea439aef95c4e0dc878c1411c0eb16">DIST_OK_FLAG</a> || <a class="code" href="ds_p_i_d33__definitions_8h.html#a373d3f761ff9c5fff2a44aaec95bf73c">TIMER_OK_FLAG</a>) <a class="code" href="ds_p_i_d33_8c.html#ae9001072ff3f6278e5bea58c38d07590">Scheduler</a>();
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="comment">/*-------------------------------------------------- To send map to console */</span>
<a name="l00185"></a>00185 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a76843a12060f1df6c869de1ac4fba202">MAP_SEND_FLAG</a>)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]==0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]==0)
<a name="l00188"></a>00188         {
<a name="l00189"></a>00189                 <a class="code" href="ds_p_i_d33_8c.html#a4d5573d6d0725554f705c33bf41924c6">SendMap</a>();
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">/*--------------------------------------------------- Heartbeat led linking */</span>
<a name="l00194"></a>00194 <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> == <a class="code" href="com_8h.html#abd61f9304bb5c6902bc8b45a818e2f87">BlinkOn</a>)
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196         LED1 = 0;
<a name="l00197"></a>00197         LED2 = 1;
<a name="l00198"></a>00198         <a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> ++;       
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> &gt;= <a class="code" href="com_8h.html#a9c9d42cf8b66102e2b24a182594f6211">BlinkPeriod</a>)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203         LED1 = 1;
<a name="l00204"></a>00204         LED2 = 0;
<a name="l00205"></a>00205         <a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> = 0;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">/*------------------------------------------- Idle percentage calculus  [25] */</span>         
<a name="l00209"></a>00209 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9bab2e9adf859d28f537ddab34e75d67">IdleCount</a> ++;   <span class="comment">// [25]</span>
<a name="l00210"></a>00210 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a11910bdc7598cd4e2c1f73f3911b62f0">IdleSample</a> &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#ab36bb70e131c783a747325e588bf0a34">IDLE_CYCLE</a>)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212         <a class="code" href="ds_p_i_d33__definitions_8h.html#a65ea6158de06fbcef0bbac3b2dd0971f">IdlePerc</a>=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a9bab2e9adf859d28f537ddab34e75d67">IdleCount</a> * <a class="code" href="ds_p_i_d33__definitions_8h.html#aecca912ee2f5ca10c0156899a2cc9a58">IDLE_TIME_PERIOD</a>) / (long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a7e21a157f4758922399b6dc487566bed">IDLE_SAMPLE_TIME</a>);
<a name="l00213"></a>00213         <a class="code" href="ds_p_i_d33__definitions_8h.html#a9bab2e9adf859d28f537ddab34e75d67">IdleCount</a> = 0;
<a name="l00214"></a>00214         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11910bdc7598cd4e2c1f73f3911b62f0">IdleSample</a> = 0;
<a name="l00215"></a>00215 }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 Nop();  <span class="comment">// end of idle cycle [25a]</span>
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 }<span class="comment">/*....Main loop*/</span>
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 }<span class="comment">/*.....................................................................Main */</span>
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="comment">/*===========================================================================*/</span>
<a name="l00225"></a>00225 <span class="comment">/* Functions                                                                 */</span>
<a name="l00226"></a>00226 <span class="comment">/*===========================================================================*/</span>
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a4d5573d6d0725554f705c33bf41924c6">00228</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a4d5573d6d0725554f705c33bf41924c6">SendMap</a>(<span class="keywordtype">void</span>)
<a name="l00229"></a>00229 {
<a name="l00233"></a>00233         <span class="keywordtype">int</span> TmpMap;
<a name="l00234"></a>00234         
<a name="l00235"></a>00235         <span class="keywordflow">if</span>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a6094c00b22c8cff7ac35581b37385dd0">MAP_BUFF_FLAG</a>)
<a name="l00236"></a>00236         {<span class="comment">// DMA have sent the whole buffer</span>
<a name="l00237"></a>00237                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6094c00b22c8cff7ac35581b37385dd0">MAP_BUFF_FLAG</a>=0; <span class="comment">// will be set again by DMA ISR</span>
<a name="l00238"></a>00238         
<a name="l00239"></a>00239                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[0][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a2c9e0144fde735af9e35912158284217">MapSendIndx</a>;        
<a name="l00240"></a>00240                 <span class="comment">// starting points for X and Y coordinates</span>
<a name="l00241"></a>00241                 TmpMap = <a class="code" href="ds_p_i_d33__definitions_8h.html#a82f0404c8cb84ed05093ab545cfaeafa">Xshift</a>;
<a name="l00242"></a>00242                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=TmpMap&gt;&gt;8; 
<a name="l00243"></a>00243                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[2][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=TmpMap;
<a name="l00244"></a>00244                 TmpMap = <a class="code" href="ds_p_i_d33__definitions_8h.html#a73b1bd13ed49e256cbfd81d5fcbbb763">Yshift</a>;
<a name="l00245"></a>00245                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[3][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=TmpMap&gt;&gt;8; 
<a name="l00246"></a>00246                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[4][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=TmpMap;
<a name="l00247"></a>00247                 
<a name="l00248"></a>00248                 <span class="keywordflow">for</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;<a class="code" href="ds_p_i_d33__definitions_8h.html#aa3357dacd5fdcf74fdebec08ddd03d5c">X_SIZE</a>; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00249"></a>00249                 {<span class="comment">// put in buffer both nib0 and nib1 for that X coordinate</span>
<a name="l00250"></a>00250                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>+5][<a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#adb43804a231f49b4dbd9fe480d4083ab">MapXY</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][<a class="code" href="ds_p_i_d33__definitions_8h.html#a2c9e0144fde735af9e35912158284217">MapSendIndx</a>].<a class="code" href="union_packed_bit.html#a9e50ea0e570fefec1e08acd8859e1d7f">UC</a>;
<a name="l00251"></a>00251                 }
<a name="l00252"></a>00252                         
<a name="l00253"></a>00253                 <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;$&#39;</span>, X_SIZE+6, <a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a>); 
<a name="l00254"></a>00254                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a76843a12060f1df6c869de1ac4fba202">MAP_SEND_FLAG</a>=0;
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 }
<a name="l00257"></a>00257 
<a name="l00258"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a8b82cc7f0f1e3ecdba52598d406e5932">00258</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>(<span class="keywordtype">float</span> Angle)
<a name="l00259"></a>00259 {
<a name="l00264"></a>00264         <a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a> = Angle;
<a name="l00265"></a>00265         <a class="code" href="ds_p_i_d33__definitions_8h.html#a068c444982c70985882428ce63952cc2">ThetaDesRef</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>;
<a name="l00266"></a>00266         PIDInit(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>); 
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="ds_p_i_d33_8c.html#aeb1ea26e1834939d00391bc98c6eef19">00269</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#aeb1ea26e1834939d00391bc98c6eef19">Parser</a> (<span class="keywordtype">void</span>)
<a name="l00270"></a>00270 {
<a name="l00275"></a>00275         <span class="keywordtype">int</span> ParserCount;                <span class="comment">// parser index</span>
<a name="l00276"></a>00276         <span class="keywordtype">int</span> C1;                                 <span class="comment">// generic counter</span>
<a name="l00277"></a>00277         <span class="keywordtype">int</span> C2;
<a name="l00278"></a>00278         <span class="keywordtype">int</span> C3;
<a name="l00279"></a>00279         <span class="keywordtype">int</span> TmpChk;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> Ktmp;              <span class="comment">// temp for PID coefficients</span>
<a name="l00282"></a>00282         <span class="keywordtype">int</span> Ptmp;                               <span class="comment">// temp for position values</span>
<a name="l00283"></a>00283         <span class="keywordtype">int</span> CurrTmp;                    <span class="comment">// temp for motors current value</span>
<a name="l00284"></a>00284         <span class="keywordtype">int</span> Alpha;                              <span class="comment">// rotation angle in degrees</span>
<a name="l00285"></a>00285         <span class="keywordtype">long</span> Tmp1Long;                  <span class="comment">// temp to combine long </span>
<a name="l00286"></a>00286         <span class="keywordtype">long</span> Tmp2Long;
<a name="l00287"></a>00287         
<a name="l00288"></a>00288         <span class="keyword">const</span> <span class="keywordtype">float</span> AngleS = 0.785398163;  <span class="comment">// 45° angle for object on side</span>
<a name="l00289"></a>00289         
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#a94d09f88968f6f1079de93751301ebb3">UartRxStatus</a> == 99) <span class="comment">// the command come from UART1</span>
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292                 <a class="code" href="com_8h.html#ac8da13b9722d30b210b7d6575958fe9c">TmpPtr</a> = <a class="code" href="com_8h.html#a88b1634dbe2fb4561352ae37c11f1dcc">UartRxPtrData</a>; <span class="comment">// last data of header</span>
<a name="l00293"></a>00293                 <a class="code" href="com_8h.html#a94d09f88968f6f1079de93751301ebb3">UartRxStatus</a> = 0;
<a name="l00294"></a>00294                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>=0;
<a name="l00295"></a>00295         }
<a name="l00296"></a>00296         <span class="keywordflow">else</span>                                    <span class="comment">// the command come from UART2</span>
<a name="l00297"></a>00297         {
<a name="l00298"></a>00298                 <a class="code" href="com_8h.html#afc91beca3bffe3e5469c343973e1485a">TmpPtr2</a> = <a class="code" href="com_8h.html#afd3dcb6e36ecfc515970d31d3e1fa5ea">Uart2RxPtrData</a>; <span class="comment">// last data of header</span>
<a name="l00299"></a>00299                 <a class="code" href="com_8h.html#acfa6242d276db29d9b77519b44bf85fd">Uart2RxStatus</a> = 0;
<a name="l00300"></a>00300                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>=1;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         
<a name="l00304"></a>00304         <span class="keywordflow">if</span> (<a class="code" href="com_8h.html#a7d58d9c69ba806dab057fb42db8d89e4">UartRxCmd</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#ade451905b5b339ed4d5c75e683a668af">ResetPort</a>] != <span class="charliteral">&#39;*&#39;</span>)        <span class="comment">// [28]</span>
<a name="l00305"></a>00305         {
<a name="l00306"></a>00306                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae1262a92a316b9a38cf32badf9e3025e">ResetCount</a> = 0;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308         
<a name="l00309"></a>00309         <span class="keywordflow">switch</span> (<a class="code" href="com_8h.html#a7d58d9c69ba806dab057fb42db8d89e4">UartRxCmd</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>])
<a name="l00310"></a>00310         {
<a name="l00311"></a>00311 <span class="comment">// --- Navigation values read                   </span>
<a name="l00312"></a>00312                 <span class="keywordflow">case</span> <span class="charliteral">&#39;A&#39;</span>:               <span class="comment">// all parameters request (mean)</span>
<a name="l00313"></a>00313                         <span class="comment">// VelMes = Int -&gt; 2 byte (mm/s)</span>
<a name="l00314"></a>00314 <span class="comment">//                      Ptmp = (VelMes[R] + VelMes[L]) &gt;&gt; 1;    // average speed</span>
<a name="l00315"></a>00315                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] * 1000)&gt;&gt;15;            <span class="comment">// VelR</span>
<a name="l00316"></a>00316                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] * 1000)&gt;&gt;15;            <span class="comment">// VelL</span>
<a name="l00317"></a>00317                         Ptmp = (<a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] + <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]) &gt;&gt; 1;    <span class="comment">// average speed</span>
<a name="l00318"></a>00318                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00319"></a>00319                         {
<a name="l00320"></a>00320                                 Ptmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>;
<a name="l00321"></a>00321                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=abs(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>);
<a name="l00322"></a>00322                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=abs(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>);
<a name="l00323"></a>00323                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>;
<a name="l00324"></a>00324                         }
<a name="l00325"></a>00325                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[0][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp&gt;&gt;8; 
<a name="l00326"></a>00326                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp;
<a name="l00327"></a>00327                         <span class="comment">// Curr = int -&gt; 2byte (mA)</span>
<a name="l00328"></a>00328                         CurrTmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]+<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];              <span class="comment">// total current</span>
<a name="l00329"></a>00329                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[2][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=CurrTmp&gt;&gt;8;
<a name="l00330"></a>00330                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[3][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=CurrTmp;
<a name="l00331"></a>00331                         <span class="comment">// PosXmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l00332"></a>00332                         Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>);                              <span class="comment">// PosX</span>
<a name="l00333"></a>00333                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[4][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp&gt;&gt;8; 
<a name="l00334"></a>00334                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[5][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp;
<a name="l00335"></a>00335                         <span class="comment">// PosYmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l00336"></a>00336                         Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>);                              <span class="comment">// PosY</span>
<a name="l00337"></a>00337                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[6][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp&gt;&gt;8; 
<a name="l00338"></a>00338                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[7][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp;
<a name="l00339"></a>00339                         <span class="comment">// ThetaMes rounded in a Int -&gt; 2 byte (degrees)</span>
<a name="l00340"></a>00340                         Ptmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> * <a class="code" href="ds_p_i_d33__definitions_8h.html#ac5a945020d3528355cda82d383676736">RAD2DEG</a>;                              <span class="comment">// Theta</span>
<a name="l00341"></a>00341                         Alpha = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(Ptmp);
<a name="l00342"></a>00342                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[8][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Alpha&gt;&gt;8; 
<a name="l00343"></a>00343                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[9][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Alpha;
<a name="l00344"></a>00344                         <span class="comment">// angle reading from sensors board compass (deg * 10)</span>
<a name="l00345"></a>00345                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[10][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a0ca2aa233ccefdc83dd783af0d096100">AngleCmp</a>&gt;&gt;8; 
<a name="l00346"></a>00346                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[11][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a0ca2aa233ccefdc83dd783af0d096100">AngleCmp</a>;
<a name="l00347"></a>00347                         <span class="comment">// idle time in %</span>
<a name="l00348"></a>00348                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[12][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a65ea6158de06fbcef0bbac3b2dd0971f">IdlePerc</a>;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;A&#39;</span>,13, Port);  
<a name="l00351"></a>00351                 <span class="keywordflow">break</span>;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353                 <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:               <span class="comment">// all parameters request (details)</span>
<a name="l00354"></a>00354                         <span class="comment">// VelInt = Int -&gt; 2 byte</span>
<a name="l00355"></a>00355                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[R] * 1000)&gt;&gt;15;            <span class="comment">// VelL</span>
<a name="l00356"></a>00356                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[L] * 1000)&gt;&gt;15;            <span class="comment">// VelL</span>
<a name="l00357"></a>00357                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00358"></a>00358                         {
<a name="l00359"></a>00359                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]= <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>;
<a name="l00360"></a>00360                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]= <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>;
<a name="l00361"></a>00361                                 ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=abs(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>);
<a name="l00362"></a>00362                                 ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=abs(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a>);
<a name="l00363"></a>00363                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>;
<a name="l00364"></a>00364                         }
<a name="l00365"></a>00365                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[0][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8; 
<a name="l00366"></a>00366                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l00367"></a>00367                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[2][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8; 
<a name="l00368"></a>00368                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[3][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l00369"></a>00369                         <span class="comment">// ADCValue = int -&gt; 2byte</span>
<a name="l00370"></a>00370                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[4][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8;    <span class="comment">// CurrR</span>
<a name="l00371"></a>00371                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[5][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l00372"></a>00372                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[6][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8;    <span class="comment">// CurrL</span>
<a name="l00373"></a>00373                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[7][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l00374"></a>00374                         <span class="comment">// Space = int -&gt; 2byte</span>
<a name="l00375"></a>00375                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[8][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8;              <span class="comment">// SpTickR</span>
<a name="l00376"></a>00376                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[9][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l00377"></a>00377                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 0; <span class="comment">// [19]</span>
<a name="l00378"></a>00378                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[10][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8;             <span class="comment">// SpTickL</span>
<a name="l00379"></a>00379                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[11][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l00380"></a>00380                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 0; <span class="comment">// [19]</span>
<a name="l00381"></a>00381                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;a&#39;</span>,12, Port);  
<a name="l00382"></a>00382                 <span class="keywordflow">break</span>;
<a name="l00383"></a>00383                 
<a name="l00384"></a>00384                 
<a name="l00385"></a>00385 <span class="comment">//--- Navigation parameters settings</span>
<a name="l00386"></a>00386                 <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:               <span class="comment">// setting reference coord. X, Y computing distance</span>
<a name="l00387"></a>00387                                                 <span class="comment">// [24] Mode C</span>
<a name="l00388"></a>00388                         <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00389"></a>00389                         Ptmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00390"></a>00390                                    (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]); <span class="comment">// Dist</span>
<a name="l00391"></a>00391                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a> + (Ptmp * sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>));
<a name="l00392"></a>00392                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a1baf79cb6ce6068c5da1478564220ef8">PosYdes</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a> + (Ptmp * cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>));
<a name="l00393"></a>00393                         <a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a> = 1;   <span class="comment">// enable distance computing [24a]</span>
<a name="l00394"></a>00394                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00395"></a>00395                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00396"></a>00396                         {
<a name="l00397"></a>00397                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a>;
<a name="l00398"></a>00398                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a1baf79cb6ce6068c5da1478564220ef8">PosYdes</a>;
<a name="l00399"></a>00399                         }
<a name="l00400"></a>00400                 <span class="keywordflow">break</span>;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                 <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:               <span class="comment">// setting ref. orientation angle in degrees (absolute)</span>
<a name="l00403"></a>00403                                                 <span class="comment">// [24] Mode A</span>
<a name="l00404"></a>00404                         <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00405"></a>00405                         Ptmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00406"></a>00406                                    (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00407"></a>00407                         <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>(Ptmp * <a class="code" href="ds_p_i_d33__definitions_8h.html#af7e8592d0a634bd3642e9fd508ea8022">DEG2RAD</a>);
<a name="l00408"></a>00408                         DIST_ENABLE_FLAG = 0;   <span class="comment">// disable distance computing [24a]</span>
<a name="l00409"></a>00409                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;                    <span class="comment">// [24d]</span>
<a name="l00410"></a>00410                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00411"></a>00411                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00412"></a>00412                         {
<a name="l00413"></a>00413                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>;
<a name="l00414"></a>00414                         }
<a name="l00415"></a>00415                 <span class="keywordflow">break</span>;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417                 <span class="keywordflow">case</span> <span class="charliteral">&#39;o&#39;</span>:               <span class="comment">// setting reference orientation angle in degrees</span>
<a name="l00418"></a>00418                                                 <span class="comment">// as a delta of the current orientation (relative) </span>
<a name="l00419"></a>00419                                                 <span class="comment">// [24] Mode A</span>
<a name="l00420"></a>00420                         <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00421"></a>00421                         Ptmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00422"></a>00422                                    (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00423"></a>00423                         <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>( <a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a> + (Ptmp * DEG2RAD));
<a name="l00424"></a>00424                         DIST_ENABLE_FLAG = 0;   <span class="comment">// disable distance computing [24a]</span>
<a name="l00425"></a>00425                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;                    <span class="comment">// [24d]</span>
<a name="l00426"></a>00426                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00427"></a>00427                 <span class="keywordflow">break</span>;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429                 <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>:               <span class="comment">// setting reference coord. X, Y in mm</span>
<a name="l00430"></a>00430                                                 <span class="comment">// [24] Mode B</span>
<a name="l00431"></a>00431                         <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00432"></a>00432                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a> = (float)((<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][Port] &lt;&lt; 8) + 
<a name="l00433"></a>00433                                                         (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]));
<a name="l00434"></a>00434                         PosYdes = (float)((<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00435"></a>00435                                                         (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]));
<a name="l00436"></a>00436                         DIST_ENABLE_FLAG = 1;   <span class="comment">// enable distance computing [24a]</span>
<a name="l00437"></a>00437                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00438"></a>00438                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00439"></a>00439                         {
<a name="l00440"></a>00440                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a>;
<a name="l00441"></a>00441                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a1baf79cb6ce6068c5da1478564220ef8">PosYdes</a>;
<a name="l00442"></a>00442                         }
<a name="l00443"></a>00443                 <span class="keywordflow">break</span>;
<a name="l00444"></a>00444                 
<a name="l00445"></a>00445                 <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:               <span class="comment">// setting reference speed (as mm/s) </span>
<a name="l00446"></a>00446                         <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00447"></a>00447                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00448"></a>00448                                           (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00449"></a>00449                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> &gt;  999) <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  999; <span class="comment">// range check</span>
<a name="l00450"></a>00450                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> &lt; -999) <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = -999; <span class="comment">// range check</span>
<a name="l00451"></a>00451                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00452"></a>00452                 <span class="keywordflow">break</span>;
<a name="l00453"></a>00453                 
<a name="l00454"></a>00454                 <span class="keywordflow">case</span> <span class="charliteral">&#39;H&#39;</span>:       <span class="comment">// immediate Halt without decelerating ramp.In this way it </span>
<a name="l00455"></a>00455                                         <span class="comment">// uses the brake effect of H bridge in LAP mode</span>
<a name="l00456"></a>00456                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0; 
<a name="l00457"></a>00457                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00458"></a>00458                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a>) <span class="comment">//[30]</span>
<a name="l00459"></a>00459                         {
<a name="l00460"></a>00460                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ab9ea4576e61721fa68c8168e015b47e7">VelMes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=0;
<a name="l00461"></a>00461                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ab9ea4576e61721fa68c8168e015b47e7">VelMes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=0;
<a name="l00462"></a>00462                                 ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=0;
<a name="l00463"></a>00463                                 ADCValue[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=0;
<a name="l00464"></a>00464                         }
<a name="l00465"></a>00465                 <span class="keywordflow">break</span>;
<a name="l00466"></a>00466                 
<a name="l00467"></a>00467                 
<a name="l00468"></a>00468 <span class="comment">//--- Constant parameters setting               </span>
<a name="l00469"></a>00469                 <span class="keywordflow">case</span> <span class="charliteral">&#39;J&#39;</span>:               <span class="comment">// setting PID coefficients for DistPid</span>
<a name="l00470"></a>00470                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00471"></a>00471                         <span class="keywordflow">for</span> (ParserCount=0; ParserCount &lt; 5; ParserCount+=2)
<a name="l00472"></a>00472                         {
<a name="l00473"></a>00473                                 <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00474"></a>00474                                 Ktmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00475"></a>00475                                            (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00476"></a>00476                                 <span class="keywordflow">if</span> (Ktmp &gt; 9999) Ktmp = 9999; <span class="comment">// range check</span>
<a name="l00477"></a>00477                                 TmpChk+=Ktmp;
<a name="l00478"></a>00478                                 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Ktmp,<a class="code" href="ds_p_i_d33__definitions_8h.html#a537065f445575f12000147ac6c8d8584">EE_DIST_KP</a>+ParserCount/2);                     
<a name="l00479"></a>00479                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a67cdd7dca12b7f9968a16d3f6b192005">DistKCoeffs</a>[ParserCount/2] = Q15((<span class="keywordtype">float</span>)(Ktmp)/10000);
<a name="l00480"></a>00480                         }
<a name="l00481"></a>00481                         <a class="code" href="ds_p_i_d33_8c.html#a29b430d2e786c1e8ab27a2f787f4df1c">InitDistPid</a>();
<a name="l00482"></a>00482                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#a1387301e05aad292458f92d900c917b5">EE_CHK_DIST</a>);
<a name="l00483"></a>00483                 <span class="keywordflow">break</span>;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485                 <span class="keywordflow">case</span> <span class="charliteral">&#39;K&#39;</span>:               <span class="comment">// setting PID coefficients for Speed PIDs</span>
<a name="l00486"></a>00486                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00487"></a>00487                         <span class="keywordflow">for</span> (ParserCount=0; ParserCount &lt; 5; ParserCount+=2)
<a name="l00488"></a>00488                         {
<a name="l00489"></a>00489                                 <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00490"></a>00490                                 Ktmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00491"></a>00491                                            (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00492"></a>00492                                 <span class="keywordflow">if</span> (Ktmp &gt; 9999) Ktmp = 9999; <span class="comment">// range check</span>
<a name="l00493"></a>00493                                 TmpChk+=Ktmp;
<a name="l00494"></a>00494                                 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Ktmp,<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c55ea3d3f295e10bfa3cc68f46b725b">EE_KP1</a>+ParserCount/2);
<a name="l00495"></a>00495                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a843702f7b5a493eeabe40eb08bd2ff4a">kCoeffs1</a>[ParserCount/2] = Q15((<span class="keywordtype">float</span>)(Ktmp)/10000);
<a name="l00496"></a>00496                         }
<a name="l00497"></a>00497                         <a class="code" href="ds_p_i_d33_8c.html#a6064a7952a17249d66661e03dbcea753">InitPid1</a>();
<a name="l00498"></a>00498                         
<a name="l00499"></a>00499                         <span class="keywordflow">for</span> (ParserCount=0; ParserCount &lt; 5; ParserCount+=2)
<a name="l00500"></a>00500                         {
<a name="l00501"></a>00501                                 <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00502"></a>00502                                 Ktmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00503"></a>00503                                            (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00504"></a>00504                                 <span class="keywordflow">if</span> (Ktmp &gt; 9999) Ktmp = 9999; <span class="comment">// range check</span>
<a name="l00505"></a>00505                                 TmpChk+=Ktmp;
<a name="l00506"></a>00506                                 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Ktmp,<a class="code" href="ds_p_i_d33__definitions_8h.html#a44be0fb106e81ceb006673c95286b31e">EE_KP2</a>+ParserCount/2);
<a name="l00507"></a>00507                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ad8328ab5c71bdc690c9c654e3878fd32">kCoeffs2</a>[ParserCount/2] = Q15((<span class="keywordtype">float</span>)(Ktmp)/10000);
<a name="l00508"></a>00508                         }
<a name="l00509"></a>00509                         <a class="code" href="ds_p_i_d33_8c.html#a29e3f7da68ea11f3a29916acc588c7dc">InitPid2</a>();
<a name="l00510"></a>00510                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#af73d4c0cec016550ce248ada634f65c9">EE_CHK_SPEED</a>);
<a name="l00511"></a>00511                 <span class="keywordflow">break</span>;
<a name="l00512"></a>00512                 
<a name="l00513"></a>00513                 <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>:               <span class="comment">// settings PID coefficients for AnglePid</span>
<a name="l00514"></a>00514                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00515"></a>00515                         <span class="keywordflow">for</span> (ParserCount=0; ParserCount &lt; 5; ParserCount+=2)
<a name="l00516"></a>00516                         {
<a name="l00517"></a>00517                                 <span class="comment">// High Byte * 256 + Low Byte</span>
<a name="l00518"></a>00518                                 Ktmp = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00519"></a>00519                                            (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00520"></a>00520                                 <span class="keywordflow">if</span> (Ktmp &gt; 9999) Ktmp = 9999; <span class="comment">// range check</span>
<a name="l00521"></a>00521                                 TmpChk+=Ktmp;
<a name="l00522"></a>00522                                 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Ktmp,<a class="code" href="ds_p_i_d33__definitions_8h.html#a9b9f409a9bc869aafbde19885b8326a5">EE_ANGLE_KP</a>+ParserCount/2);
<a name="l00523"></a>00523                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a797c49f2ced858a984c41d3e8fd14e72">AngleKCoeffs</a>[ParserCount/2] = Q15((<span class="keywordtype">float</span>)(Ktmp)/10000);
<a name="l00524"></a>00524                         }
<a name="l00525"></a>00525                         <a class="code" href="ds_p_i_d33_8c.html#ac3ed2ee8bf58d974554b636fce82b2e2">InitAnglePid</a>();
<a name="l00526"></a>00526                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#afdd825ccedea81546f1c4deeb04439bd">EE_CHK_ANGLE</a>);
<a name="l00527"></a>00527                 <span class="keywordflow">break</span>;
<a name="l00528"></a>00528                 
<a name="l00529"></a>00529                 <span class="keywordflow">case</span> <span class="charliteral">&#39;L&#39;</span>:               <span class="comment">// Kvel         </span>
<a name="l00530"></a>00530                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00531"></a>00531                         Tmp1Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00532"></a>00532                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00533"></a>00533                         TmpChk+=Tmp1Long;
<a name="l00534"></a>00534                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp1Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a30eb60bbf768c306838dc3c61bc20b6a">EE_KVEL1_H</a>);
<a name="l00535"></a>00535                         Tmp2Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00536"></a>00536                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00537"></a>00537                         TmpChk+=Tmp2Long;
<a name="l00538"></a>00538                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp2Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a24c62e95b3d61ec5610cefa6c6b9c9bf">EE_KVEL1_L</a>);
<a name="l00539"></a>00539                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = (Tmp1Long &lt;&lt; 16) + Tmp2Long;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541                         Tmp1Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00542"></a>00542                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00543"></a>00543                         TmpChk+=Tmp1Long;
<a name="l00544"></a>00544                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp1Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#aa6db32bf36392fea216d6333f582b8b7">EE_KVEL2_H</a>);
<a name="l00545"></a>00545                         Tmp2Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00546"></a>00546                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00547"></a>00547                         TmpChk+=Tmp2Long;
<a name="l00548"></a>00548                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp2Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a5a0c7445850a7855d6a3ddfac4974d33">EE_KVEL2_L</a>);
<a name="l00549"></a>00549                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = (Tmp1Long &lt;&lt; 16) + Tmp2Long;
<a name="l00550"></a>00550                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#abfff75987b4efe2306c6d7dd3db42e91">EE_CHK_KVEL</a>);
<a name="l00551"></a>00551                 <span class="keywordflow">break</span>;
<a name="l00552"></a>00552                 
<a name="l00553"></a>00553                 <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>:               <span class="comment">// Mechanical costants: Axle size, KspR, KspL [29]</span>
<a name="l00554"></a>00554                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00555"></a>00555                         Tmp1Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00556"></a>00556                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00557"></a>00557                         TmpChk+=Tmp1Long;
<a name="l00558"></a>00558                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp1Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a7dde2efdd67544d00f8b30c3f755b779">EE_AXLE_H</a>);
<a name="l00559"></a>00559                         Tmp2Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00560"></a>00560                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00561"></a>00561                         TmpChk+=Tmp2Long;
<a name="l00562"></a>00562                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp2Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a7df2d5424fb36a3fc7e585a23b830825">EE_AXLE_L</a>);
<a name="l00563"></a>00563                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a> =    (float)((Tmp1Long &lt;&lt; 16) + Tmp2Long)/(<span class="keywordtype">float</span>)(10000);
<a name="l00564"></a>00564                         
<a name="l00565"></a>00565                         
<a name="l00566"></a>00566                         Tmp1Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00567"></a>00567                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00568"></a>00568                         TmpChk+=Tmp1Long;
<a name="l00569"></a>00569                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp1Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a17f833fda13a712b1a1f519656878bdf">EE_KSP1_H</a>);
<a name="l00570"></a>00570                         Tmp2Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00571"></a>00571                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00572"></a>00572                         TmpChk+=Tmp2Long;
<a name="l00573"></a>00573                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp2Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a76b24bd1c5b96fff7a8dc81a8757e47b">EE_KSP1_L</a>);
<a name="l00574"></a>00574                         <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[0] =  (float)((Tmp1Long &lt;&lt; 16) + Tmp2Long)/(<span class="keywordtype">float</span>)(1000000000);
<a name="l00575"></a>00575 
<a name="l00576"></a>00576                         Tmp1Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00577"></a>00577                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00578"></a>00578                         TmpChk+=Tmp1Long;
<a name="l00579"></a>00579                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp1Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#abc091fd5685b28694aaaa20b337e7c08">EE_KSP2_H</a>);
<a name="l00580"></a>00580                         Tmp2Long = ((long)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) +
<a name="l00581"></a>00581                                            ((<span class="keywordtype">long</span>)<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00582"></a>00582                         TmpChk+=Tmp2Long;
<a name="l00583"></a>00583                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(Tmp2Long,<a class="code" href="ds_p_i_d33__definitions_8h.html#a587522af961f06270208e2bb30532856">EE_KSP2_L</a>);
<a name="l00584"></a>00584                         <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[1] =  (float)((Tmp1Long &lt;&lt; 16) + Tmp2Long)/(<span class="keywordtype">float</span>)(1000000000);
<a name="l00585"></a>00585                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#a30de59f6d3ad201cf79752d12c60158d">EE_CHK_MECH</a>);
<a name="l00586"></a>00586                 <span class="keywordflow">break</span>;
<a name="l00587"></a>00587                 
<a name="l00588"></a>00588                 <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:               <span class="comment">// Scheduler parameters setting [32]    </span>
<a name="l00589"></a>00589                         TmpChk=0;       <span class="comment">// checksum to control permanent storage</span>
<a name="l00590"></a>00590                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0;
<a name="l00591"></a>00591                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00592"></a>00592                         C3 = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7475c25cfc5dcc77e47927d4ab6bb08b">EE_SCHED</a>;  <span class="comment">// starting address for permanent storage</span>
<a name="l00593"></a>00593                         <span class="keywordflow">for</span> (C1=0; C1&lt;16; C1++)
<a name="l00594"></a>00594                         {
<a name="l00595"></a>00595                                 <span class="keywordflow">for</span> (C2=0; C2&lt;4; C2++)
<a name="l00596"></a>00596                                 {
<a name="l00597"></a>00597                                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[C1][C2]=(<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00598"></a>00598                                                                                 (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00599"></a>00599                                         TmpChk+=<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[C1][C2];
<a name="l00600"></a>00600                                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[C1][C2],C3);
<a name="l00601"></a>00601                                         C3 ++;
<a name="l00602"></a>00602                                 }
<a name="l00603"></a>00603                         }
<a name="l00604"></a>00604                         <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(TmpChk,<a class="code" href="ds_p_i_d33__definitions_8h.html#a0d4a4184349b3adbf8ce777a171cf3f0">EE_CHK_SCHED</a>);
<a name="l00605"></a>00605                 <span class="keywordflow">break</span>;
<a name="l00606"></a>00606                 
<a name="l00607"></a>00607 <span class="comment">//--- Service</span>
<a name="l00608"></a>00608                 <span class="keywordflow">case</span> <span class="charliteral">&#39;*&#39;</span>:               <span class="comment">// Board reset [28]</span>
<a name="l00609"></a>00609                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#ae1262a92a316b9a38cf32badf9e3025e">ResetCount</a> &lt; 3)
<a name="l00610"></a>00610                         {
<a name="l00611"></a>00611                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae1262a92a316b9a38cf32badf9e3025e">ResetCount</a> ++;
<a name="l00612"></a>00612                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ade451905b5b339ed4d5c75e683a668af">ResetPort</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>;
<a name="l00613"></a>00613                         }
<a name="l00614"></a>00614                         <span class="keywordflow">else</span>
<a name="l00615"></a>00615                         {
<a name="l00616"></a>00616                                 SET_CPU_IPL( 7 ); <span class="comment">// disable all user interrupts</span>
<a name="l00617"></a>00617                                 <a class="code" href="ds_p_i_d33_8c.html#aac92344238c1de7c10a17dac75bc2847">DelayN1ms</a>(200);
<a name="l00618"></a>00618                                 <span class="keyword">asm</span>(<span class="stringliteral">&quot;RESET&quot;</span>);
<a name="l00619"></a>00619                         }
<a name="l00620"></a>00620                 <span class="keywordflow">break</span>;
<a name="l00621"></a>00621                 
<a name="l00622"></a>00622                 <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:               <span class="comment">// Firmware version request</span>
<a name="l00623"></a>00623                         <span class="comment">// Send string &#39;Ver&#39;</span>
<a name="l00624"></a>00624                         <span class="keywordflow">for</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;27; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00625"></a>00625                         {
<a name="l00626"></a>00626                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="ds_p_i_d33_8c.html#a7417cfdacc213b0d90c30c0a81097032">Ver</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; 
<a name="l00627"></a>00627                         }
<a name="l00628"></a>00628                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;R&#39;</span>,26, Port);
<a name="l00629"></a>00629                 <span class="keywordflow">break</span>;
<a name="l00630"></a>00630                 
<a name="l00631"></a>00631                 <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:               <span class="comment">// Continuos send mode</span>
<a name="l00632"></a>00632                         <span class="comment">// sends all data without request.</span>
<a name="l00633"></a>00633                         <span class="comment">//      0=OFF </span>
<a name="l00634"></a>00634                         <span class="comment">//      1=send mean parameters</span>
<a name="l00635"></a>00635                         <span class="comment">//      2=send detailed parameters</span>
<a name="l00636"></a>00636                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a3a8afd2657f6103e1174a7a72aa7d8d5">TxContFlag</a> = <a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="ds_p_i_d33__common_8h.html#a713e0206cf92086243dfbdcf11c1b3dd">RX_HEADER_LEN</a> + 1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>];
<a name="l00637"></a>00637                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a06af0346de02b4af7df612af6e131878">UartContTxTimer</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a54eb0a13ea5c659b585e80fd35c33437">UART_CONT_TIMEOUT</a>;      <span class="comment">// timer reset</span>
<a name="l00638"></a>00638                 <span class="keywordflow">break</span>;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640                 <span class="keywordflow">case</span> <span class="charliteral">&#39;z&#39;</span>:               <span class="comment">// send back a text string, just for debug</span>
<a name="l00641"></a>00641                         <span class="comment">// Send string &#39;Test&#39;</span>
<a name="l00642"></a>00642                         <span class="keywordflow">for</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;27; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++)
<a name="l00643"></a>00643                         {
<a name="l00644"></a>00644                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="com_8h.html#a60ebb4db87db8bc75ff8e36b1ad20cbc">Test</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]; 
<a name="l00645"></a>00645                         }
<a name="l00646"></a>00646                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;z&#39;</span>,24, Port);
<a name="l00647"></a>00647                 <span class="keywordflow">break</span>;
<a name="l00648"></a>00648                 
<a name="l00649"></a>00649                 <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:               <span class="comment">// Read error code and reset error condition</span>
<a name="l00650"></a>00650                         <span class="comment">// Send error value</span>
<a name="l00651"></a>00651                         <a class="code" href="com_8h.html#a9c9d42cf8b66102e2b24a182594f6211">BlinkPeriod</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#aa9bf532ae58ec32b8b1cef6fd9af7fb8">NORM_BLINK_PER</a>;<span class="comment">// LED1 blinking period (ms)</span>
<a name="l00652"></a>00652                         <a class="code" href="com_8h.html#abd61f9304bb5c6902bc8b45a818e2f87">BlinkOn</a>     = <a class="code" href="ds_p_i_d33__definitions_8h.html#a29a7a2eb33d76c77b362c97a95f257e6">NORM_BLINK_ON</a>; <span class="comment">// LED1 on time (ms)</span>
<a name="l00653"></a>00653                         <a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> = 0;
<a name="l00654"></a>00654                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[0][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="com_8h.html#a32e48d54597556ccd285249131884184">ErrCode</a>&gt;&gt;8; 
<a name="l00655"></a>00655                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=<a class="code" href="com_8h.html#a32e48d54597556ccd285249131884184">ErrCode</a>;
<a name="l00656"></a>00656                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;e&#39;</span>,2, Port);  
<a name="l00657"></a>00657                 <span class="keywordflow">break</span>;
<a name="l00658"></a>00658                 
<a name="l00659"></a>00659                 <span class="keywordflow">case</span> <span class="charliteral">&#39;f&#39;</span>:               <span class="comment">// set &quot;Console Debug&quot; mode [30]</span>
<a name="l00660"></a>00660                         <a class="code" href="ds_p_i_d33__definitions_8h.html#adc382dfec1b16542454c8762cef67ff8">CONSOLE_DEBUG</a> = <a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>];
<a name="l00661"></a>00661                 <span class="keywordflow">break</span>;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663                 <span class="keywordflow">case</span> <span class="charliteral">&#39;#&#39;</span>:               <span class="comment">// start scheduler sequence</span>
<a name="l00664"></a>00664                         <a class="code" href="ds_p_i_d33__definitions_8h.html#af7ea439aef95c4e0dc878c1411c0eb16">DIST_OK_FLAG</a>  = 1;      <span class="comment">// to kick start the scheduler sequence</span>
<a name="l00665"></a>00665                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a> = 0;           <span class="comment">// [32]</span>
<a name="l00666"></a>00666                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 1;     <span class="comment">// [32a]</span>
<a name="l00667"></a>00667                 <span class="keywordflow">break</span>;
<a name="l00668"></a>00668                 
<a name="l00669"></a>00669                 
<a name="l00670"></a>00670                 <span class="keywordflow">case</span> <span class="charliteral">&#39;$&#39;</span>:               <span class="comment">// all map grid sending request</span>
<a name="l00671"></a>00671                         <span class="comment">// disable any other procedure pending</span>
<a name="l00672"></a>00672                         DIST_ENABLE_FLAG = 0;   <span class="comment">// disable distance computing [24a]</span>
<a name="l00673"></a>00673                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;                    <span class="comment">// [24d]</span>
<a name="l00674"></a>00674                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;             <span class="comment">// [32a]</span>
<a name="l00675"></a>00675                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0;
<a name="l00676"></a>00676                         
<a name="l00677"></a>00677                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a5208cd5ea16e02d481ebb5fdf8a78b47">SendMapPort</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>;     <span class="comment">// to temporay store port number for delayed TX</span>
<a name="l00678"></a>00678                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a76843a12060f1df6c869de1ac4fba202">MAP_SEND_FLAG</a>=1;
<a name="l00679"></a>00679                         
<a name="l00680"></a>00680                         <span class="comment">// index of row requested by console in 0 to Y_size range</span>
<a name="l00681"></a>00681                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a2c9e0144fde735af9e35912158284217">MapSendIndx</a> = <a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>];      
<a name="l00682"></a>00682                 <span class="keywordflow">break</span>;
<a name="l00683"></a>00683                 
<a name="l00684"></a>00684 <span class="comment">//--- Sensors</span>
<a name="l00685"></a>00685                 <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>:<span class="comment">// Distance from objects, target and compass readings</span>
<a name="l00686"></a>00686                         <span class="comment">// Obj = unsigned int -&gt; 2 byte (mm)</span>
<a name="l00687"></a>00687                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[0] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>])*10; <span class="comment">// Left object</span>
<a name="l00688"></a>00688                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[1] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>])*10; <span class="comment">// Center object</span>
<a name="l00689"></a>00689                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[2] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>])*10; <span class="comment">// Right object</span>
<a name="l00690"></a>00690                         <span class="comment">// Target = unsigned char -&gt; 1 byte</span>
<a name="l00691"></a>00691                         <a class="code" href="ds_p_i_d33__definitions_8h.html#adff81fa529260759dbe72be8c1bdbdf7">Target</a>[0] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]); <span class="comment">// Left target</span>
<a name="l00692"></a>00692                         <a class="code" href="ds_p_i_d33__definitions_8h.html#adff81fa529260759dbe72be8c1bdbdf7">Target</a>[1] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]); <span class="comment">// Center target</span>
<a name="l00693"></a>00693                         <a class="code" href="ds_p_i_d33__definitions_8h.html#adff81fa529260759dbe72be8c1bdbdf7">Target</a>[2] = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]); <span class="comment">// Right target</span>
<a name="l00694"></a>00694                         <span class="comment">// Compass Bearing = int -&gt; 2 byte (deg*10)</span>
<a name="l00695"></a>00695                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0ca2aa233ccefdc83dd783af0d096100">AngleCmp</a> = (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>] &lt;&lt; 8) + 
<a name="l00696"></a>00696                                            (<a class="code" href="com_8h.html#a8ceae767a192fb906f7ae9c4c3cd9985">UartRxBuff</a>[<a class="code" href="com_8c.html#a19eb1a49e69fbbee503ff9209bf3f9bd">IncrCircPtr</a>(Port)][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]);
<a name="l00697"></a>00697                         <span class="comment">// [24g] relative position of obstacles.</span>
<a name="l00698"></a>00698                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[0] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#ad809ae00f641c79b1492a86c94d1e3b9">OBST_THRESHOLD</a>) <span class="comment">// from object on the left</span>
<a name="l00699"></a>00699                         {
<a name="l00700"></a>00700                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[0] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[0] * sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>-AngleS);
<a name="l00701"></a>00701                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[0] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[0] * cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>-AngleS);
<a name="l00702"></a>00702                                 <span class="comment">// mark obstacle in the cell</span>
<a name="l00703"></a>00703                                 <a class="code" href="ds_p_i_d33_8c.html#a93a4744b15d7f3cfa5b61e4141ec50f3">Slam</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[0], <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[0], 1); 
<a name="l00704"></a>00704                         }
<a name="l00705"></a>00705         
<a name="l00706"></a>00706                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[1] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#ad809ae00f641c79b1492a86c94d1e3b9">OBST_THRESHOLD</a>) <span class="comment">// from object on the center</span>
<a name="l00707"></a>00707                         {
<a name="l00708"></a>00708                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[1] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[1] * sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>);
<a name="l00709"></a>00709                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[1] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[1] * cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>);
<a name="l00710"></a>00710                                 <span class="comment">// mark obstacle in the cell</span>
<a name="l00711"></a>00711                                 <a class="code" href="ds_p_i_d33_8c.html#a93a4744b15d7f3cfa5b61e4141ec50f3">Slam</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[1], <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[1], 1); 
<a name="l00712"></a>00712                         }
<a name="l00713"></a>00713                 
<a name="l00714"></a>00714                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[2] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#ad809ae00f641c79b1492a86c94d1e3b9">OBST_THRESHOLD</a>) <span class="comment">// from object on the right</span>
<a name="l00715"></a>00715                         {
<a name="l00716"></a>00716                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[2] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[2] * sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>+AngleS);
<a name="l00717"></a>00717                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[2] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[2] * cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>+AngleS);
<a name="l00718"></a>00718                                 <span class="comment">// mark obstacle in the cell</span>
<a name="l00719"></a>00719                                 <a class="code" href="ds_p_i_d33_8c.html#a93a4744b15d7f3cfa5b61e4141ec50f3">Slam</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[2], <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a> + <a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[2], 1); 
<a name="l00720"></a>00720                         }
<a name="l00721"></a>00721                 <span class="keywordflow">break</span>;
<a name="l00722"></a>00722                 
<a name="l00723"></a>00723                 <span class="keywordflow">case</span> <span class="charliteral">&#39;Q&#39;</span>:<span class="comment">// Raw sensors data, dsNav -&gt; console</span>
<a name="l00724"></a>00724                         <span class="comment">// PosXmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l00725"></a>00725                         Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>);                              <span class="comment">// PosX</span>
<a name="l00726"></a>00726                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[0][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp&gt;&gt;8; 
<a name="l00727"></a>00727                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[1][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp;
<a name="l00728"></a>00728                         <span class="comment">// PosYmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l00729"></a>00729                         Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>);                              <span class="comment">// PosY</span>
<a name="l00730"></a>00730                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[2][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp&gt;&gt;8; 
<a name="l00731"></a>00731                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[3][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Ptmp;
<a name="l00732"></a>00732                         <span class="comment">// ThetaMes rounded in a Int -&gt; 2 byte (degrees)</span>
<a name="l00733"></a>00733                         Ptmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> * <a class="code" href="ds_p_i_d33__definitions_8h.html#ac5a945020d3528355cda82d383676736">RAD2DEG</a>;                              <span class="comment">// Theta</span>
<a name="l00734"></a>00734                         Alpha = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(Ptmp);
<a name="l00735"></a>00735                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[4][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Alpha&gt;&gt;8; 
<a name="l00736"></a>00736                         <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[5][<a class="code" href="ds_p_i_d33__definitions_8h.html#a91b1a1342df7fe9e51fb5dfc4999dfe8">Port</a>]=Alpha;
<a name="l00737"></a>00737                         <span class="comment">// VObX rounded in a Int -&gt; 2 byte (cm)</span>
<a name="l00738"></a>00738                         <span class="keywordflow">for</span>(<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>=0; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>&lt;3; <a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>++) <span class="comment">// Buffer index from 6 to 17</span>
<a name="l00739"></a>00739                         {
<a name="l00740"></a>00740                                 Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a85a3e357f6f89751d9bcdf90b53a6fa8">VObX</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]/10);   <span class="comment">// Obj X coord in cm</span>
<a name="l00741"></a>00741                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[6+(<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*4)][Port]=Ptmp&gt;&gt;8; 
<a name="l00742"></a>00742                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[7+(<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*4)][Port]=Ptmp;
<a name="l00743"></a>00743                                 Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a8915a283f3341051387c496eb376a494">VObY</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>]/10);   <span class="comment">// Obj Y coord in cm</span>
<a name="l00744"></a>00744                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[8+(<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*4)][Port]=Ptmp&gt;&gt;8; 
<a name="l00745"></a>00745                                 <a class="code" href="com_8h.html#adaa76057cb4ddf83ec874d920a81a491">UartTmpBuff</a>[9+(<a class="code" href="ds_p_i_d33__definitions_8h.html#acb559820d9ca11295b4500f179ef6392">i</a>*4)][Port]=Ptmp;
<a name="l00746"></a>00746                         }
<a name="l00747"></a>00747                         
<a name="l00748"></a>00748                         <a class="code" href="com_8c.html#ac098f07c32fe84a9dfa3452021b3eb9f">TxParameters</a>(<span class="charliteral">&#39;Q&#39;</span>,18, Port);  
<a name="l00749"></a>00749                 <span class="keywordflow">break</span>;
<a name="l00750"></a>00750                 
<a name="l00751"></a>00751                 <span class="keywordflow">default</span>:
<a name="l00752"></a>00752                         <a class="code" href="com_8c.html#aeb884ff41ce361b52054618f034b5a0a">UartRxError</a>(-7,Port); <span class="comment">//        error: not a known command</span>
<a name="l00753"></a>00753                 <span class="keywordflow">break</span>;
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#ae9001072ff3f6278e5bea58c38d07590">00757</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#ae9001072ff3f6278e5bea58c38d07590">Scheduler</a>(<span class="keywordtype">void</span>)
<a name="l00758"></a>00758 {
<a name="l00764"></a>00764         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> SchedCode= 0;     <span class="comment">// action to execute</span>
<a name="l00765"></a>00765         <span class="keywordtype">float</span> DPosX;    <span class="comment">// delta PosX</span>
<a name="l00766"></a>00766         <span class="keywordtype">float</span> DPosY;    <span class="comment">// delta PosY</span>
<a name="l00767"></a>00767 
<a name="l00768"></a>00768         <a class="code" href="ds_p_i_d33__definitions_8h.html#aca83bbf78c4f9caa63078080a8ed5a80">ANGLE_OK_FLAG</a> = 0;
<a name="l00769"></a>00769         <a class="code" href="ds_p_i_d33__definitions_8h.html#af7ea439aef95c4e0dc878c1411c0eb16">DIST_OK_FLAG</a>  = 0;
<a name="l00770"></a>00770         <a class="code" href="ds_p_i_d33__definitions_8h.html#a373d3f761ff9c5fff2a44aaec95bf73c">TIMER_OK_FLAG</a> = 0;
<a name="l00771"></a>00771         <a class="code" href="ds_p_i_d33__definitions_8h.html#aac600120fd5a9765c7885a35e55a8b00">SCHED_ANGLE_FLAG</a> = 0;
<a name="l00772"></a>00772         <a class="code" href="ds_p_i_d33__definitions_8h.html#a531d0613e1d07e256d85f17942987279">SCHED_DIST_FLAG</a> = 0;
<a name="l00773"></a>00773         
<a name="l00774"></a>00774         <span class="comment">/*      </span>
<a name="l00775"></a>00775 <span class="comment">         Units </span>
<a name="l00776"></a>00776 <span class="comment">          code  </span>
<a name="l00777"></a>00777 <span class="comment">          Angle(deg)    </span>
<a name="l00778"></a>00778 <span class="comment">          Speed(mm/s)   </span>
<a name="l00779"></a>00779 <span class="comment">          X(mm) </span>
<a name="l00780"></a>00780 <span class="comment">          Y(mm) </span>
<a name="l00781"></a>00781 <span class="comment">          D(mm) </span>
<a name="l00782"></a>00782 <span class="comment">          Delay(n x 50ms)</span>
<a name="l00783"></a>00783 <span class="comment"></span>
<a name="l00784"></a>00784 <span class="comment">          Meaning of parameters</span>
<a name="l00785"></a>00785 <span class="comment">                code    1               2               3</span>
<a name="l00786"></a>00786 <span class="comment">                0               </span>
<a name="l00787"></a>00787 <span class="comment">                1               V</span>
<a name="l00788"></a>00788 <span class="comment">                2               V(2)    D</span>
<a name="l00789"></a>00789 <span class="comment">                3               V(2)    Theta   </span>
<a name="l00790"></a>00790 <span class="comment">                4               V(2)    X               Y</span>
<a name="l00791"></a>00791 <span class="comment">                5               V(2)    X               Y</span>
<a name="l00792"></a>00792 <span class="comment">                6               Delay</span>
<a name="l00793"></a>00793 <span class="comment">        */</span>
<a name="l00794"></a>00794         
<a name="l00795"></a>00795         SchedCode = <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][0];
<a name="l00796"></a>00796         <span class="keywordflow">switch</span> (SchedCode)
<a name="l00797"></a>00797                 {     
<a name="l00798"></a>00798                         <span class="keywordflow">case</span> 0: <span class="comment">// stop end of sequence</span>
<a name="l00799"></a>00799                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0;
<a name="l00800"></a>00800                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00801"></a>00801                         <span class="keywordflow">break</span>;
<a name="l00802"></a>00802                         
<a name="l00803"></a>00803                         <span class="keywordflow">case</span> 1: <span class="comment">// keep previous angle - set speed</span>
<a name="l00804"></a>00804                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];
<a name="l00805"></a>00805                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a6ce32b0adb9261aebe9c582fe98403b0">RT_TIMER_FLAG</a> = 1;
<a name="l00806"></a>00806                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9143ee7b83c3016f37b301761c2d0ae6">RtTimer</a> = 2;    <span class="comment">// wait 100ms for next step</span>
<a name="l00807"></a>00807                         <span class="keywordflow">break</span>;
<a name="l00808"></a>00808                         
<a name="l00809"></a>00809                         <span class="keywordflow">case</span> 2: <span class="comment">// keep angle and speed(2)      -       set distance</span>
<a name="l00810"></a>00810                                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1] != 0xFFFF)
<a name="l00811"></a>00811                                 {
<a name="l00812"></a>00812                                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];
<a name="l00813"></a>00813                                 }
<a name="l00814"></a>00814                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>+(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][2]*sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>));
<a name="l00815"></a>00815                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a1baf79cb6ce6068c5da1478564220ef8">PosYdes</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>+(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][2]*cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>));
<a name="l00816"></a>00816                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a531d0613e1d07e256d85f17942987279">SCHED_DIST_FLAG</a> = 1;    <span class="comment">// wait for target distance</span>
<a name="l00817"></a>00817                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a> = 1;   <span class="comment">// enable distance computing [24a]</span>
<a name="l00818"></a>00818                         <span class="keywordflow">break</span>;
<a name="l00819"></a>00819                         
<a name="l00820"></a>00820                         <span class="keywordflow">case</span> 3: <span class="comment">// keep speed(2) - set angle</span>
<a name="l00821"></a>00821                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aac600120fd5a9765c7885a35e55a8b00">SCHED_ANGLE_FLAG</a> = 1;   <span class="comment">// wait for target angle</span>
<a name="l00822"></a>00822                                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1] != 0xFFFF)
<a name="l00823"></a>00823                                 {
<a name="l00824"></a>00824                                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];
<a name="l00825"></a>00825                                 }
<a name="l00826"></a>00826                                 <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][2] * <a class="code" href="ds_p_i_d33__definitions_8h.html#af7e8592d0a634bd3642e9fd508ea8022">DEG2RAD</a>);
<a name="l00827"></a>00827                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a> = 0;   <span class="comment">// disable distance computing [24a]</span>
<a name="l00828"></a>00828                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;                    <span class="comment">// [24d]</span>
<a name="l00829"></a>00829                         <span class="keywordflow">break</span>;
<a name="l00830"></a>00830                         
<a name="l00831"></a>00831                         <span class="keywordflow">case</span> 4: <span class="comment">// keep speed(2) - set angle toward X, Y</span>
<a name="l00832"></a>00832                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aac600120fd5a9765c7885a35e55a8b00">SCHED_ANGLE_FLAG</a> = 1;   <span class="comment">// wait for target angle</span>
<a name="l00833"></a>00833                                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1] != 0xFFFF)
<a name="l00834"></a>00834                                 {
<a name="l00835"></a>00835                                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];
<a name="l00836"></a>00836                                 }
<a name="l00837"></a>00837                                 DPosX=(float)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][2])-<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>;<span class="comment">//delta on X</span>
<a name="l00838"></a>00838                                 DPosY=(float)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[SchedPtr][3])-<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>;<span class="comment">//delta on Y</span>
<a name="l00839"></a>00839 <span class="comment">//                              if ((DPosX != 0) &amp;&amp; (DPosY != 0))</span>
<a name="l00840"></a>00840                                 <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>(atan2f(DPosX,DPosY));<span class="comment">//Tan(ThetaDes)=Sin/Cos=X/Y</span>
<a name="l00841"></a>00841                         <span class="keywordflow">break</span>;
<a name="l00842"></a>00842                         
<a name="l00843"></a>00843                         <span class="keywordflow">case</span> 5: <span class="comment">// keep speed(2) - walk toward X, Y</span>
<a name="l00844"></a>00844                                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[SchedPtr][1] != 0xFFFF)
<a name="l00845"></a>00845                                 {
<a name="l00846"></a>00846                                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> =  <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];
<a name="l00847"></a>00847                                 }
<a name="l00848"></a>00848                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a> = (float)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[SchedPtr][2]);
<a name="l00849"></a>00849                                 PosYdes = (float)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[SchedPtr][3]);
<a name="l00850"></a>00850                                 SCHED_DIST_FLAG = 1;    <span class="comment">// wait for target distance</span>
<a name="l00851"></a>00851                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a> = 1;   <span class="comment">// enable distance computing [24a]</span>
<a name="l00852"></a>00852                         <span class="keywordflow">break</span>;
<a name="l00853"></a>00853                         
<a name="l00854"></a>00854                         <span class="keywordflow">case</span> 6: <span class="comment">// wait n ms</span>
<a name="l00855"></a>00855                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6ce32b0adb9261aebe9c582fe98403b0">RT_TIMER_FLAG</a> = 1;
<a name="l00856"></a>00856                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9143ee7b83c3016f37b301761c2d0ae6">RtTimer</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a>][1];     <span class="comment">// n x 50ms</span>
<a name="l00857"></a>00857                         <span class="keywordflow">break</span>;
<a name="l00858"></a>00858                         
<a name="l00859"></a>00859                         <span class="keywordflow">default</span>:<span class="comment">// the same as 0</span>
<a name="l00860"></a>00860                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0;
<a name="l00861"></a>00861                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00862"></a>00862                         <span class="keywordflow">break</span>;
<a name="l00863"></a>00863                 }
<a name="l00864"></a>00864                 
<a name="l00865"></a>00865         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a> &lt; 15)
<a name="l00866"></a>00866         {
<a name="l00867"></a>00867                 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa5307d2fde19360b47fe9bad0be299e4">SchedPtr</a> ++;    <span class="comment">// next step</span>
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869 }       
<a name="l00870"></a>00870 
<a name="l00871"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a63ff5d10ae06640d7684853793960861">00871</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a63ff5d10ae06640d7684853793960861">AdcCalc</a>(<span class="keywordtype">void</span>)
<a name="l00872"></a>00872 {
<a name="l00877"></a>00877         <span class="keyword">extern</span> <span class="keywordtype">int</span> DmaAdc[2][64];
<a name="l00878"></a>00878         <span class="keywordtype">int</span> AdcCount = 0;
<a name="l00879"></a>00879         <span class="keywordtype">long</span> ADCValueTmp[2] = {0,0};<span class="comment">// to store intermediate ADC calculations </span>
<a name="l00880"></a>00880 
<a name="l00881"></a>00881         <a class="code" href="ds_p_i_d33__definitions_8h.html#a4a4f245b2f0fef97b86e2c5ef04377c8">ADC_CALC_FLAG</a> = 0; <span class="comment">// will be set by ISR when all data available</span>
<a name="l00882"></a>00882         <span class="comment">// averages the 64 ADC values for each ANx</span>
<a name="l00883"></a>00883     <span class="keywordflow">for</span> (AdcCount=0;AdcCount&lt;64;AdcCount++)     
<a name="l00884"></a>00884     {
<a name="l00885"></a>00885                 ADCValueTmp[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] += DmaAdc[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>][AdcCount];
<a name="l00886"></a>00886                 ADCValueTmp[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] += DmaAdc[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>][AdcCount];
<a name="l00887"></a>00887     }
<a name="l00888"></a>00888     <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = ADCValueTmp[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] &gt;&gt; 6; <span class="comment">// [2a]</span>
<a name="l00889"></a>00889     <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = ADCValueTmp[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] &gt;&gt; 6; <span class="comment">// [2a]          </span>
<a name="l00890"></a>00890     
<a name="l00891"></a>00891     <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a6cfaac353bb7fd05234ebc4111ee0ebb">ADC_OVLD_LIMIT</a>)   <span class="comment">// [2b]</span>
<a name="l00892"></a>00892     {
<a name="l00893"></a>00893         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] ++;
<a name="l00894"></a>00894     }
<a name="l00895"></a>00895     <span class="keywordflow">else</span>
<a name="l00896"></a>00896     {
<a name="l00897"></a>00897         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 0;
<a name="l00898"></a>00898     }
<a name="l00899"></a>00899     
<a name="l00900"></a>00900     <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a6cfaac353bb7fd05234ebc4111ee0ebb">ADC_OVLD_LIMIT</a>)   <span class="comment">// [2b]</span>
<a name="l00901"></a>00901     {
<a name="l00902"></a>00902         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] ++;
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904     <span class="keywordflow">else</span>
<a name="l00905"></a>00905     {
<a name="l00906"></a>00906         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 0;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908     
<a name="l00909"></a>00909     <span class="keywordflow">if</span> ((<a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;<a class="code" href="ds_p_i_d33__definitions_8h.html#a81c2d6652c94e211ad6c6e442e3b5fbd">ADC_OVLD_TIME</a>)||(<a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;<a class="code" href="ds_p_i_d33__definitions_8h.html#a81c2d6652c94e211ad6c6e442e3b5fbd">ADC_OVLD_TIME</a>))
<a name="l00910"></a>00910     {
<a name="l00911"></a>00911         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=0;
<a name="l00912"></a>00912         <a class="code" href="ds_p_i_d33__definitions_8h.html#aade7be249c2caf27504ec7fd7e8c8508">ADCOvldCount</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=0;
<a name="l00913"></a>00913         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0; <span class="comment">// immediate halt</span>
<a name="l00914"></a>00914                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ade662f9c9608f2332ec7ff34e5f06e4a">SCHEDULER_FLAG</a> = 0;     <span class="comment">// [32a]</span>
<a name="l00915"></a>00915                 <a class="code" href="com_8h.html#abd61f9304bb5c6902bc8b45a818e2f87">BlinkOn</a> = 50;   <span class="comment">// very fast blink for alarm</span>
<a name="l00916"></a>00916                 <a class="code" href="com_8h.html#a9c9d42cf8b66102e2b24a182594f6211">BlinkPeriod</a> = 100;
<a name="l00917"></a>00917                 <a class="code" href="com_8h.html#a32e48d54597556ccd285249131884184">ErrCode</a> = -30;
<a name="l00918"></a>00918     }
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 
<a name="l00922"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a29b430d2e786c1e8ab27a2f787f4df1c">00922</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a29b430d2e786c1e8ab27a2f787f4df1c">InitDistPid</a>(<span class="keywordtype">void</span>)
<a name="l00923"></a>00923 {
<a name="l00930"></a>00930 <span class="comment">//Set up pointer to derived coefficients</span>
<a name="l00931"></a>00931 <a class="code" href="ds_p_i_d33__definitions_8h.html#a715040b202d0ca821b605d16197b96d5">DistPIDstruct</a>.abcCoefficients = &amp;DistabcCoefficient[0];
<a name="l00932"></a>00932 <span class="comment">//Set up pointer to controller history samples</span>
<a name="l00933"></a>00933 <a class="code" href="ds_p_i_d33__definitions_8h.html#a715040b202d0ca821b605d16197b96d5">DistPIDstruct</a>.controlHistory = &amp;DistcontrolHistory[0]; 
<a name="l00934"></a>00934 <span class="comment">// Clear the controler history and the controller output</span>
<a name="l00935"></a>00935 PIDInit(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a715040b202d0ca821b605d16197b96d5">DistPIDstruct</a>); 
<a name="l00936"></a>00936 <span class="comment">//Derive the a,b, &amp; c coefficients from the Kp, Ki &amp; Kd</span>
<a name="l00937"></a>00937 PIDCoeffCalc(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a67cdd7dca12b7f9968a16d3f6b192005">DistKCoeffs</a>[0], &amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a715040b202d0ca821b605d16197b96d5">DistPIDstruct</a>); 
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a940b55006b1caa885449d669bcd094bf">00940</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a940b55006b1caa885449d669bcd094bf">Navigation</a>(<span class="keywordtype">void</span>)   
<a name="l00941"></a>00941 {
<a name="l00948"></a>00948         <span class="keywordtype">float</span> DPosX;    <span class="comment">// delta PosX</span>
<a name="l00949"></a>00949         <span class="keywordtype">float</span> DPosY;    <span class="comment">// delta PosY</span>
<a name="l00950"></a>00950         <span class="keywordtype">float</span> Dist;             <span class="comment">// distance</span>
<a name="l00951"></a>00951         <span class="keywordtype">float</span> VelDecrObj; <span class="comment">// speed decreasing due to objects found</span>
<a name="l00952"></a>00952         
<a name="l00953"></a>00953         <a class="code" href="ds_p_i_d33__definitions_8h.html#af0dcd631114229755ad63f9b08af523e">CYCLE2_FLAG</a> = 0; <span class="comment">// will be set again by timer ISR</span>
<a name="l00954"></a>00954         
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a>)
<a name="l00956"></a>00956         {
<a name="l00957"></a>00957                 <span class="comment">// distance from goal, i.e.: distance from desired to current position</span>
<a name="l00958"></a>00958                 DPosX = <a class="code" href="ds_p_i_d33__definitions_8h.html#a2635a2a8a96cbdbb51082800d9721d7e">PosXdes</a> - <a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>;         <span class="comment">// X component of distance</span>
<a name="l00959"></a>00959                 DPosY = <a class="code" href="ds_p_i_d33__definitions_8h.html#a1baf79cb6ce6068c5da1478564220ef8">PosYdes</a> - <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>;         <span class="comment">// Y component of distance</span>
<a name="l00960"></a>00960                 Dist = sqrtf(powf(DPosX,2) + powf(DPosY,2));<span class="comment">// Pythagora&#39;s Theorem</span>
<a name="l00961"></a>00961         }
<a name="l00962"></a>00962         <span class="keywordflow">else</span>
<a name="l00963"></a>00963         {
<a name="l00964"></a>00964                 Dist = <a class="code" href="ds_p_i_d33__definitions_8h.html#ad809ae00f641c79b1492a86c94d1e3b9">OBST_THRESHOLD</a>;  <span class="comment">// a reference value</span>
<a name="l00965"></a>00965                 DPosX = Dist * sin(<a class="code" href="ds_p_i_d33__definitions_8h.html#a068c444982c70985882428ce63952cc2">ThetaDesRef</a>);
<a name="l00966"></a>00966                 DPosY = Dist * cos(<a class="code" href="ds_p_i_d33__definitions_8h.html#a068c444982c70985882428ce63952cc2">ThetaDesRef</a>);
<a name="l00967"></a>00967         }
<a name="l00968"></a>00968         
<a name="l00969"></a>00969         <span class="keywordflow">if</span> (Dist &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#aedd6e124730bfe1673b03e189cff590b">MIN_DIST_ERR</a>)        <span class="comment">// goal reached</span>
<a name="l00970"></a>00970         {
<a name="l00971"></a>00971                 <a class="code" href="ds_p_i_d33__definitions_8h.html#add50f4fe20c4b7e50241cb3579f7ef34">DIST_ENABLE_FLAG</a> = 0;   <span class="comment">// disable distance computing [24a]</span>
<a name="l00972"></a>00972                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = 1;                    <span class="comment">// [24d]</span>
<a name="l00973"></a>00973                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> = 0;
<a name="l00974"></a>00974                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a531d0613e1d07e256d85f17942987279">SCHED_DIST_FLAG</a>)
<a name="l00975"></a>00975                 {
<a name="l00976"></a>00976                         <a class="code" href="ds_p_i_d33__definitions_8h.html#af7ea439aef95c4e0dc878c1411c0eb16">DIST_OK_FLAG</a> = 1;       <span class="comment">// target ok</span>
<a name="l00977"></a>00977                 }
<a name="l00978"></a>00978                 <span class="keywordflow">return</span>; <span class="comment">// job done</span>
<a name="l00979"></a>00979         }
<a name="l00980"></a>00980         <span class="keywordflow">else</span>
<a name="l00981"></a>00981         {<span class="comment">// set ThetaDes and VelDecr to reach the goal avoiding obstacles</span>
<a name="l00982"></a>00982                 VelDecrObj=<a class="code" href="ds_p_i_d33_8c.html#a0c8640709de54ea1ae1448abfaf30a8c">ObstacleAvoidance</a>(DPosX, DPosY, Dist);  
<a name="l00983"></a>00983         }       
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="keywordflow">if</span> (Dist &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a07122fde28e925b71a5b68b8827e62f8">MIN_GOAL_DIST</a>)          <span class="comment">// [24c]</span>
<a name="l00986"></a>00986         {
<a name="l00987"></a>00987                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a027d83a57a888a2d8156847c4c494f8e">DIST_PID_DES</a> = 0;                  <span class="comment">// the goal is to have dist=0 from target</span>
<a name="l00988"></a>00988                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a5ee3558b37ea6b4231e7a2bc3910a117">DIST_PID_MES</a> = Q15((<span class="keywordtype">float</span>)Dist/(<span class="keywordtype">float</span>)<a class="code" href="ds_p_i_d33__definitions_8h.html#a07122fde28e925b71a5b68b8827e62f8">MIN_GOAL_DIST</a>);  <span class="comment">// measured input</span>
<a name="l00989"></a>00989                 PID(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a715040b202d0ca821b605d16197b96d5">DistPIDstruct</a>);
<a name="l00990"></a>00990                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = -_itofQ15(<a class="code" href="ds_p_i_d33__definitions_8h.html#a651f9a68ebf4bf0bb1e2590a430e7dde">DIST_PID_OUT</a>); <span class="comment">// [24d]</span>
<a name="l00991"></a>00991                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> *= VelDecrObj;
<a name="l00992"></a>00992         }
<a name="l00993"></a>00993         <span class="keywordflow">else</span>
<a name="l00994"></a>00994         {
<a name="l00995"></a>00995                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a> = VelDecrObj;
<a name="l00996"></a>00996         }
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a0c8640709de54ea1ae1448abfaf30a8c">00999</a> <span class="keywordtype">float</span> <a class="code" href="ds_p_i_d33_8c.html#a0c8640709de54ea1ae1448abfaf30a8c">ObstacleAvoidance</a>(<span class="keywordtype">float</span> DPosX, <span class="keywordtype">float</span> DPosY, <span class="keywordtype">int</span> DistTarget)
<a name="l01000"></a>01000 {
<a name="l01014"></a>01014         <span class="keywordtype">float</span> VX;                               <span class="comment">// X component of resultant vector</span>
<a name="l01015"></a>01015         <span class="keywordtype">float</span> VY;                               <span class="comment">// Y component of resultant vector</span>
<a name="l01016"></a>01016         <span class="keywordtype">float</span> VM;                               <span class="comment">// magnitude of resultant vector</span>
<a name="l01017"></a>01017         <span class="keyword">const</span> <span class="keywordtype">float</span> Fcr= 0.2;   <span class="comment">// Force constant (repelling)</span>
<a name="l01018"></a>01018         <span class="keyword">const</span> <span class="keywordtype">float</span> Fct= 1;     <span class="comment">// Force constant (attraction to the target)</span>
<a name="l01019"></a>01019         <span class="keywordtype">int</span> Cx;                                 <span class="comment">// loop counters</span>
<a name="l01020"></a>01020         <span class="keywordtype">int</span> Cy;
<a name="l01021"></a>01021         <span class="keywordtype">int</span> X_grid;
<a name="l01022"></a>01022         <span class="keywordtype">int</span> Y_grid;
<a name="l01023"></a>01023         <span class="keywordtype">int</span> CellV;                              <span class="comment">// the valued contained in the current cell</span>
<a name="l01024"></a>01024         <span class="keywordtype">float</span> Frx=0;                    <span class="comment">// component vectors of the repulsive force</span>
<a name="l01025"></a>01025         <span class="keywordtype">float</span> Fry=0;
<a name="l01026"></a>01026         <span class="keywordtype">float</span> FrTmp;
<a name="l01027"></a>01027         <span class="keywordtype">float</span> Ftx=0;                    <span class="comment">// component vectors of the actractive force</span>
<a name="l01028"></a>01028         <span class="keywordtype">float</span> Fty=0;
<a name="l01029"></a>01029         <span class="keywordtype">int</span> TableX;
<a name="l01030"></a>01030         <span class="keywordtype">int</span> TableY;
<a name="l01031"></a>01031                 
<a name="l01032"></a>01032         <span class="keywordflow">if</span>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[0]&lt;<a class="code" href="ds_p_i_d33__definitions_8h.html#aca8498715115b77faaef8c43584b8441">OBST_MIN_DIST</a>||<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[1]&lt;<a class="code" href="ds_p_i_d33__definitions_8h.html#aca8498715115b77faaef8c43584b8441">OBST_MIN_DIST</a>||<a class="code" href="ds_p_i_d33__definitions_8h.html#a53f3c247edf8c7d02a8d48f4b42f7a3b">Obj</a>[2]&lt;<a class="code" href="ds_p_i_d33__definitions_8h.html#aca8498715115b77faaef8c43584b8441">OBST_MIN_DIST</a>)
<a name="l01033"></a>01033         {<span class="comment">// set ThetaDes and VelDecr to avoid very close obstacles</span>
<a name="l01034"></a>01034                 <span class="keywordflow">return</span> -0.2; <span class="comment">// walk backward at a slow speed</span>
<a name="l01035"></a>01035         } 
<a name="l01036"></a>01036         <span class="keywordflow">else</span>
<a name="l01037"></a>01037         {       <span class="comment">// index in the range 0-Y_SIZE to point the grid matrix</span>
<a name="l01038"></a>01038                 X_grid=<a class="code" href="ds_p_i_d33_8c.html#a3a90a7ce8d2eab466a689d41c5f0749c">PosIndx</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>);
<a name="l01039"></a>01039                 Y_grid=<a class="code" href="ds_p_i_d33_8c.html#a3a90a7ce8d2eab466a689d41c5f0749c">PosIndx</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>);
<a name="l01040"></a>01040                 
<a name="l01041"></a>01041                 TableX=<a class="code" href="ds_p_i_d33__definitions_8h.html#a032503e76d6f69bc67e99e909c8125da">TABLE_SIZE</a>-<a class="code" href="ds_p_i_d33__definitions_8h.html#a87ba161fb7680322a1660aa88e2a29d6">OBST_FIELD</a>;<span class="comment">//define the field scanned into the table</span>
<a name="l01042"></a>01042                 <span class="keywordflow">for</span>(Cx = X_grid-OBST_FIELD; Cx &lt;= X_grid+<a class="code" href="ds_p_i_d33__definitions_8h.html#a87ba161fb7680322a1660aa88e2a29d6">OBST_FIELD</a>; Cx++)
<a name="l01043"></a>01043                 {
<a name="l01044"></a>01044                   <span class="keywordflow">if</span>((Cx &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a09631c0b7f27139c9a5c3e4dcd34a1be">X_POINT_MIN</a>) &amp;&amp; (Cx &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#acf7323c7a26a48b48deebce4d31f261e">X_POINT_MAX</a>))
<a name="l01045"></a>01045                   {
<a name="l01046"></a>01046                         TableY=<a class="code" href="ds_p_i_d33__definitions_8h.html#a032503e76d6f69bc67e99e909c8125da">TABLE_SIZE</a>-<a class="code" href="ds_p_i_d33__definitions_8h.html#a87ba161fb7680322a1660aa88e2a29d6">OBST_FIELD</a>;<span class="comment">//define the field scanned</span>
<a name="l01047"></a>01047                     <span class="keywordflow">for</span>(Cy = Y_grid-OBST_FIELD; Cy &lt;= Y_grid+<a class="code" href="ds_p_i_d33__definitions_8h.html#a87ba161fb7680322a1660aa88e2a29d6">OBST_FIELD</a>; Cy++)
<a name="l01048"></a>01048                         {
<a name="l01049"></a>01049                           <span class="keywordflow">if</span>((Cy &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#ac1bb0712b803de79cf3348d070eaac5d">Y_POINT_MIN</a>) &amp;&amp; (Cy &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a4b4a0272c6ea0bf2f30bfb98c3ca586e">Y_POINT_MAX</a>))
<a name="l01050"></a>01050                           {
<a name="l01051"></a>01051                             CellV=<a class="code" href="ds_p_i_d33_8c.html#a0045cdba351669e55136652c9b95b39b">GetMap</a>(Cx, Cy);
<a name="l01052"></a>01052                                 <span class="keywordflow">if</span>((CellV &gt; 0) &amp;&amp; (CellV &lt; 8))
<a name="l01053"></a>01053                                 {
<a name="l01054"></a>01054                                   <span class="keywordflow">if</span>((Cx != 0) &amp;&amp; (Cy != 0))
<a name="l01055"></a>01055                                   {
<a name="l01056"></a>01056                                         FrTmp = Fcr*CellV;
<a name="l01057"></a>01057                                         Frx+=FrTmp*VffTableX[TableX][TableY];
<a name="l01058"></a>01058                                     Fry+=FrTmp*VffTableY[TableX][TableY];
<a name="l01059"></a>01059                                   }
<a name="l01060"></a>01060                             }
<a name="l01061"></a>01061                           }
<a name="l01062"></a>01062                           TableY++;
<a name="l01063"></a>01063                     }
<a name="l01064"></a>01064                   }
<a name="l01065"></a>01065                   TableX++;
<a name="l01066"></a>01066             }
<a name="l01067"></a>01067                 
<a name="l01068"></a>01068                 <span class="comment">//The target generates a constant-magnitud attracting force</span>
<a name="l01069"></a>01069                 Ftx=Fct*DPosX; <span class="comment">// /DistTarget;</span>
<a name="l01070"></a>01070                 Fty=Fct*DPosY; <span class="comment">// /DistTarget;</span>
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                 VX=Frx+Ftx;     <span class="comment">// Resultant Force Vector</span>
<a name="l01073"></a>01073                 VY=Fry+Fty;
<a name="l01074"></a>01074                 VM = 1; <span class="comment">// to be defined (sqrtf(powf(VX,2) + powf(VY,2)))/OBST_THRESHOLD;</span>
<a name="l01075"></a>01075                                 
<a name="l01076"></a>01076 <span class="preprocessor">                #ifdef NO_OBSTACLE</span>
<a name="l01077"></a>01077 <span class="preprocessor"></span><span class="preprocessor">                #warning -- compiling with NO OBSTACLE *************************************</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span>                        VX = DPosX;
<a name="l01079"></a>01079                         VY = DPosY;
<a name="l01080"></a>01080                         VM = 1;
<a name="l01081"></a>01081 <span class="preprocessor">                #endif</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span>                
<a name="l01083"></a>01083                 <span class="keywordflow">if</span> ((VX != 0) &amp;&amp; (VY != 0))
<a name="l01084"></a>01084                 {<span class="comment">// phase of new vector [22aa] Tangent(ThetaDes) = Sin/Cos = X/Y</span>
<a name="l01085"></a>01085                         <a class="code" href="ds_p_i_d33_8c.html#a8b82cc7f0f1e3ecdba52598d406e5932">ThetaDesF</a>(atan2f(VX,VY)); 
<a name="l01086"></a>01086                 }               
<a name="l01087"></a>01087                 <span class="keywordflow">return</span> VM;
<a name="l01088"></a>01088         }
<a name="l01089"></a>01089 }
<a name="l01090"></a>01090 
<a name="l01091"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#ac3ed2ee8bf58d974554b636fce82b2e2">01091</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#ac3ed2ee8bf58d974554b636fce82b2e2">InitAnglePid</a>(<span class="keywordtype">void</span>)
<a name="l01092"></a>01092 {
<a name="l01099"></a>01099 <span class="comment">//Initialize the PID data structure: PIDstruct</span>
<a name="l01100"></a>01100 <span class="comment">//Set up pointer to derived coefficients</span>
<a name="l01101"></a>01101 <a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>.abcCoefficients = &amp;AngleabcCoefficient[0];
<a name="l01102"></a>01102 <span class="comment">//Set up pointer to controller history samples</span>
<a name="l01103"></a>01103 <a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>.controlHistory = &amp;AnglecontrolHistory[0]; 
<a name="l01104"></a>01104 <span class="comment">// Clear the controler history and the controller output</span>
<a name="l01105"></a>01105 PIDInit(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>); 
<a name="l01106"></a>01106 <span class="comment">//Derive the a,b, &amp; c coefficients from the Kp, Ki &amp; Kd</span>
<a name="l01107"></a>01107 PIDCoeffCalc(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a797c49f2ced858a984c41d3e8fd14e72">AngleKCoeffs</a>[0], &amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>); 
<a name="l01108"></a>01108 }
<a name="l01109"></a>01109 
<a name="l01110"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#abf3685fb9a5c5a777ac2d0712f8e501a">01110</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#abf3685fb9a5c5a777ac2d0712f8e501a">Orientation</a>(<span class="keywordtype">void</span>)
<a name="l01111"></a>01111 {
<a name="l01118"></a>01118         <span class="keywordtype">int</span> DeltaVel;   <span class="comment">// difference in speed between the wheels to rotate</span>
<a name="l01119"></a>01119         <span class="keywordtype">int</span> RealVel;    <span class="comment">// VelDesM after reduction controlled by Dist PID</span>
<a name="l01120"></a>01120         <span class="keywordtype">float</span> Error;    
<a name="l01121"></a>01121         
<a name="l01122"></a>01122         <a class="code" href="ds_p_i_d33__definitions_8h.html#a30e68f049d4b4acf8f80003200ea854e">ORIENTATION_FLAG</a> = 0; <span class="comment">// it will be restarted by DeadReckoning()</span>
<a name="l01123"></a>01123         
<a name="l01124"></a>01124         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a> &lt; 0) <a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a> += <a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>;    <span class="comment">// keep angle value positive</span>
<a name="l01125"></a>01125         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> &lt; 0) <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> += <a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>;
<a name="l01126"></a>01126         Error = <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> - <a class="code" href="ds_p_i_d33__definitions_8h.html#abc1f22f668c9b07f4477ee12d19da5b0">ThetaDes</a>;
<a name="l01127"></a>01127         <span class="keywordflow">if</span> (Error &gt; PI) <span class="comment">// search for the best direction to correct error [23a]</span>
<a name="l01128"></a>01128         {
<a name="l01129"></a>01129                 Error -= <a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>;
<a name="l01130"></a>01130         }
<a name="l01131"></a>01131         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Error &lt; -PI)
<a name="l01132"></a>01132         {
<a name="l01133"></a>01133                 Error += <a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>;
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aac600120fd5a9765c7885a35e55a8b00">SCHED_ANGLE_FLAG</a>)
<a name="l01136"></a>01136         {
<a name="l01137"></a>01137                 <span class="keywordflow">if</span> (fabsf(Error) &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a47809da00fa7cc003e2ff41af8438af8">MIN_THETA_ERR</a>) 
<a name="l01138"></a>01138                 {
<a name="l01139"></a>01139                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aca83bbf78c4f9caa63078080a8ed5a80">ANGLE_OK_FLAG</a> = 1;      <span class="comment">// target ok</span>
<a name="l01140"></a>01140                 }
<a name="l01141"></a>01141         }
<a name="l01142"></a>01142         
<a name="l01143"></a>01143         <a class="code" href="ds_p_i_d33__definitions_8h.html#a53bb5d1f40e3e633fef41b210da86654">ANGLE_PID_DES</a> = 0;                              <span class="comment">// ref value translated to 0 [23c]</span>
<a name="l01144"></a>01144         <a class="code" href="ds_p_i_d33__definitions_8h.html#a32cfbd4cacf3295bdba1ad24f78154d5">ANGLE_PID_MES</a> = Q15(Error/PI);  <span class="comment">// current error [23b]</span>
<a name="l01145"></a>01145         PID(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a680c5fd72d576ef78f85bfd8b51d5275">AnglePIDstruct</a>);
<a name="l01146"></a>01146         
<a name="l01147"></a>01147         DeltaVel = (<a class="code" href="ds_p_i_d33__definitions_8h.html#a70180b4d353ebc308d5faf29b46e8be8">ANGLE_PID_OUT</a> &gt;&gt; 7);<span class="comment">// MAX delta in int = 256 [23d]</span>
<a name="l01148"></a>01148         RealVel = <a class="code" href="ds_p_i_d33__definitions_8h.html#a0c7ca19d73cabf276598e53781d1a2a9">VelDesM</a> * <a class="code" href="ds_p_i_d33__definitions_8h.html#a08d2374c81ae443f81f98910a948e334">VelDecr</a>;    <span class="comment">// [24d]</span>
<a name="l01149"></a>01149         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = RealVel - DeltaVel; <span class="comment">// [23e]</span>
<a name="l01150"></a>01150         <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = RealVel + DeltaVel;
<a name="l01151"></a>01151         
<a name="l01152"></a>01152         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>)
<a name="l01153"></a>01153         {
<a name="l01154"></a>01154                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>;
<a name="l01155"></a>01155                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a> + (DeltaVel &lt;&lt; 1);
<a name="l01156"></a>01156         }
<a name="l01157"></a>01157         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] &lt; -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>)
<a name="l01158"></a>01158         {
<a name="l01159"></a>01159                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>;
<a name="l01160"></a>01160                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a> + (DeltaVel &lt;&lt; 1);
<a name="l01161"></a>01161         }
<a name="l01162"></a>01162         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>)
<a name="l01163"></a>01163         {
<a name="l01164"></a>01164                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>;
<a name="l01165"></a>01165                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a> - (DeltaVel &lt;&lt; 1);
<a name="l01166"></a>01166         }
<a name="l01167"></a>01167         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] &lt; -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>)
<a name="l01168"></a>01168         {
<a name="l01169"></a>01169                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a>;
<a name="l01170"></a>01170                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = -<a class="code" href="ds_p_i_d33__definitions_8h.html#ad90cb3b44d70aefb64c15aa34081f4ce">MAX_ROT_SPEED</a> - (DeltaVel &lt;&lt; 1);
<a name="l01171"></a>01171         }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173         <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = Q15((<span class="keywordtype">float</span>)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>])/1000);       <span class="comment">// [23f]</span>
<a name="l01174"></a>01174         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[R] != <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>)
<a name="l01175"></a>01175         {
<a name="l01176"></a>01176                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>&gt;=0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[R] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>)
<a name="l01177"></a>01177                 {
<a name="l01178"></a>01178                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae7a3b2af5c19975de4291408ab4c9663">Ramp1</a> = Q15( <a class="code" href="ds_p_i_d33__definitions_8h.html#a09fc148003f20ecc4834d4ea6aefb15c">ACC</a>);
<a name="l01179"></a>01179                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11f69cd40c0277286560af950300bf05">RAMP_T_FLAG1</a> = 1;
<a name="l01180"></a>01180                 }
<a name="l01181"></a>01181                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>&gt;=0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[R] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>) 
<a name="l01182"></a>01182                 {
<a name="l01183"></a>01183                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae7a3b2af5c19975de4291408ab4c9663">Ramp1</a> = Q15(-<a class="code" href="ds_p_i_d33__definitions_8h.html#afe38ec6126e35e40049e27fdf4586ba5">DEC</a>);
<a name="l01184"></a>01184                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11f69cd40c0277286560af950300bf05">RAMP_T_FLAG1</a> = 0;
<a name="l01185"></a>01185                 }
<a name="l01186"></a>01186                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>&lt; 0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[R] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>) 
<a name="l01187"></a>01187                 {
<a name="l01188"></a>01188                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae7a3b2af5c19975de4291408ab4c9663">Ramp1</a> = Q15( <a class="code" href="ds_p_i_d33__definitions_8h.html#afe38ec6126e35e40049e27fdf4586ba5">DEC</a>);
<a name="l01189"></a>01189                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11f69cd40c0277286560af950300bf05">RAMP_T_FLAG1</a> = 1;
<a name="l01190"></a>01190                 }
<a name="l01191"></a>01191                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>&lt; 0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[R] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a>) 
<a name="l01192"></a>01192                 {
<a name="l01193"></a>01193                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae7a3b2af5c19975de4291408ab4c9663">Ramp1</a> = Q15(-<a class="code" href="ds_p_i_d33__definitions_8h.html#a09fc148003f20ecc4834d4ea6aefb15c">ACC</a>);
<a name="l01194"></a>01194                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11f69cd40c0277286560af950300bf05">RAMP_T_FLAG1</a> = 0;
<a name="l01195"></a>01195                 }
<a name="l01196"></a>01196                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdb5ebd40a9d20e527a8a08e50af4409">RAMP_FLAG1</a> = 1; <span class="comment">// acceleration ramp start</span>
<a name="l01197"></a>01197         }       
<a name="l01198"></a>01198                 
<a name="l01199"></a>01199         <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = Q15((<span class="keywordtype">float</span>)(<a class="code" href="ds_p_i_d33__definitions_8h.html#a8ad9961659ac5a8d36319e6691cb95d3">VelDes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>])/1000);
<a name="l01200"></a>01200         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[L] != <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>)
<a name="l01201"></a>01201         {
<a name="l01202"></a>01202                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>&gt;=0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[L] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>)
<a name="l01203"></a>01203                 {
<a name="l01204"></a>01204                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0d6520657b638a94231ea1c784b05101">Ramp2</a> = Q15( <a class="code" href="ds_p_i_d33__definitions_8h.html#a09fc148003f20ecc4834d4ea6aefb15c">ACC</a>);
<a name="l01205"></a>01205                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadbe0f0a0d2c2db9398c365fabc0d5c7">RAMP_T_FLAG2</a> = 1;
<a name="l01206"></a>01206                 }
<a name="l01207"></a>01207                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>&gt;=0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[L] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>) 
<a name="l01208"></a>01208                 {
<a name="l01209"></a>01209                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0d6520657b638a94231ea1c784b05101">Ramp2</a> = Q15(-<a class="code" href="ds_p_i_d33__definitions_8h.html#afe38ec6126e35e40049e27fdf4586ba5">DEC</a>);
<a name="l01210"></a>01210                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadbe0f0a0d2c2db9398c365fabc0d5c7">RAMP_T_FLAG2</a> = 0;
<a name="l01211"></a>01211                 }
<a name="l01212"></a>01212                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>&lt; 0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[L] &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>) 
<a name="l01213"></a>01213                 {
<a name="l01214"></a>01214                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0d6520657b638a94231ea1c784b05101">Ramp2</a> = Q15( <a class="code" href="ds_p_i_d33__definitions_8h.html#afe38ec6126e35e40049e27fdf4586ba5">DEC</a>);
<a name="l01215"></a>01215                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadbe0f0a0d2c2db9398c365fabc0d5c7">RAMP_T_FLAG2</a> = 1;
<a name="l01216"></a>01216                 }
<a name="l01217"></a>01217                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>&lt; 0 &amp;&amp; <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[L] &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a>) 
<a name="l01218"></a>01218                 {
<a name="l01219"></a>01219                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0d6520657b638a94231ea1c784b05101">Ramp2</a> = Q15(-<a class="code" href="ds_p_i_d33__definitions_8h.html#a09fc148003f20ecc4834d4ea6aefb15c">ACC</a>);
<a name="l01220"></a>01220                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadbe0f0a0d2c2db9398c365fabc0d5c7">RAMP_T_FLAG2</a> = 0;
<a name="l01221"></a>01221                 }
<a name="l01222"></a>01222                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4aaf95d79a76519a4e96a4b83b7fd2f3">RAMP_FLAG2</a> = 1; <span class="comment">// acceleration ramp start</span>
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a6b240a37d541c2c2b128ff3f74a21a7f">01226</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a6b240a37d541c2c2b128ff3f74a21a7f">DeadReckoning</a>(<span class="keywordtype">void</span>)
<a name="l01227"></a>01227 {
<a name="l01239"></a>01239         <span class="keywordtype">float</span> CosNow;           <span class="comment">// current value for Cos</span>
<a name="l01240"></a>01240         <span class="keywordtype">float</span> SinNow;           <span class="comment">// current value for Sin</span>
<a name="l01241"></a>01241         <span class="keywordtype">float</span> DSpace;           <span class="comment">// delta traveled distance by the robot</span>
<a name="l01242"></a>01242         <span class="keywordtype">float</span> DTheta;           <span class="comment">// delta rotation angle</span>
<a name="l01243"></a>01243         <span class="keywordtype">float</span> DPosX;            <span class="comment">// delta space on X axis</span>
<a name="l01244"></a>01244         <span class="keywordtype">float</span> DPosY;            <span class="comment">// delta space on Y axis</span>
<a name="l01245"></a>01245         <span class="keywordtype">float</span> SaMinusSb;
<a name="l01246"></a>01246         <span class="keywordtype">float</span> SrPlusSl;
<a name="l01247"></a>01247         <span class="keywordtype">float</span> Radius;
<a name="l01248"></a>01248                                 
<a name="l01249"></a>01249         <a class="code" href="ds_p_i_d33__definitions_8h.html#a046ceb5294473f63ac9554e05db73dba">CYCLE1_FLAG</a>=0;
<a name="l01250"></a>01250                 
<a name="l01251"></a>01251         <a class="code" href="ds_p_i_d33__definitions_8h.html#a9cfd2f16e0172e5c73a1e5edc76892b6">Spmm</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]*<a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];       <span class="comment">// distance of right wheel in mm</span>
<a name="l01252"></a>01252         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 0;                          <span class="comment">// rest counter for the next misure</span>
<a name="l01253"></a>01253         <a class="code" href="ds_p_i_d33__definitions_8h.html#a9cfd2f16e0172e5c73a1e5edc76892b6">Spmm</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]*Ksp[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];       <span class="comment">// distance of left wheel in mm</span>
<a name="l01254"></a>01254         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 0;                          <span class="comment">// rest counter for the next misure</span>
<a name="l01255"></a>01255 
<a name="l01256"></a>01256 <span class="preprocessor">        #ifdef geographic                       // [22aa]</span>
<a name="l01257"></a>01257 <span class="preprocessor"></span>                SaMinusSb=<a class="code" href="ds_p_i_d33__definitions_8h.html#a9cfd2f16e0172e5c73a1e5edc76892b6">Spmm</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]-<a class="code" href="ds_p_i_d33__definitions_8h.html#a9cfd2f16e0172e5c73a1e5edc76892b6">Spmm</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l01258"></a>01258 <span class="preprocessor">        #else</span>
<a name="l01259"></a>01259 <span class="preprocessor"></span>                SaMinusSb=Spmm[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]-Spmm[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l01260"></a>01260 <span class="preprocessor">        #endif</span>
<a name="l01261"></a>01261 <span class="preprocessor"></span>        
<a name="l01262"></a>01262         SrPlusSl=Spmm[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]+Spmm[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l01263"></a>01263         <span class="keywordflow">if</span> (fabs(SaMinusSb) &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a849f7f047f6ef8d21c3250118469e183">SPMIN</a>)
<a name="l01264"></a>01264         {<span class="comment">// traveling in a nearly straight line [22a]</span>
<a name="l01265"></a>01265                 DSpace=Spmm[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l01266"></a>01266                 
<a name="l01267"></a>01267 <span class="preprocessor">                #ifdef geographic                       // [22aa]</span>
<a name="l01268"></a>01268 <span class="preprocessor"></span>                        DPosX=DSpace*<a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>;
<a name="l01269"></a>01269                         DPosY=DSpace*<a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>;
<a name="l01270"></a>01270 <span class="preprocessor">                #else</span>
<a name="l01271"></a>01271 <span class="preprocessor"></span>                        DPosX=DSpace*<a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>;
<a name="l01272"></a>01272                         DPosY=DSpace*<a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>;
<a name="l01273"></a>01273 <span class="preprocessor">                #endif</span>
<a name="l01274"></a>01274 <span class="preprocessor"></span>
<a name="l01275"></a>01275         }
<a name="l01276"></a>01276         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fabs(SrPlusSl) &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a849f7f047f6ef8d21c3250118469e183">SPMIN</a>)
<a name="l01277"></a>01277         {<span class="comment">// pivoting around vertical axis without translation [22a]</span>
<a name="l01278"></a>01278                 DTheta=SaMinusSb/<a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a>;
<a name="l01279"></a>01279                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>=fmodf((<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>+DTheta),<a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>);<span class="comment">//current orient. in 2PI range</span>
<a name="l01280"></a>01280                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>=cosf(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>); <span class="comment">// for the next cycle</span>
<a name="l01281"></a>01281                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>=sinf(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>);
<a name="l01282"></a>01282                 DPosX=0;
<a name="l01283"></a>01283                 DPosY=0;
<a name="l01284"></a>01284                 DSpace=0;
<a name="l01285"></a>01285         }
<a name="l01286"></a>01286         <span class="keywordflow">else</span>
<a name="l01287"></a>01287         {<span class="comment">// rounding a curve    </span>
<a name="l01288"></a>01288                 DTheta=SaMinusSb/<a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a>;
<a name="l01289"></a>01289                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>=fmodf((<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>+DTheta),<a class="code" href="ds_p_i_d33__definitions_8h.html#a4912c64aec0c943b7985db6cb61ff83a">TWOPI</a>);<span class="comment">//current orient. in 2PI range</span>
<a name="l01290"></a>01290                 CosNow=cosf(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>);
<a name="l01291"></a>01291                 SinNow=sinf(<a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a>);
<a name="l01292"></a>01292                 DSpace=SrPlusSl/2;
<a name="l01293"></a>01293                 Radius = (<a class="code" href="ds_p_i_d33__definitions_8h.html#a7bce650326fb4f77339ecdcfd3d4e493">SemiAxle</a>)*(SrPlusSl/SaMinusSb);
<a name="l01294"></a>01294                 
<a name="l01295"></a>01295 <span class="preprocessor">                #ifdef geographic                       // [22aa]</span>
<a name="l01296"></a>01296 <span class="preprocessor"></span>                        DPosX=Radius*(<a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>-CosNow);  
<a name="l01297"></a>01297                         DPosY=Radius*(SinNow-<a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>);
<a name="l01298"></a>01298 <span class="preprocessor">                #else</span>
<a name="l01299"></a>01299 <span class="preprocessor"></span>                        DPosX=Radius*(SinNow-<a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>);
<a name="l01300"></a>01300                         DPosY=Radius*(<a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>-CosNow);
<a name="l01301"></a>01301 <span class="preprocessor">                #endif          </span>
<a name="l01302"></a>01302 <span class="preprocessor"></span>
<a name="l01303"></a>01303                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a389fe7477c4f411d4d2bb905e0c99b81">CosPrev</a>=CosNow;         <span class="comment">// to avoid re-calculation on the next cycle</span>
<a name="l01304"></a>01304                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a15d3c39d949717a1bde398ea4962eb02">SinPrev</a>=SinNow;
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <a class="code" href="ds_p_i_d33__definitions_8h.html#a2cec7b5a30f7f3b78c8d5dbddf4c7423">Space</a> += DSpace;        <span class="comment">// total traveled distance</span>
<a name="l01308"></a>01308         <a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a> += DPosX;       <span class="comment">// current position</span>
<a name="l01309"></a>01309         <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a> += DPosY;
<a name="l01310"></a>01310         
<a name="l01311"></a>01311         <a class="code" href="ds_p_i_d33_8c.html#a93a4744b15d7f3cfa5b61e4141ec50f3">Slam</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>, <a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>, 2); <span class="comment">// mark a presence in this position cell</span>
<a name="l01312"></a>01312 
<a name="l01313"></a>01313         <a class="code" href="ds_p_i_d33__definitions_8h.html#a30e68f049d4b4acf8f80003200ea854e">ORIENTATION_FLAG</a> = 1; <span class="comment">// position coordinates computed, Angle PID can start</span>
<a name="l01314"></a>01314 }
<a name="l01315"></a>01315 
<a name="l01316"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a93a4744b15d7f3cfa5b61e4141ec50f3">01316</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ds_p_i_d33_8c.html#a93a4744b15d7f3cfa5b61e4141ec50f3">Slam</a>(<span class="keywordtype">float</span> PosX, <span class="keywordtype">float</span> PosY, <span class="keywordtype">int</span> Cell)
<a name="l01317"></a>01317 {
<a name="l01330"></a>01330         <a class="code" href="structnibble.html">nibble</a> CellValue;       <span class="comment">// field map value of current cell </span>
<a name="l01331"></a>01331         <span class="keywordtype">int</span> Xpoint;     <span class="comment">// X coordinate value normalized in matrix range </span>
<a name="l01332"></a>01332         <span class="keywordtype">int</span> Ypoint;     <span class="comment">// Y index  </span>
<a name="l01333"></a>01333 <span class="comment">/*  Field shifting still developing  </span>
<a name="l01334"></a>01334 <span class="comment">        int OldPoint; // temp for previous field boundaries</span>
<a name="l01335"></a>01335 <span class="comment">        int TempIndx;</span>
<a name="l01336"></a>01336 <span class="comment">*/</span>      
<a name="l01337"></a>01337         <span class="comment">// field mapping [22b]</span>
<a name="l01338"></a>01338         <span class="comment">// index in the range 0-Y_SIZE to point the matrix</span>
<a name="l01339"></a>01339         Xpoint=<a class="code" href="ds_p_i_d33_8c.html#a3a90a7ce8d2eab466a689d41c5f0749c">PosIndx</a>(PosX);
<a name="l01340"></a>01340         Ypoint=<a class="code" href="ds_p_i_d33_8c.html#a3a90a7ce8d2eab466a689d41c5f0749c">PosIndx</a>(PosY);
<a name="l01341"></a>01341         
<a name="l01342"></a>01342         <span class="keywordflow">if</span> (PosX &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a953f0a426af0d3698999c0cea37f4be0">MaxMapX</a>)    
<a name="l01343"></a>01343         {
<a name="l01344"></a>01344                 Xpoint = <a class="code" href="ds_p_i_d33__definitions_8h.html#acf7323c7a26a48b48deebce4d31f261e">X_POINT_MAX</a>;
<a name="l01345"></a>01345         }
<a name="l01346"></a>01346         <span class="comment">/* [22e] Field shifting still developing       </span>
<a name="l01347"></a>01347 <span class="comment">        {// compute the next cell beyond old boundary modulus MAP_SIZE</span>
<a name="l01348"></a>01348 <span class="comment">                OldPoint=abs((__builtin_modsd((MaxMapX+HALF_MAP_SIZE),MAP_SIZE))</span>
<a name="l01349"></a>01349 <span class="comment">                        /CELL_SIZE);</span>
<a name="l01350"></a>01350 <span class="comment">                MaxMapX = PosX;</span>
<a name="l01351"></a>01351 <span class="comment">                MinMapX = MaxMapX - MAP_SIZE;</span>
<a name="l01352"></a>01352 <span class="comment">                Xshift = Xpoint + 1; // [22g]</span>
<a name="l01353"></a>01353 <span class="comment">                for (i=OldPoint; i&lt;=Xpoint; i++)</span>
<a name="l01354"></a>01354 <span class="comment">                {</span>
<a name="l01355"></a>01355 <span class="comment">                        for (TempIndx=0; TempIndx&lt;Y_SIZE; TempIndx++)</span>
<a name="l01356"></a>01356 <span class="comment">                        {// purge the translated portion of the field   </span>
<a name="l01357"></a>01357 <span class="comment">                                SetMap(Xpoint, Ypoint, 0);</span>
<a name="l01358"></a>01358 <span class="comment">                        }</span>
<a name="l01359"></a>01359 <span class="comment">                }</span>
<a name="l01360"></a>01360 <span class="comment">        }</span>
<a name="l01361"></a>01361 <span class="comment">        */</span>
<a name="l01362"></a>01362         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PosX &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#abf307788495a57ca41c34d6d2ea0ad15">MinMapX</a>)
<a name="l01363"></a>01363         {
<a name="l01364"></a>01364                  Xpoint = <a class="code" href="ds_p_i_d33__definitions_8h.html#a09631c0b7f27139c9a5c3e4dcd34a1be">X_POINT_MIN</a>;
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366         <span class="comment">/* [22e] Field shifting still developing       </span>
<a name="l01367"></a>01367 <span class="comment">        {// compute the previous cell behind old boundary modulus MAP_SIZE</span>
<a name="l01368"></a>01368 <span class="comment">                OldPoint=abs((__builtin_modsd((MaxMapX+(HALF_MAP_SIZE)-CELL_SIZE),</span>
<a name="l01369"></a>01369 <span class="comment">                        (MAP_SIZE)))/CELL_SIZE);</span>
<a name="l01370"></a>01370 <span class="comment">                MinMapX = PosX;</span>
<a name="l01371"></a>01371 <span class="comment">                MaxMapX = MinMapX + MAP_SIZE;</span>
<a name="l01372"></a>01372 <span class="comment">                Xshift = -Xpoint; // [22g]</span>
<a name="l01373"></a>01373 <span class="comment">                for (i=OldPoint; i&gt;=Xpoint; i--)</span>
<a name="l01374"></a>01374 <span class="comment">                {</span>
<a name="l01375"></a>01375 <span class="comment">                        for (TempIndx=0; TempIndx&lt;Y_SIZE; TempIndx++)</span>
<a name="l01376"></a>01376 <span class="comment">                        {// purge the translated portion of the field   </span>
<a name="l01377"></a>01377 <span class="comment">                                SetMap(Xpoint, Ypoint, 0);</span>
<a name="l01378"></a>01378 <span class="comment">                        }</span>
<a name="l01379"></a>01379 <span class="comment">                }</span>
<a name="l01380"></a>01380 <span class="comment">        }</span>
<a name="l01381"></a>01381 <span class="comment">        */</span>
<a name="l01382"></a>01382         
<a name="l01383"></a>01383         <span class="keywordflow">if</span> (PosY &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a9ece05884621b9aee234a496f6ba5ad8">MaxMapY</a>)
<a name="l01384"></a>01384         {
<a name="l01385"></a>01385                 Ypoint = <a class="code" href="ds_p_i_d33__definitions_8h.html#a4b4a0272c6ea0bf2f30bfb98c3ca586e">Y_POINT_MAX</a>;
<a name="l01386"></a>01386         }
<a name="l01387"></a>01387         <span class="comment">/* [22e] Field shifting still developing       </span>
<a name="l01388"></a>01388 <span class="comment">        {// compute the next cell beyond old boundary modulus MAP_SIZE</span>
<a name="l01389"></a>01389 <span class="comment">                OldPoint=abs((__builtin_modsd((MaxMapY+HALF_MAP_SIZE),MAP_SIZE))</span>
<a name="l01390"></a>01390 <span class="comment">                        /CELL_SIZE);</span>
<a name="l01391"></a>01391 <span class="comment">                MaxMapY = PosY;</span>
<a name="l01392"></a>01392 <span class="comment">                MinMapY = MaxMapY - MAP_SIZE;</span>
<a name="l01393"></a>01393 <span class="comment">                Yshift = Ypoint + 1; // [22g]</span>
<a name="l01394"></a>01394 <span class="comment">                for (i=OldPoint; i&lt;=Ypoint; i++)</span>
<a name="l01395"></a>01395 <span class="comment">                {</span>
<a name="l01396"></a>01396 <span class="comment">                        for (TempIndx=0; TempIndx&lt;X_SIZE; TempIndx++)</span>
<a name="l01397"></a>01397 <span class="comment">                        {// purge the translated portion of the field   </span>
<a name="l01398"></a>01398 <span class="comment">                                SetMap(Xpoint, Ypoint, 0);</span>
<a name="l01399"></a>01399 <span class="comment">                        }</span>
<a name="l01400"></a>01400 <span class="comment">                }</span>
<a name="l01401"></a>01401 <span class="comment">        }</span>
<a name="l01402"></a>01402 <span class="comment">        */</span>
<a name="l01403"></a>01403         
<a name="l01404"></a>01404         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PosY &lt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a4df14d9707fa7c05417a073afdea8b6f">MinMapY</a>)
<a name="l01405"></a>01405         {
<a name="l01406"></a>01406                 Ypoint =  <a class="code" href="ds_p_i_d33__definitions_8h.html#ac1bb0712b803de79cf3348d070eaac5d">Y_POINT_MIN</a>;
<a name="l01407"></a>01407         }
<a name="l01408"></a>01408         <span class="comment">/* [22e] Field shifting still developing       </span>
<a name="l01409"></a>01409 <span class="comment">        {// compute the previous cell behind old boundary modulus MAP_SIZE</span>
<a name="l01410"></a>01410 <span class="comment">                OldPoint=abs((__builtin_modsd((MaxMapY+(HALF_MAP_SIZE)-CELL_SIZE),</span>
<a name="l01411"></a>01411 <span class="comment">                        (MAP_SIZE)))/CELL_SIZE);</span>
<a name="l01412"></a>01412 <span class="comment">                MinMapY = PosY;</span>
<a name="l01413"></a>01413 <span class="comment">                MaxMapY = MinMapY + MAP_SIZE;</span>
<a name="l01414"></a>01414 <span class="comment">                Yshift = -Ypoint; // [22g]</span>
<a name="l01415"></a>01415 <span class="comment">                for (i=OldPoint; i&gt;=Ypoint; i--)</span>
<a name="l01416"></a>01416 <span class="comment">                {</span>
<a name="l01417"></a>01417 <span class="comment">                        for (TempIndx=0; TempIndx&lt;X_SIZE; TempIndx++)</span>
<a name="l01418"></a>01418 <span class="comment">                        {// purge the translated portion of the field   </span>
<a name="l01419"></a>01419 <span class="comment">                                SetMap(Xpoint, Ypoint, 0);</span>
<a name="l01420"></a>01420 <span class="comment">                        }</span>
<a name="l01421"></a>01421 <span class="comment">                }</span>
<a name="l01422"></a>01422 <span class="comment">        }</span>
<a name="l01423"></a>01423 <span class="comment">        */</span>
<a name="l01424"></a>01424         
<a name="l01425"></a>01425         CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>=<a class="code" href="ds_p_i_d33_8c.html#a0045cdba351669e55136652c9b95b39b">GetMap</a>(Xpoint, Ypoint);
<a name="l01426"></a>01426 
<a name="l01427"></a>01427         <span class="keywordflow">if</span> ((Xpoint != <a class="code" href="ds_p_i_d33__definitions_8h.html#ad2cc89785e23c93e7d759c2ec0fbe495">XindxPrev</a>) || (Ypoint != <a class="code" href="ds_p_i_d33__definitions_8h.html#a569c865cad748d30080b4324a7ee03d2">YindxPrev</a>))<span class="comment">//only when cell changes</span>
<a name="l01428"></a>01428         {       
<a name="l01429"></a>01429                 <span class="keywordflow">switch</span> (Cell) <span class="comment">// [22d]</span>
<a name="l01430"></a>01430                 {
<a name="l01431"></a>01431                         <span class="keywordflow">case</span> 1:
<a name="l01432"></a>01432                                 <span class="keywordflow">if</span> (CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>&lt;7)
<a name="l01433"></a>01433                                 {
<a name="l01434"></a>01434                                         CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>++;
<a name="l01435"></a>01435                                 }
<a name="l01436"></a>01436                         <span class="keywordflow">break</span>;
<a name="l01437"></a>01437                         
<a name="l01438"></a>01438                         <span class="keywordflow">case</span> 2: 
<a name="l01439"></a>01439                                 <span class="keywordflow">if</span> (CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>&lt;8)<span class="comment">// this overrides obstacle info</span>
<a name="l01440"></a>01440                                 {
<a name="l01441"></a>01441                                         CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a> = 8;
<a name="l01442"></a>01442                                 }
<a name="l01443"></a>01443                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>&lt;10)
<a name="l01444"></a>01444                                 {
<a name="l01445"></a>01445                                         CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>++;
<a name="l01446"></a>01446                                 }
<a name="l01447"></a>01447                         <span class="keywordflow">break</span>;
<a name="l01448"></a>01448                         
<a name="l01449"></a>01449                         <span class="keywordflow">case</span> 5: <span class="comment">// gas</span>
<a name="l01450"></a>01450                                 CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a> = 12;
<a name="l01451"></a>01451                         <span class="keywordflow">break</span>;
<a name="l01452"></a>01452                         
<a name="l01453"></a>01453                         <span class="keywordflow">case</span> 6: <span class="comment">// light</span>
<a name="l01454"></a>01454                                 CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a> = 13;
<a name="l01455"></a>01455                         <span class="keywordflow">break</span>;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457                         <span class="keywordflow">case</span> 7: <span class="comment">// sound</span>
<a name="l01458"></a>01458                                 CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a> = 14;
<a name="l01459"></a>01459                         <span class="keywordflow">break</span>;
<a name="l01460"></a>01460                 }
<a name="l01461"></a>01461         
<a name="l01462"></a>01462                 <a class="code" href="ds_p_i_d33_8c.html#a8629237a76431df1ef42e9b58ccae312">SetMap</a>(Xpoint, Ypoint, &amp;CellValue);
<a name="l01463"></a>01463                 
<a name="l01464"></a>01464                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ad2cc89785e23c93e7d759c2ec0fbe495">XindxPrev</a>=Xpoint;
<a name="l01465"></a>01465                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a569c865cad748d30080b4324a7ee03d2">YindxPrev</a>=Ypoint;               
<a name="l01466"></a>01466         }
<a name="l01467"></a>01467         
<a name="l01468"></a>01468         <span class="keywordflow">return</span> CellValue.<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>;
<a name="l01469"></a>01469 }
<a name="l01470"></a>01470 
<a name="l01471"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a3a90a7ce8d2eab466a689d41c5f0749c">01471</a> <span class="keywordtype">int</span> <a class="code" href="ds_p_i_d33_8c.html#a3a90a7ce8d2eab466a689d41c5f0749c">PosIndx</a>(<span class="keywordtype">float</span> Pos)
<a name="l01472"></a>01472 {
<a name="l01483"></a>01483         <span class="comment">// index in the range 0-Y_SIZE to point the matrix</span>
<a name="l01484"></a>01484         <span class="keywordtype">int</span> Indx;
<a name="l01485"></a>01485         Indx=abs((__builtin_modsd((Pos+(<a class="code" href="ds_p_i_d33__definitions_8h.html#a3a4e66778ea0f1c0feb0f6c17efd244b">HALF_MAP_SIZE</a>)),(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0a82fd70402bbdc2259248e735fecbca">MAP_SIZE</a>)))/<a class="code" href="ds_p_i_d33__definitions_8h.html#a7a4127f14f16563da90eb3c836bc404f">CELL_SIZE</a>);        
<a name="l01486"></a>01486         <span class="keywordflow">return</span> Indx;
<a name="l01487"></a>01487 }       
<a name="l01488"></a>01488         
<a name="l01489"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a0045cdba351669e55136652c9b95b39b">01489</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="ds_p_i_d33_8c.html#a0045cdba351669e55136652c9b95b39b">GetMap</a>(<span class="keywordtype">int</span> Xpnt, <span class="keywordtype">int</span> Ypnt) 
<a name="l01490"></a>01490 {
<a name="l01500"></a>01500         <span class="keywordtype">int</span> XindxH;     <span class="comment">// High part of X index </span>
<a name="l01501"></a>01501         <span class="keywordtype">int</span> XindxL;     <span class="comment">// Low part  of X index </span>
<a name="l01502"></a>01502         div_t z;        <span class="comment">// for div function</span>
<a name="l01503"></a>01503         
<a name="l01504"></a>01504         <span class="comment">//X index in range 0-X_SIZE (H) and remainder 0-(VAR_PER_BYTE-1) (L)</span>
<a name="l01505"></a>01505         z=div(Xpnt,<a class="code" href="ds_p_i_d33__definitions_8h.html#ac3603bc0f137fed38b53f795148128f9">VAR_PER_BYTE</a>);
<a name="l01506"></a>01506         XindxH=z.quot; <span class="comment">// main index</span>
<a name="l01507"></a>01507         XindxL=z.rem;  <span class="comment">// sub-index</span>
<a name="l01508"></a>01508 
<a name="l01509"></a>01509         <span class="keywordflow">if</span>(XindxL==0)
<a name="l01510"></a>01510         {
<a name="l01511"></a>01511                 <span class="keywordflow">return</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adb43804a231f49b4dbd9fe480d4083ab">MapXY</a>[XindxH][Ypnt].TN.<a class="code" href="union_packed_bit.html#aaaa2ae4b03d0be31bd341ab6691fcae8">nib0</a>);
<a name="l01512"></a>01512         }
<a name="l01513"></a>01513         <span class="keywordflow">else</span>
<a name="l01514"></a>01514         {       
<a name="l01515"></a>01515                 <span class="keywordflow">return</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#adb43804a231f49b4dbd9fe480d4083ab">MapXY</a>[XindxH][Ypnt].TN.<a class="code" href="union_packed_bit.html#a148dbf54820ce62b65499bf542e2bdf0">nib1</a>);
<a name="l01516"></a>01516         }
<a name="l01517"></a>01517 }
<a name="l01518"></a>01518 
<a name="l01519"></a><a class="code" href="ds_p_i_d33__definitions_8h.html#a8629237a76431df1ef42e9b58ccae312">01519</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a8629237a76431df1ef42e9b58ccae312">SetMap</a>(<span class="keywordtype">int</span> Xpnt, <span class="keywordtype">int</span> Ypnt, <a class="code" href="structnibble.html">nibble</a> *CellVal) 
<a name="l01520"></a>01520 {
<a name="l01529"></a>01529         <span class="keywordtype">int</span> XindxH;     <span class="comment">// High part of X index </span>
<a name="l01530"></a>01530         <span class="keywordtype">int</span> XindxL;     <span class="comment">// Low part  of X index </span>
<a name="l01531"></a>01531         div_t z;        <span class="comment">// for div function</span>
<a name="l01532"></a>01532         
<a name="l01533"></a>01533         <span class="comment">//X index in range 0-X_SIZE (H) and remainder 0-(VAR_PER_BYTE-1) (L)</span>
<a name="l01534"></a>01534         z=div(Xpnt,<a class="code" href="ds_p_i_d33__definitions_8h.html#ac3603bc0f137fed38b53f795148128f9">VAR_PER_BYTE</a>);
<a name="l01535"></a>01535         XindxH=z.quot; <span class="comment">// main index</span>
<a name="l01536"></a>01536         XindxL=z.rem;  <span class="comment">// sub-index</span>
<a name="l01537"></a>01537 
<a name="l01538"></a>01538         <span class="keywordflow">if</span>(XindxL==0)
<a name="l01539"></a>01539         {
<a name="l01540"></a>01540                 <a class="code" href="ds_p_i_d33__definitions_8h.html#adb43804a231f49b4dbd9fe480d4083ab">MapXY</a>[XindxH][Ypnt].<a class="code" href="union_packed_bit.html#aa8fe50ef8d182e8d8d1a227b2d980bd3">TN</a>.<a class="code" href="union_packed_bit.html#aaaa2ae4b03d0be31bd341ab6691fcae8">nib0</a> = CellVal-&gt;<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>;
<a name="l01541"></a>01541         }
<a name="l01542"></a>01542         <span class="keywordflow">else</span>
<a name="l01543"></a>01543         {       
<a name="l01544"></a>01544                 <a class="code" href="ds_p_i_d33__definitions_8h.html#adb43804a231f49b4dbd9fe480d4083ab">MapXY</a>[XindxH][Ypnt].<a class="code" href="union_packed_bit.html#aa8fe50ef8d182e8d8d1a227b2d980bd3">TN</a>.<a class="code" href="union_packed_bit.html#a148dbf54820ce62b65499bf542e2bdf0">nib1</a> = CellVal-&gt;<a class="code" href="structnibble.html#a1fc4ff3d24d6dbfe9b7f3ce789253dcc">nib</a>;
<a name="l01545"></a>01545         }
<a name="l01546"></a>01546 }
<a name="l01547"></a>01547 
<a name="l01548"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a34596661a2aeffb291f62a3e962dc159">01548</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a34596661a2aeffb291f62a3e962dc159">ConstantsDefaultW</a> (<span class="keywordtype">void</span>)
<a name="l01549"></a>01549 {
<a name="l01555"></a>01555 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(401,<a class="code" href="ds_p_i_d33__definitions_8h.html#a30eb60bbf768c306838dc3c61bc20b6a">EE_KVEL1_H</a>);
<a name="l01556"></a>01556 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(10405,<a class="code" href="ds_p_i_d33__definitions_8h.html#a24c62e95b3d61ec5610cefa6c6b9c9bf">EE_KVEL1_L</a>);
<a name="l01557"></a>01557 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(401,<a class="code" href="ds_p_i_d33__definitions_8h.html#aa6db32bf36392fea216d6333f582b8b7">EE_KVEL2_H</a>);
<a name="l01558"></a>01558 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(10405,<a class="code" href="ds_p_i_d33__definitions_8h.html#a5a0c7445850a7855d6a3ddfac4974d33">EE_KVEL2_L</a>);
<a name="l01559"></a>01559 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(9999,<a class="code" href="ds_p_i_d33__definitions_8h.html#a9b9f409a9bc869aafbde19885b8326a5">EE_ANGLE_KP</a>);  
<a name="l01560"></a>01560 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(8000,<a class="code" href="ds_p_i_d33__definitions_8h.html#ad14fda74b8128e7250c1f3abd929aade">EE_ANGLE_KI</a>);          
<a name="l01561"></a>01561 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(0001,<a class="code" href="ds_p_i_d33__definitions_8h.html#af52df92bd4d7c249255e6312108ee544">EE_ANGLE_KD</a>);
<a name="l01562"></a>01562 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(9999,<a class="code" href="ds_p_i_d33__definitions_8h.html#a537065f445575f12000147ac6c8d8584">EE_DIST_KP</a>);   
<a name="l01563"></a>01563 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(8000,<a class="code" href="ds_p_i_d33__definitions_8h.html#aa8af7e82a7307586c9d7b9f13766fe14">EE_DIST_KI</a>);           
<a name="l01564"></a>01564 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(0001,<a class="code" href="ds_p_i_d33__definitions_8h.html#a3cb4d269dc361abbdfe41a3de7a33e47">EE_DIST_KD</a>);
<a name="l01565"></a>01565 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(6000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c55ea3d3f295e10bfa3cc68f46b725b">EE_KP1</a>);
<a name="l01566"></a>01566 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(7000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a7d688f68ec4bb55d1e7c7635e9a4eced">EE_KI1</a>);
<a name="l01567"></a>01567 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(1000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a36bbd3d80231c2983c91dba3d8f03597">EE_KD1</a>);
<a name="l01568"></a>01568 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(6000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a44be0fb106e81ceb006673c95286b31e">EE_KP2</a>);
<a name="l01569"></a>01569 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(7000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a30f71dda0d2f653b8352e09f2ab4c31d">EE_KI2</a>);
<a name="l01570"></a>01570 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(1000,<a class="code" href="ds_p_i_d33__definitions_8h.html#a683b81d63101ce00ecfb414dc1e28193">EE_KD2</a>);
<a name="l01571"></a>01571 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(77,<a class="code" href="ds_p_i_d33__definitions_8h.html#a17f833fda13a712b1a1f519656878bdf">EE_KSP1_H</a>);
<a name="l01572"></a>01572 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(15183,<a class="code" href="ds_p_i_d33__definitions_8h.html#a76b24bd1c5b96fff7a8dc81a8757e47b">EE_KSP1_L</a>);
<a name="l01573"></a>01573 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(77,<a class="code" href="ds_p_i_d33__definitions_8h.html#abc091fd5685b28694aaaa20b337e7c08">EE_KSP2_H</a>);
<a name="l01574"></a>01574 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(15183,<a class="code" href="ds_p_i_d33__definitions_8h.html#a587522af961f06270208e2bb30532856">EE_KSP2_L</a>);
<a name="l01575"></a>01575 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(28,<a class="code" href="ds_p_i_d33__definitions_8h.html#a7dde2efdd67544d00f8b30c3f755b779">EE_AXLE_H</a>);
<a name="l01576"></a>01576 <a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#a4879a0fb15f6366cfcfbbc378c10ebb1">DataEEWrite</a>(17214,<a class="code" href="ds_p_i_d33__definitions_8h.html#a7df2d5424fb36a3fc7e585a23b830825">EE_AXLE_L</a>);
<a name="l01577"></a>01577 }
<a name="l01578"></a>01578 
<a name="l01579"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#ab669afd78797b214c6763669fed53959">01579</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#ab669afd78797b214c6763669fed53959">ConstantsDefaultR</a> (<span class="keywordtype">void</span>)
<a name="l01580"></a>01580 {
<a name="l01586"></a>01586 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa3921b5835fead737e5bf98dbebf4fde">ANGLE_KP</a>=Q15(0.9999);   
<a name="l01587"></a>01587 <a class="code" href="ds_p_i_d33__definitions_8h.html#ad3c6108576a8c14dc64cf980dcbeaa07">ANGLE_KI</a>=Q15(0.7);              
<a name="l01588"></a>01588 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ac275be5870eac565e6abe883f71027">ANGLE_KD</a>=Q15(0.0001);   
<a name="l01589"></a>01589 
<a name="l01590"></a>01590 <span class="comment">// KP, KI, KD x Distance PID in fractional</span>
<a name="l01591"></a>01591 <span class="comment">// fractional, 3 x 2 = 6 bytes</span>
<a name="l01592"></a>01592 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6eb9abd4c03c2bb9858333427ffc082b">DIST_KP</a>=Q15(0.9999);            
<a name="l01593"></a>01593 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9921840de098c5213a3e8a70a5d79434">DIST_KI</a>=Q15(0.8);       
<a name="l01594"></a>01594 <a class="code" href="ds_p_i_d33__definitions_8h.html#ab8c0a30e2075f94c9f5e9b6a8e08a94f">DIST_KD</a>=Q15(0.0001);    
<a name="l01595"></a>01595 
<a name="l01596"></a>01596 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08ed89f1b0686fbf5973ae9e6c421da9">KP1</a>=Q15(0.9);
<a name="l01597"></a>01597 <a class="code" href="ds_p_i_d33__definitions_8h.html#a11c4319254dbf2d15e4e190458953ea1">KI1</a>=Q15(0.7);
<a name="l01598"></a>01598 <a class="code" href="ds_p_i_d33__definitions_8h.html#a62dfed7b72614c5259d58b3f114ab855">KD1</a>=Q15(0.1);
<a name="l01599"></a>01599 <a class="code" href="ds_p_i_d33__definitions_8h.html#a85e592792070b44b414d998f7c72c961">KP2</a>=Q15(0.9);
<a name="l01600"></a>01600 <a class="code" href="ds_p_i_d33__definitions_8h.html#a35bbf7801d6af7dbbd7136bd9a5cd396">KI2</a>=Q15(0.7);
<a name="l01601"></a>01601 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa14141a3768da78340e7bac812e21959">KD2</a>=Q15(0.1);           
<a name="l01602"></a>01602 
<a name="l01603"></a>01603 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 26555230; <span class="comment">// x 1 value</span>
<a name="l01604"></a>01604 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 26487032; 
<a name="l01605"></a>01605 
<a name="l01606"></a>01606 <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 0.005065008;
<a name="l01607"></a>01607 <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 0.0050520;
<a name="l01608"></a>01608 <a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a> = 184.8728;
<a name="l01609"></a>01609         
<a name="l01610"></a>01610 <a class="code" href="ds_p_i_d33__definitions_8h.html#a7bce650326fb4f77339ecdcfd3d4e493">SemiAxle</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a>/2;
<a name="l01611"></a>01611 }
<a name="l01612"></a>01612 
<a name="l01613"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a4bf5ff5b210e31e4eae6f4a71d85f669">01613</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>(<span class="keywordtype">void</span>)
<a name="l01614"></a>01614 {
<a name="l01618"></a>01618         <a class="code" href="com_8h.html#a9c9d42cf8b66102e2b24a182594f6211">BlinkPeriod</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a03700e966880fcf8b29ba4c0a87510cf">K_ERR_BLINK_PER</a>;<span class="comment">// LED1 blinking period (ms)</span>
<a name="l01619"></a>01619         <a class="code" href="com_8h.html#abd61f9304bb5c6902bc8b45a818e2f87">BlinkOn</a>     = <a class="code" href="ds_p_i_d33__definitions_8h.html#a5a0a14e11851ac5f1f0a56ba781fd023">K_ERR_BLINK_ON</a>; <span class="comment">// LED1 on time (ms)</span>
<a name="l01620"></a>01620         <a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> = 0;
<a name="l01621"></a>01621         <a class="code" href="com_8h.html#a32e48d54597556ccd285249131884184">ErrCode</a>=-20;                              <span class="comment">// store the last Error Code</span>
<a name="l01622"></a>01622         <a class="code" href="ds_p_i_d33_8c.html#ab669afd78797b214c6763669fed53959">ConstantsDefaultR</a>();              <span class="comment">// use default parameters</span>
<a name="l01623"></a>01623 }
<a name="l01624"></a>01624 
<a name="l01625"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#aba1cd658ed9e0945ba5953a07b3fe873">01625</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#aba1cd658ed9e0945ba5953a07b3fe873">ConstantsRead</a>(<span class="keywordtype">void</span>)
<a name="l01626"></a>01626 {
<a name="l01631"></a>01631 <span class="keywordtype">long</span> Tmp1Long;
<a name="l01632"></a>01632 <span class="keywordtype">long</span> Tmp2Long;
<a name="l01633"></a>01633 <span class="keywordtype">int</span> C1;                                 <span class="comment">// generic counter</span>
<a name="l01634"></a>01634 <span class="keywordtype">int</span> C2;
<a name="l01635"></a>01635 <span class="keywordtype">int</span> C3;
<a name="l01636"></a>01636 <span class="keywordtype">int</span> TmpChk;
<a name="l01637"></a>01637 
<a name="l01638"></a>01638 <span class="preprocessor">#ifdef NO_FLASH         // [34a]</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span><span class="preprocessor">#warning -- compiling with NO FLASH *************************************</span>
<a name="l01640"></a>01640 <span class="preprocessor"></span>        <a class="code" href="ds_p_i_d33_8c.html#ab669afd78797b214c6763669fed53959">ConstantsDefaultR</a>();
<a name="l01641"></a>01641         <span class="keywordflow">return</span>;
<a name="l01642"></a>01642 <span class="preprocessor">#endif</span>
<a name="l01643"></a>01643 <span class="preprocessor"></span>
<a name="l01644"></a>01644 <span class="keywordflow">if</span> (<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c55ea3d3f295e10bfa3cc68f46b725b">EE_KP1</a>) == 0xFFFF) <span class="comment">// default values if not programmed</span>
<a name="l01645"></a>01645 {
<a name="l01646"></a>01646         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01647"></a>01647         <span class="keywordflow">return</span>;
<a name="l01648"></a>01648 }
<a name="l01649"></a>01649 
<a name="l01650"></a>01650 C3 = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7475c25cfc5dcc77e47927d4ab6bb08b">EE_SCHED</a>;  <span class="comment">// starting address for scheduler sequence storage</span>
<a name="l01651"></a>01651 TmpChk=0;
<a name="l01652"></a>01652 <span class="keywordflow">for</span> (C1=0; C1&lt;16; C1++)
<a name="l01653"></a>01653 {
<a name="l01654"></a>01654         <span class="keywordflow">for</span> (C2=0; C2&lt;4; C2++)
<a name="l01655"></a>01655         {
<a name="l01656"></a>01656                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[C1][C2]=(<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(C3));
<a name="l01657"></a>01657                 TmpChk+=<a class="code" href="ds_p_i_d33__definitions_8h.html#a831259b09f3c789ef0f6829623aa65e0">SchedValues</a>[C1][C2];
<a name="l01658"></a>01658                 C3 ++;
<a name="l01659"></a>01659         }
<a name="l01660"></a>01660 }
<a name="l01661"></a>01661 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0d4a4184349b3adbf8ce777a171cf3f0">EE_CHK_SCHED</a>))
<a name="l01662"></a>01662 {
<a name="l01663"></a>01663         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01664"></a>01664         <span class="keywordflow">return</span>;
<a name="l01665"></a>01665 }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667 <span class="comment">/* Speed calculation K in micron/second = 26290341 [4] [7] [19]</span>
<a name="l01668"></a>01668 <span class="comment">   Speed calculation K in m/s as a power of 2 to semplify dsPID elaboration</span>
<a name="l01669"></a>01669 <span class="comment">   Kvel[] = (K &lt;&lt; 15)</span>
<a name="l01670"></a>01670 <span class="comment">   long, 2 x 4 bytes = 8 byte</span>
<a name="l01671"></a>01671 <span class="comment">   Kvel[x] = 26290341;  x 1 value = 26290341  x 2 value = 13145171</span>
<a name="l01672"></a>01672 <span class="comment">*/</span>
<a name="l01673"></a>01673 Tmp1Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a30eb60bbf768c306838dc3c61bc20b6a">EE_KVEL1_H</a>);
<a name="l01674"></a>01674 TmpChk=Tmp1Long;
<a name="l01675"></a>01675 Tmp2Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a24c62e95b3d61ec5610cefa6c6b9c9bf">EE_KVEL1_L</a>);
<a name="l01676"></a>01676 TmpChk+=Tmp2Long;
<a name="l01677"></a>01677 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = ((Tmp1Long &lt;&lt; 16) + Tmp2Long);
<a name="l01678"></a>01678 Tmp1Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#aa6db32bf36392fea216d6333f582b8b7">EE_KVEL2_H</a>);
<a name="l01679"></a>01679 TmpChk+=Tmp1Long;
<a name="l01680"></a>01680 Tmp2Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a5a0c7445850a7855d6a3ddfac4974d33">EE_KVEL2_L</a>);
<a name="l01681"></a>01681 TmpChk+=Tmp2Long;
<a name="l01682"></a>01682 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = ((Tmp1Long &lt;&lt; 16) + Tmp2Long);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#abfff75987b4efe2306c6d7dd3db42e91">EE_CHK_KVEL</a>))
<a name="l01685"></a>01685 {
<a name="l01686"></a>01686         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01687"></a>01687         <span class="keywordflow">return</span>;
<a name="l01688"></a>01688 }
<a name="l01689"></a>01689                 
<a name="l01690"></a>01690 <span class="comment">/* KP, KI, KD x Angle PID [23]</span>
<a name="l01691"></a>01691 <span class="comment">   fractional, 3 x 2 = 6 bytes</span>
<a name="l01692"></a>01692 <span class="comment">ANGLE_KP=0.9999</span>
<a name="l01693"></a>01693 <span class="comment">ANGLE_KI=0.8    </span>
<a name="l01694"></a>01694 <span class="comment">ANGLE_KD=0</span>
<a name="l01695"></a>01695 <span class="comment">*/</span>      
<a name="l01696"></a>01696 
<a name="l01697"></a>01697 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a9b9f409a9bc869aafbde19885b8326a5">EE_ANGLE_KP</a>);
<a name="l01698"></a>01698 TmpChk=Tmp1Long;
<a name="l01699"></a>01699 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa3921b5835fead737e5bf98dbebf4fde">ANGLE_KP</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01700"></a>01700 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#ad14fda74b8128e7250c1f3abd929aade">EE_ANGLE_KI</a>);
<a name="l01701"></a>01701 TmpChk+=Tmp1Long;
<a name="l01702"></a>01702 <a class="code" href="ds_p_i_d33__definitions_8h.html#ad3c6108576a8c14dc64cf980dcbeaa07">ANGLE_KI</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01703"></a>01703 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#af52df92bd4d7c249255e6312108ee544">EE_ANGLE_KD</a>);
<a name="l01704"></a>01704 TmpChk+=Tmp1Long;
<a name="l01705"></a>01705 <a class="code" href="ds_p_i_d33__definitions_8h.html#a8ac275be5870eac565e6abe883f71027">ANGLE_KD</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);  
<a name="l01706"></a>01706         
<a name="l01707"></a>01707 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#afdd825ccedea81546f1c4deeb04439bd">EE_CHK_ANGLE</a>))
<a name="l01708"></a>01708 {
<a name="l01709"></a>01709         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01710"></a>01710         <span class="keywordflow">return</span>;
<a name="l01711"></a>01711 }
<a name="l01712"></a>01712 
<a name="l01713"></a>01713 <span class="comment">/* KP, KI, KD x Dist PID [24]</span>
<a name="l01714"></a>01714 <span class="comment">   fractional, 3 x 2 = 6 bytes</span>
<a name="l01715"></a>01715 <span class="comment">DIST_KP=0.9999</span>
<a name="l01716"></a>01716 <span class="comment">DIST_KI=0.8     </span>
<a name="l01717"></a>01717 <span class="comment">DIST_KD=0</span>
<a name="l01718"></a>01718 <span class="comment">*/</span>      
<a name="l01719"></a>01719 
<a name="l01720"></a>01720 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a537065f445575f12000147ac6c8d8584">EE_DIST_KP</a>);
<a name="l01721"></a>01721 TmpChk=Tmp1Long;
<a name="l01722"></a>01722 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6eb9abd4c03c2bb9858333427ffc082b">DIST_KP</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01723"></a>01723 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#aa8af7e82a7307586c9d7b9f13766fe14">EE_DIST_KI</a>);
<a name="l01724"></a>01724 TmpChk+=Tmp1Long;
<a name="l01725"></a>01725 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9921840de098c5213a3e8a70a5d79434">DIST_KI</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01726"></a>01726 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a3cb4d269dc361abbdfe41a3de7a33e47">EE_DIST_KD</a>);
<a name="l01727"></a>01727 TmpChk+=Tmp1Long;
<a name="l01728"></a>01728 <a class="code" href="ds_p_i_d33__definitions_8h.html#ab8c0a30e2075f94c9f5e9b6a8e08a94f">DIST_KD</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);   
<a name="l01729"></a>01729         
<a name="l01730"></a>01730 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a1387301e05aad292458f92d900c917b5">EE_CHK_DIST</a>))
<a name="l01731"></a>01731 {
<a name="l01732"></a>01732         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01733"></a>01733         <span class="keywordflow">return</span>;
<a name="l01734"></a>01734 }
<a name="l01735"></a>01735 
<a name="l01736"></a>01736 <span class="comment">/* KP, KI, KD x Speed PID1 and PID2 in int x 10.000 </span>
<a name="l01737"></a>01737 <span class="comment">   fractional, 2MCs x 3params x 2bytes = 12 bytes</span>
<a name="l01738"></a>01738 <span class="comment">KP1=0.6</span>
<a name="l01739"></a>01739 <span class="comment">KI1=0.7</span>
<a name="l01740"></a>01740 <span class="comment">KD1=0.1</span>
<a name="l01741"></a>01741 <span class="comment">KP2=0.6</span>
<a name="l01742"></a>01742 <span class="comment">KI2=0.7</span>
<a name="l01743"></a>01743 <span class="comment">KD2=0.1 </span>
<a name="l01744"></a>01744 <span class="comment">*/</span>      
<a name="l01745"></a>01745 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a0c55ea3d3f295e10bfa3cc68f46b725b">EE_KP1</a>);
<a name="l01746"></a>01746 TmpChk=Tmp1Long;
<a name="l01747"></a>01747 <a class="code" href="ds_p_i_d33__definitions_8h.html#a08ed89f1b0686fbf5973ae9e6c421da9">KP1</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01748"></a>01748 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a7d688f68ec4bb55d1e7c7635e9a4eced">EE_KI1</a>);
<a name="l01749"></a>01749 TmpChk+=Tmp1Long;
<a name="l01750"></a>01750 <a class="code" href="ds_p_i_d33__definitions_8h.html#a11c4319254dbf2d15e4e190458953ea1">KI1</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01751"></a>01751 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a36bbd3d80231c2983c91dba3d8f03597">EE_KD1</a>);
<a name="l01752"></a>01752 TmpChk+=Tmp1Long;
<a name="l01753"></a>01753 <a class="code" href="ds_p_i_d33__definitions_8h.html#a62dfed7b72614c5259d58b3f114ab855">KD1</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);       
<a name="l01754"></a>01754 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a44be0fb106e81ceb006673c95286b31e">EE_KP2</a>);
<a name="l01755"></a>01755 TmpChk+=Tmp1Long;
<a name="l01756"></a>01756 <a class="code" href="ds_p_i_d33__definitions_8h.html#a85e592792070b44b414d998f7c72c961">KP2</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01757"></a>01757 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a30f71dda0d2f653b8352e09f2ab4c31d">EE_KI2</a>);
<a name="l01758"></a>01758 TmpChk+=Tmp1Long;
<a name="l01759"></a>01759 <a class="code" href="ds_p_i_d33__definitions_8h.html#a35bbf7801d6af7dbbd7136bd9a5cd396">KI2</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);
<a name="l01760"></a>01760 Tmp1Long=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a683b81d63101ce00ecfb414dc1e28193">EE_KD2</a>);
<a name="l01761"></a>01761 TmpChk+=Tmp1Long;
<a name="l01762"></a>01762 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa14141a3768da78340e7bac812e21959">KD2</a>=Q15((<span class="keywordtype">float</span>)(Tmp1Long)/10000);       
<a name="l01763"></a>01763 
<a name="l01764"></a>01764 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#af73d4c0cec016550ce248ada634f65c9">EE_CHK_SPEED</a>))
<a name="l01765"></a>01765 {
<a name="l01766"></a>01766         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01767"></a>01767         <span class="keywordflow">return</span>;
<a name="l01768"></a>01768 }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="comment">/* constants for traveled distance calculation: SPACE_ENC_4X in mm [21]</span>
<a name="l01771"></a>01771 <span class="comment">        float, 2 x 4 = 8 bytes</span>
<a name="l01772"></a>01772 <span class="comment">Ksp[x] = 0.00506145483078356;   </span>
<a name="l01773"></a>01773 <span class="comment">*/</span>
<a name="l01774"></a>01774 Tmp1Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a17f833fda13a712b1a1f519656878bdf">EE_KSP1_H</a>);
<a name="l01775"></a>01775 TmpChk=Tmp1Long;
<a name="l01776"></a>01776 Tmp2Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a76b24bd1c5b96fff7a8dc81a8757e47b">EE_KSP1_L</a>);
<a name="l01777"></a>01777 TmpChk+=Tmp2Long;
<a name="l01778"></a>01778 <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]  = (float)(((Tmp1Long &lt;&lt; 16) + Tmp2Long))/((float)(1000000000)); 
<a name="l01779"></a>01779 Tmp1Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#abc091fd5685b28694aaaa20b337e7c08">EE_KSP2_H</a>);
<a name="l01780"></a>01780 TmpChk+=Tmp1Long;
<a name="l01781"></a>01781 Tmp2Long=(long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a587522af961f06270208e2bb30532856">EE_KSP2_L</a>);
<a name="l01782"></a>01782 TmpChk+=Tmp2Long;
<a name="l01783"></a>01783 <a class="code" href="ds_p_i_d33__definitions_8h.html#acce085fb3e400e13f46a7d32a7fdc6bc">Ksp</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]  = (float)(((Tmp1Long &lt;&lt; 16) + Tmp2Long))/((float)(1000000000)); 
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 <span class="comment">/* base width, distance between center of the wheels [21]</span>
<a name="l01786"></a>01786 <span class="comment">        float, 1 x 4 = 4 bytes</span>
<a name="l01787"></a>01787 <span class="comment">Axle = 185.2222;</span>
<a name="l01788"></a>01788 <span class="comment">*/</span>
<a name="l01789"></a>01789 
<a name="l01790"></a>01790 Tmp1Long = (long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a7dde2efdd67544d00f8b30c3f755b779">EE_AXLE_H</a>);
<a name="l01791"></a>01791 TmpChk+=Tmp1Long;
<a name="l01792"></a>01792 Tmp2Long = (long)<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a7df2d5424fb36a3fc7e585a23b830825">EE_AXLE_L</a>);
<a name="l01793"></a>01793 TmpChk+=Tmp2Long;
<a name="l01794"></a>01794 <a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a> = ((float)((Tmp1Long &lt;&lt; 16) + Tmp2Long))/((float)(10000));
<a name="l01795"></a>01795 <span class="keywordflow">if</span> (TmpChk!=<a class="code" href="_d_e_e_01_emulation_0116-bit_8c.html#ac2e6924048931f3c2019bb7dee441ff0">DataEERead</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a30de59f6d3ad201cf79752d12c60158d">EE_CHK_MECH</a>))
<a name="l01796"></a>01796 {
<a name="l01797"></a>01797         <a class="code" href="ds_p_i_d33_8c.html#a4bf5ff5b210e31e4eae6f4a71d85f669">ConstantsError</a>();
<a name="l01798"></a>01798         <span class="keywordflow">return</span>;
<a name="l01799"></a>01799 }
<a name="l01800"></a>01800 
<a name="l01801"></a>01801 <a class="code" href="ds_p_i_d33__definitions_8h.html#a7bce650326fb4f77339ecdcfd3d4e493">SemiAxle</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a55fe808c96551f1979b3cceb6bb84e30">Axle</a>/2;
<a name="l01802"></a>01802 }
<a name="l01803"></a>01803 
<a name="l01804"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a6064a7952a17249d66661e03dbcea753">01804</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a6064a7952a17249d66661e03dbcea753">InitPid1</a>(<span class="keywordtype">void</span>)
<a name="l01805"></a>01805 {       
<a name="l01812"></a>01812 <span class="comment">//Set up pointer to derived coefficients</span>
<a name="l01813"></a>01813 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae02dfbc875f6ab4d268e00307b6fe433">PIDstruct1</a>.abcCoefficients = &amp;abcCoefficient1[0];
<a name="l01814"></a>01814 <span class="comment">//Set up pointer to controller history samples</span>
<a name="l01815"></a>01815 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae02dfbc875f6ab4d268e00307b6fe433">PIDstruct1</a>.controlHistory = &amp;controlHistory1[0]; 
<a name="l01816"></a>01816 <span class="comment">// Clear the controler history and the controller output</span>
<a name="l01817"></a>01817 PIDInit(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#ae02dfbc875f6ab4d268e00307b6fe433">PIDstruct1</a>); 
<a name="l01818"></a>01818 <span class="comment">//Derive the a,b, &amp; c coefficients from the Kp, Ki &amp; Kd</span>
<a name="l01819"></a>01819 PIDCoeffCalc(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a843702f7b5a493eeabe40eb08bd2ff4a">kCoeffs1</a>[0], &amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#ae02dfbc875f6ab4d268e00307b6fe433">PIDstruct1</a>); 
<a name="l01820"></a>01820 }
<a name="l01821"></a>01821 
<a name="l01822"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a29e3f7da68ea11f3a29916acc588c7dc">01822</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a29e3f7da68ea11f3a29916acc588c7dc">InitPid2</a>(<span class="keywordtype">void</span>)
<a name="l01823"></a>01823 {
<a name="l01830"></a>01830 <span class="comment">//Set up pointer to derived coefficients</span>
<a name="l01831"></a>01831 <a class="code" href="ds_p_i_d33__definitions_8h.html#a56a4a5bc6097a4b6ef8982a0e1d7cc2d">PIDstruct2</a>.abcCoefficients = &amp;abcCoefficient2[0];
<a name="l01832"></a>01832 <span class="comment">//Set up pointer to controller history samples</span>
<a name="l01833"></a>01833 <a class="code" href="ds_p_i_d33__definitions_8h.html#a56a4a5bc6097a4b6ef8982a0e1d7cc2d">PIDstruct2</a>.controlHistory = &amp;controlHistory2[0]; 
<a name="l01834"></a>01834 <span class="comment">// Clear the controler history and the controller output</span>
<a name="l01835"></a>01835 PIDInit(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a56a4a5bc6097a4b6ef8982a0e1d7cc2d">PIDstruct2</a>); 
<a name="l01836"></a>01836 <span class="comment">//Derive the a,b, &amp; c coefficients from the Kp, Ki &amp; Kd</span>
<a name="l01837"></a>01837 PIDCoeffCalc(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#ad8328ab5c71bdc690c9c654e3878fd32">kCoeffs2</a>[0], &amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a56a4a5bc6097a4b6ef8982a0e1d7cc2d">PIDstruct2</a>); 
<a name="l01838"></a>01838 }
<a name="l01839"></a>01839 
<a name="l01840"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a0d2658e37f8f1a6d3466c74e7244a7f8">01840</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a0d2658e37f8f1a6d3466c74e7244a7f8">Pid1</a>(<span class="keywordtype">void</span>) 
<a name="l01841"></a>01841 {
<a name="l01847"></a>01847 <span class="preprocessor">#ifdef SLOW_ENC </span>
<a name="l01848"></a>01848 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (labs(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]) &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a79e465ae4acf7e1636dd74cc5be8a618">VEL_MIN_PID</a>) <span class="comment">// more frequent PID cycle above a threshold</span>
<a name="l01849"></a>01849         {
<a name="l01850"></a>01850                 <a class="code" href="ds_p_i_d33_8c.html#a4b89d752d156a5b554a45fe76943e0f4">Pid1Calc</a>();
<a name="l01851"></a>01851         }
<a name="l01852"></a>01852         <span class="keywordflow">else</span>    <span class="comment">// [19f]</span>
<a name="l01853"></a>01853         {
<a name="l01854"></a>01854                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9323e760f52cbb4e28d7f1098ee5fdd8">PidCycle</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] ++; 
<a name="l01855"></a>01855                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a9323e760f52cbb4e28d7f1098ee5fdd8">PidCycle</a>[R] &gt;= 10)
<a name="l01856"></a>01856                 {
<a name="l01857"></a>01857                         <a class="code" href="ds_p_i_d33_8c.html#a4b89d752d156a5b554a45fe76943e0f4">Pid1Calc</a>();
<a name="l01858"></a>01858                 }
<a name="l01859"></a>01859         }
<a name="l01860"></a>01860 <span class="preprocessor">#else</span>
<a name="l01861"></a>01861 <span class="preprocessor"></span>        <a class="code" href="ds_p_i_d33_8c.html#a4b89d752d156a5b554a45fe76943e0f4">Pid1Calc</a>();
<a name="l01862"></a>01862 <span class="preprocessor">#endif</span>
<a name="l01863"></a>01863 <span class="preprocessor"></span>}
<a name="l01864"></a>01864 
<a name="l01865"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a4b89d752d156a5b554a45fe76943e0f4">01865</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a4b89d752d156a5b554a45fe76943e0f4">Pid1Calc</a>(<span class="keywordtype">void</span>) 
<a name="l01866"></a>01866 {
<a name="l01873"></a>01873         <span class="keywordtype">long</span> IcPeriodTmp;
<a name="l01874"></a>01874         <span class="keywordtype">int</span> IcIndxTmp;
<a name="l01875"></a>01875         <span class="keywordtype">int</span> PWM;
<a name="l01876"></a>01876         
<a name="l01877"></a>01877         IcPeriodTmp=<a class="code" href="ds_p_i_d33__definitions_8h.html#ad16093a0b9caf4347f28c74346ef9cbf">Ic1Period</a>;  <span class="comment">// [19a]</span>
<a name="l01878"></a>01878         IcIndxTmp=<a class="code" href="ds_p_i_d33__definitions_8h.html#ab7bd731dcfe1abec7faf335334836fa4">Ic1Indx</a>;
<a name="l01879"></a>01879         <a class="code" href="ds_p_i_d33__definitions_8h.html#ab7bd731dcfe1abec7faf335334836fa4">Ic1Indx</a> = 0;    
<a name="l01880"></a>01880         <a class="code" href="ds_p_i_d33__definitions_8h.html#ad16093a0b9caf4347f28c74346ef9cbf">Ic1Period</a>=0;    
<a name="l01881"></a>01881 <span class="comment">//      IC1_FIRST=0;</span>
<a name="l01882"></a>01882         <a class="code" href="ds_p_i_d33__definitions_8h.html#a311ccc470172ffb6eaedb52ef383955a">PID1_CALC_FLAG</a> = 0;
<a name="l01883"></a>01883         <a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=0;
<a name="l01884"></a>01884         
<a name="l01885"></a>01885         <span class="keywordflow">if</span> (IcIndxTmp)  <span class="comment">// motor is running [19c]</span>
<a name="l01886"></a>01886         {
<a name="l01887"></a>01887                 <a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]*IcIndxTmp/IcPeriodTmp;
<a name="l01888"></a>01888         }
<a name="l01889"></a>01889 
<a name="l01890"></a>01890         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] += (int)POS1CNT; <span class="comment">// cast to signed to store direction [19]</span>
<a name="l01891"></a>01891         POS1CNT=0;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893         <span class="comment">// calcolo PID</span>
<a name="l01894"></a>01894         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdb5ebd40a9d20e527a8a08e50af4409">RAMP_FLAG1</a>) <span class="comment">// the motor is acc/dec-elerating [19f]</span>
<a name="l01895"></a>01895         {
<a name="l01896"></a>01896                 <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> += <a class="code" href="ds_p_i_d33__definitions_8h.html#ae7a3b2af5c19975de4291408ab4c9663">Ramp1</a>;
<a name="l01897"></a>01897                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a11f69cd40c0277286560af950300bf05">RAMP_T_FLAG1</a>)       
<a name="l01898"></a>01898                 {
<a name="l01899"></a>01899                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]) 
<a name="l01900"></a>01900                         {
<a name="l01901"></a>01901                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l01902"></a>01902                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdb5ebd40a9d20e527a8a08e50af4409">RAMP_FLAG1</a> = 0; <span class="comment">// acceleration is over</span>
<a name="l01903"></a>01903                         }
<a name="l01904"></a>01904                 }
<a name="l01905"></a>01905                 <span class="keywordflow">else</span>
<a name="l01906"></a>01906                 {
<a name="l01907"></a>01907                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]) 
<a name="l01908"></a>01908                         {
<a name="l01909"></a>01909                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#aaf6803848d613fe26adac3ce24a92293">PID_REF1</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l01910"></a>01910                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdb5ebd40a9d20e527a8a08e50af4409">RAMP_FLAG1</a> = 0; <span class="comment">// acceleration is over</span>
<a name="l01911"></a>01911                         }
<a name="l01912"></a>01912                 }
<a name="l01913"></a>01913         }
<a name="l01914"></a>01914         
<a name="l01915"></a>01915         <a class="code" href="ds_p_i_d33__definitions_8h.html#a115818384912b1c35ffe046bc66ee6f2">PID_MES1</a> = (<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]);                    <span class="comment">// speed in m/s</span>
<a name="l01916"></a>01916         PID(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#ae02dfbc875f6ab4d268e00307b6fe433">PIDstruct1</a>);
<a name="l01917"></a>01917         PWM = (<a class="code" href="ds_p_i_d33__definitions_8h.html#a5b7cb563cee7fcab3646ac73bfec9836">PID_OUT1</a> &gt;&gt; 4) + 2048 ;  <span class="comment">// [19e]</span>
<a name="l01918"></a>01918         SetDCMCPWM1(1, PWM, 0);
<a name="l01919"></a>01919 <span class="comment">//      MOTOR_ENABLE1 = 1;      // [1]          </span>
<a name="l01920"></a>01920 }
<a name="l01921"></a>01921 
<a name="l01922"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a3660e62a3b7d7a9b39a21d35e947b03f">01922</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a3660e62a3b7d7a9b39a21d35e947b03f">Pid2</a>(<span class="keywordtype">void</span>) 
<a name="l01923"></a>01923 {
<a name="l01929"></a>01929 <span class="preprocessor">#ifdef SLOW_ENC </span>
<a name="l01930"></a>01930 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (labs(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]) &gt; <a class="code" href="ds_p_i_d33__definitions_8h.html#a79e465ae4acf7e1636dd74cc5be8a618">VEL_MIN_PID</a>) <span class="comment">// more frequent PID cycle above a threshold</span>
<a name="l01931"></a>01931         {
<a name="l01932"></a>01932                 <a class="code" href="ds_p_i_d33_8c.html#a95a78fb7d13043b19f72efe55ed34d66">Pid2Calc</a>();
<a name="l01933"></a>01933         }
<a name="l01934"></a>01934         <span class="keywordflow">else</span>    <span class="comment">// [19f]</span>
<a name="l01935"></a>01935         {
<a name="l01936"></a>01936                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a9323e760f52cbb4e28d7f1098ee5fdd8">PidCycle</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] ++; 
<a name="l01937"></a>01937                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a9323e760f52cbb4e28d7f1098ee5fdd8">PidCycle</a>[L] &gt;= 10)
<a name="l01938"></a>01938                 {
<a name="l01939"></a>01939                         <a class="code" href="ds_p_i_d33_8c.html#a95a78fb7d13043b19f72efe55ed34d66">Pid2Calc</a>();
<a name="l01940"></a>01940                 }
<a name="l01941"></a>01941         }
<a name="l01942"></a>01942 <span class="preprocessor">#else</span>
<a name="l01943"></a>01943 <span class="preprocessor"></span>        <a class="code" href="ds_p_i_d33_8c.html#a95a78fb7d13043b19f72efe55ed34d66">Pid2Calc</a>();
<a name="l01944"></a>01944 <span class="preprocessor">#endif</span>
<a name="l01945"></a>01945 <span class="preprocessor"></span>}
<a name="l01946"></a>01946 
<a name="l01947"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a95a78fb7d13043b19f72efe55ed34d66">01947</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a95a78fb7d13043b19f72efe55ed34d66">Pid2Calc</a>(<span class="keywordtype">void</span>)
<a name="l01948"></a>01948 {
<a name="l01955"></a>01955         <span class="keywordtype">long</span> IcPeriodTmp;
<a name="l01956"></a>01956         <span class="keywordtype">int</span> IcIndxTmp;
<a name="l01957"></a>01957         <span class="keywordtype">int</span> PWM;
<a name="l01958"></a>01958 
<a name="l01959"></a>01959         IcPeriodTmp=<a class="code" href="ds_p_i_d33__definitions_8h.html#aadf26a5d9fa50e3289240aa557a727e3">Ic2Period</a>;  <span class="comment">// [19a]</span>
<a name="l01960"></a>01960         IcIndxTmp=<a class="code" href="ds_p_i_d33__definitions_8h.html#a76cdd80a69f7854545e2b75064fb871a">Ic2Indx</a>;
<a name="l01961"></a>01961         <a class="code" href="ds_p_i_d33__definitions_8h.html#a76cdd80a69f7854545e2b75064fb871a">Ic2Indx</a> = 0;    
<a name="l01962"></a>01962         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadf26a5d9fa50e3289240aa557a727e3">Ic2Period</a>=0;    
<a name="l01963"></a>01963 <span class="comment">//      IC2_FIRST=0;</span>
<a name="l01964"></a>01964         <a class="code" href="ds_p_i_d33__definitions_8h.html#ad14ab2821b8f27e9d0ba9d4d79d3e4e4">PID2_CALC_FLAG</a> = 0;
<a name="l01965"></a>01965         <a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=0;
<a name="l01966"></a>01966         
<a name="l01967"></a>01967         <span class="keywordflow">if</span> (IcIndxTmp)  <span class="comment">// motor is running [19c]</span>
<a name="l01968"></a>01968         {
<a name="l01969"></a>01969                 <a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = <a class="code" href="ds_p_i_d33__definitions_8h.html#a4d89a8c0bd42593f537de9654a0187c3">Kvel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]*IcIndxTmp/IcPeriodTmp;
<a name="l01970"></a>01970         }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972         <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] += (int)POS2CNT; <span class="comment">// cast to signed to store direction [19]</span>
<a name="l01973"></a>01973         POS2CNT=0;
<a name="l01974"></a>01974 
<a name="l01975"></a>01975         <span class="comment">// calcolo PID</span>
<a name="l01976"></a>01976         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a4aaf95d79a76519a4e96a4b83b7fd2f3">RAMP_FLAG2</a>) <span class="comment">// the motor is acc/dec-elerating [19f]</span>
<a name="l01977"></a>01977         {
<a name="l01978"></a>01978                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> += <a class="code" href="ds_p_i_d33__definitions_8h.html#a0d6520657b638a94231ea1c784b05101">Ramp2</a>;
<a name="l01979"></a>01979                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#aadbe0f0a0d2c2db9398c365fabc0d5c7">RAMP_T_FLAG2</a>)       
<a name="l01980"></a>01980                 {
<a name="l01981"></a>01981                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]) 
<a name="l01982"></a>01982                         {
<a name="l01983"></a>01983                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l01984"></a>01984                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4aaf95d79a76519a4e96a4b83b7fd2f3">RAMP_FLAG2</a> = 0; <span class="comment">// acceleration is over</span>
<a name="l01985"></a>01985                         }
<a name="l01986"></a>01986                 }
<a name="l01987"></a>01987                 <span class="keywordflow">else</span>
<a name="l01988"></a>01988                 {
<a name="l01989"></a>01989                         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> &lt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]) 
<a name="l01990"></a>01990                         {
<a name="l01991"></a>01991                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#abdf5b1079825110830d731b3388828e7">PID_REF2</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a7419cf578d32868fbbe35f84acb10786">VelFin</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l01992"></a>01992                                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4aaf95d79a76519a4e96a4b83b7fd2f3">RAMP_FLAG2</a> = 0; <span class="comment">// acceleration is over</span>
<a name="l01993"></a>01993                         }
<a name="l01994"></a>01994                 }
<a name="l01995"></a>01995         }
<a name="l01996"></a>01996         
<a name="l01997"></a>01997         <a class="code" href="ds_p_i_d33__definitions_8h.html#a473ccd97f1d3b01910c4070f99d98169">PID_MES2</a> = (<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]);                    <span class="comment">// speed in m/s</span>
<a name="l01998"></a>01998         PID(&amp;<a class="code" href="ds_p_i_d33__definitions_8h.html#a56a4a5bc6097a4b6ef8982a0e1d7cc2d">PIDstruct2</a>);
<a name="l01999"></a>01999         PWM = (<a class="code" href="ds_p_i_d33__definitions_8h.html#a719c9a6b9fce49a92cdde20abef4b420">PID_OUT2</a> &gt;&gt; 4) + 2048 ;  <span class="comment">// [19e]</span>
<a name="l02000"></a>02000         SetDCMCPWM1(2, PWM, 0);
<a name="l02001"></a>02001 <span class="comment">//      MOTOR_ENABLE2 = 1;      // [1]                  </span>
<a name="l02002"></a>02002 }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004 
<a name="l02005"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#aac92344238c1de7c10a17dac75bc2847">02005</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#aac92344238c1de7c10a17dac75bc2847">DelayN1ms</a>(<span class="keywordtype">int</span> n)
<a name="l02006"></a>02006 {
<a name="l02007"></a>02007         <span class="keywordtype">int</span> ms;
<a name="l02008"></a>02008         <span class="keywordflow">for</span> (ms = 0; ms &lt; n; ms ++)
<a name="l02009"></a>02009         {
<a name="l02010"></a>02010                 <a class="code" href="ds_p_i_d33_8c.html#a2bd5b0b7c6e63a18374dc5e63a5f9930">DelayN10us</a>(100);
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012 }
<a name="l02013"></a>02013 
<a name="l02014"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a2bd5b0b7c6e63a18374dc5e63a5f9930">02014</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#a2bd5b0b7c6e63a18374dc5e63a5f9930">DelayN10us</a>(<span class="keywordtype">int</span> n) <span class="comment">// [22]</span>
<a name="l02015"></a>02015 {
<a name="l02016"></a>02016         <span class="keywordtype">int</span> DelayCount;
<a name="l02017"></a>02017         <span class="keywordflow">for</span> (DelayCount = 0; DelayCount &lt; (57 * n); DelayCount ++);     
<a name="l02018"></a>02018 }
<a name="l02019"></a>02019 
<a name="l02020"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#ac7fea72c4e68b14bb464adc12fb94908">02020</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33_8c.html#ac7fea72c4e68b14bb464adc12fb94908">TxCont</a>(<span class="keywordtype">void</span>)
<a name="l02021"></a>02021 {
<a name="l02027"></a>02027         <span class="keywordtype">int</span> Ptmp;                               <span class="comment">// temp for position values</span>
<a name="l02028"></a>02028         <span class="keywordtype">int</span> CurrTmp;                    <span class="comment">// temp for motors current value</span>
<a name="l02029"></a>02029         <span class="keywordtype">int</span> <a class="code" href="ds_p_i_d33__definitions_8h.html#a8edcc871388697294a89b7c58920cb1c">VelInt</a>[2];                  <span class="comment">// speed in mm/s as an integer</span>
<a name="l02030"></a>02030         <span class="keywordtype">int</span> Alpha;                      <span class="comment">// rotation angle in degrees</span>
<a name="l02031"></a>02031 
<a name="l02032"></a>02032         <a class="code" href="ds_p_i_d33__definitions_8h.html#a06af0346de02b4af7df612af6e131878">UartContTxTimer</a>=<a class="code" href="ds_p_i_d33__definitions_8h.html#a54eb0a13ea5c659b585e80fd35c33437">UART_CONT_TIMEOUT</a>;      <span class="comment">// timer reset</span>
<a name="l02033"></a>02033         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a3a8afd2657f6103e1174a7a72aa7d8d5">TxContFlag</a> == 1)
<a name="l02034"></a>02034         {
<a name="l02035"></a>02035                 Ptmp = (<a class="code" href="ds_p_i_d33__definitions_8h.html#ab9ea4576e61721fa68c8168e015b47e7">VelMes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] + <a class="code" href="ds_p_i_d33__definitions_8h.html#ab9ea4576e61721fa68c8168e015b47e7">VelMes</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]) &gt;&gt; 1;    <span class="comment">// average speed</span>
<a name="l02036"></a>02036                 UartTxBuff[0]=Ptmp&gt;&gt;8; 
<a name="l02037"></a>02037                 UartTxBuff[1]=Ptmp;
<a name="l02038"></a>02038                 UartTxBuff[2]=9;                                                <span class="comment">// tab</span>
<a name="l02039"></a>02039                 <span class="comment">// Curr = int -&gt; 2byte (mA)</span>
<a name="l02040"></a>02040                 CurrTmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]+<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];              <span class="comment">// total current</span>
<a name="l02041"></a>02041                 UartTxBuff[3]=CurrTmp&gt;&gt;8;
<a name="l02042"></a>02042                 UartTxBuff[4]=CurrTmp;
<a name="l02043"></a>02043                 UartTxBuff[5]=9;                                                <span class="comment">// tab</span>
<a name="l02044"></a>02044                 <span class="comment">// PosXmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l02045"></a>02045                 Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a4dee79489e441864b497720f1e94f120">PosXmes</a>);                              <span class="comment">// PosX</span>
<a name="l02046"></a>02046                 UartTxBuff[6]=Ptmp&gt;&gt;8; 
<a name="l02047"></a>02047                 UartTxBuff[7]=Ptmp;
<a name="l02048"></a>02048                 UartTxBuff[8]=9;                                                <span class="comment">// tab</span>
<a name="l02049"></a>02049                 <span class="comment">// PosYmes rounded in a Int -&gt; 2 byte (mm)</span>
<a name="l02050"></a>02050                 Ptmp = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(<a class="code" href="ds_p_i_d33__definitions_8h.html#a87a357dd4fee8d8f5a8993d981cf35d4">PosYmes</a>);                              <span class="comment">// PosY</span>
<a name="l02051"></a>02051                 UartTxBuff[9]=Ptmp&gt;&gt;8; 
<a name="l02052"></a>02052                 UartTxBuff[10]=Ptmp;
<a name="l02053"></a>02053                 UartTxBuff[11]=9;                                               <span class="comment">// tab</span>
<a name="l02054"></a>02054                 <span class="comment">// ThetaMes rounded in a Int -&gt; 2 byte (degrees)</span>
<a name="l02055"></a>02055                 Ptmp = <a class="code" href="ds_p_i_d33__definitions_8h.html#a611227bed8176bdcf78f28eb4c9888d0">ThetaMes</a> * <a class="code" href="ds_p_i_d33__definitions_8h.html#ac5a945020d3528355cda82d383676736">RAD2DEG</a>;                              <span class="comment">// Theta</span>
<a name="l02056"></a>02056                 Alpha = <a class="code" href="ds_p_i_d33__common_8h.html#a9769eaa4af1472c252c3073f94d888a4">FLOAT2INT</a>(Ptmp);
<a name="l02057"></a>02057                 UartTxBuff[12]=Alpha&gt;&gt;8; 
<a name="l02058"></a>02058                 UartTxBuff[13]=Alpha;
<a name="l02059"></a>02059                 UartTxBuff[14]=10;                                              <span class="comment">// LF</span>
<a name="l02060"></a>02060                 UartTxBuff[15]=13;                                              <span class="comment">// CR</span>
<a name="l02061"></a>02061                 DMA6CNT = 15;   <span class="comment">// # of DMA requests</span>
<a name="l02062"></a>02062         }
<a name="l02063"></a>02063         <span class="keywordflow">else</span>
<a name="l02064"></a>02064         {
<a name="l02065"></a>02065                 <span class="comment">// VelInt = Int -&gt; 2 byte</span>
<a name="l02066"></a>02066                 VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] * 1000)&gt;&gt;15;            <span class="comment">// VelR</span>
<a name="l02067"></a>02067                 UartTxBuff[0]=VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8; 
<a name="l02068"></a>02068                 UartTxBuff[1]=VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l02069"></a>02069                 UartTxBuff[2]=9;                                                <span class="comment">// tab</span>
<a name="l02070"></a>02070                 VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]=(long)(<a class="code" href="ds_p_i_d33__definitions_8h.html#acc6d0c2c053cbcef2384cbed65dd6979">Vel</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] * 1000)&gt;&gt;15;            <span class="comment">// VelL</span>
<a name="l02071"></a>02071                 UartTxBuff[3]=VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8; 
<a name="l02072"></a>02072                 UartTxBuff[4]=VelInt[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l02073"></a>02073                 UartTxBuff[5]=9;                                                <span class="comment">// tab</span>
<a name="l02074"></a>02074                 <span class="comment">// ADCValue = int -&gt; 2byte</span>
<a name="l02075"></a>02075                 UartTxBuff[6]=<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8;                   <span class="comment">// CurrR</span>
<a name="l02076"></a>02076                 UartTxBuff[7]=<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l02077"></a>02077                 UartTxBuff[8]=9;                                                <span class="comment">// tab</span>
<a name="l02078"></a>02078                 UartTxBuff[9]=<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8;                   <span class="comment">// CurrL</span>
<a name="l02079"></a>02079                 UartTxBuff[10]=<a class="code" href="ds_p_i_d33__definitions_8h.html#acd666697f9ed7fb20e7b0ca905877212">ADCValue</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l02080"></a>02080                 UartTxBuff[11]=9;                                               <span class="comment">// tab</span>
<a name="l02081"></a>02081                 <span class="comment">// Space = int -&gt; 2byte</span>
<a name="l02082"></a>02082                 UartTxBuff[12]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>]&gt;&gt;8;                    <span class="comment">// SpTickR</span>
<a name="l02083"></a>02083                 UartTxBuff[13]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>];
<a name="l02084"></a>02084                 UartTxBuff[14]=9;                                               <span class="comment">// tab</span>
<a name="l02085"></a>02085                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#a5c71a5e59a53413cd6c270266d63b031">R</a>] = 0; <span class="comment">// [19]</span>
<a name="l02086"></a>02086                 UartTxBuff[15]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>]&gt;&gt;8;                    <span class="comment">// SpTickL</span>
<a name="l02087"></a>02087                 UartTxBuff[16]=<a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>];
<a name="l02088"></a>02088                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a46cb1183b49bb1becada0a2b1fca0604">SpTick</a>[<a class="code" href="ds_p_i_d33__definitions_8h.html#aa73214aa5f2f94f63d90bb4e3d99fe53">L</a>] = 0; <span class="comment">// [19]</span>
<a name="l02089"></a>02089                 UartTxBuff[17]=10;                                              <span class="comment">// LF</span>
<a name="l02090"></a>02090                 UartTxBuff[18]=13;                                              <span class="comment">// CR</span>
<a name="l02091"></a>02091                 DMA6CNT = 18;   <span class="comment">// # of DMA requests</span>
<a name="l02092"></a>02092         }
<a name="l02093"></a>02093 
<a name="l02094"></a>02094         DMA6CONbits.CHEN  = 1;          <span class="comment">// Re-enable TX DMA Channel</span>
<a name="l02095"></a>02095         DMA6REQbits.FORCE = 1;          <span class="comment">// Manual mode: Kick-start the first TX</span>
<a name="l02096"></a>02096 }
<a name="l02097"></a>02097 
<a name="l02098"></a>02098 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l02099"></a>02099 <span class="comment">/* Interrupt Service Routines                                                */</span>
<a name="l02100"></a>02100 <span class="comment">/*---------------------------------------------------------------------------*/</span>
<a name="l02101"></a>02101 <span class="preprocessor">#ifndef TIMER_OFF</span>
<a name="l02102"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#af6c757804c9e7199cd569c33e38dbcee">02102</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#a6de88c5089dac3aa8c3acdd749459175">_T1Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02103"></a>02103 {
<a name="l02108"></a>02108         _T1IF=0;                <span class="comment">// interrupt flag reset</span>
<a name="l02109"></a>02109         <a class="code" href="ds_p_i_d33__definitions_8h.html#a06af0346de02b4af7df612af6e131878">UartContTxTimer</a> --;     <span class="comment">// timer for continuos send mode</span>
<a name="l02110"></a>02110         <a class="code" href="com_8h.html#a70e63880b204e0dc0dda4d8dffe226f7">Blink</a> ++;                       <span class="comment">// heartbeat LED blink</span>
<a name="l02111"></a>02111         
<a name="l02112"></a>02112         <span class="comment">// cycle 0 actions</span>
<a name="l02113"></a>02113         <a class="code" href="ds_p_i_d33__definitions_8h.html#a311ccc470172ffb6eaedb52ef383955a">PID1_CALC_FLAG</a> = 1;     <span class="comment">// PID1 and speed calculation enabled</span>
<a name="l02114"></a>02114         <a class="code" href="ds_p_i_d33__definitions_8h.html#ad14ab2821b8f27e9d0ba9d4d79d3e4e4">PID2_CALC_FLAG</a> = 1;     <span class="comment">// PID2 and speed calculation enabled</span>
<a name="l02115"></a>02115                 
<a name="l02116"></a>02116         <a class="code" href="ds_p_i_d33__definitions_8h.html#a0a2f7948d9868f999b43741f0ba82750">Cycle1</a> ++;
<a name="l02117"></a>02117         <span class="comment">// cycle 1 actions</span>
<a name="l02118"></a>02118         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a0a2f7948d9868f999b43741f0ba82750">Cycle1</a> &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#ab1cfea5020160ee121f9c5ae019ba7a7">CICLE1_TMO</a>)
<a name="l02119"></a>02119         {
<a name="l02120"></a>02120                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a0a2f7948d9868f999b43741f0ba82750">Cycle1</a> = 0;
<a name="l02121"></a>02121                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a046ceb5294473f63ac9554e05db73dba">CYCLE1_FLAG</a> = 1; <span class="comment">// it&#39;s time to start first cycle actions [23]</span>
<a name="l02122"></a>02122 
<a name="l02123"></a>02123                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ae49c420b00c8440683da20d4078ffedd">Cycle2</a> ++;
<a name="l02124"></a>02124                 <span class="comment">// cycle 2 actions</span>
<a name="l02125"></a>02125                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#ae49c420b00c8440683da20d4078ffedd">Cycle2</a> &gt;= <a class="code" href="ds_p_i_d33__definitions_8h.html#a39cc0f6f866b6ed2814ae776eb90bfbc">CICLE2_TMO</a>)
<a name="l02126"></a>02126                 {
<a name="l02127"></a>02127                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae49c420b00c8440683da20d4078ffedd">Cycle2</a> = 0;
<a name="l02128"></a>02128                         <a class="code" href="ds_p_i_d33__definitions_8h.html#af0dcd631114229755ad63f9b08af523e">CYCLE2_FLAG</a>=1; <span class="comment">// it&#39;s time to start second cycle actions [24]</span>
<a name="l02129"></a>02129                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a11910bdc7598cd4e2c1f73f3911b62f0">IdleSample</a> ++; <span class="comment">// [25]</span>
<a name="l02130"></a>02130                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a9143ee7b83c3016f37b301761c2d0ae6">RtTimer</a> --;        <span class="comment">// real time delay</span>
<a name="l02131"></a>02131                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ae975c59a80fa66f26da4c9d364bc067f">RndTimer</a> ++;   <span class="comment">// Timer for randomly avoid central obstacles</span>
<a name="l02132"></a>02132                 }
<a name="l02133"></a>02133         }
<a name="l02134"></a>02134 }
<a name="l02135"></a>02135 
<a name="l02136"></a><a class="code" href="ds_p_i_d33_8c.html#a1f1b65e9a470a4c277e2fbb7ad6a0415">02136</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#a1f1b65e9a470a4c277e2fbb7ad6a0415">_T2Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02137"></a>02137 {
<a name="l02142"></a>02142         _T2IF = 0;                                      <span class="comment">// interrupt flag reset</span>
<a name="l02143"></a>02143         <a class="code" href="ds_p_i_d33__definitions_8h.html#acedf0e3776cd3c63d65c0d02bbde08a6">Tmr2OvflwCount1</a> ++;             <span class="comment">// TMR2 overflow as occurred</span>
<a name="l02144"></a>02144         <a class="code" href="ds_p_i_d33__definitions_8h.html#ad63f62ab5ed4d15c4de921414dacbc2e">Tmr2OvflwCount2</a> ++;             <span class="comment">// TMR2 overflow as occurred</span>
<a name="l02145"></a>02145 }
<a name="l02146"></a>02146 
<a name="l02147"></a>02147 <span class="preprocessor">#endif</span>
<a name="l02148"></a>02148 <span class="preprocessor"></span>
<a name="l02149"></a><a class="code" href="ds_p_i_d33_8c.html#abd42ae3ed76b560ff438a2ce1e31e999">02149</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#abd42ae3ed76b560ff438a2ce1e31e999">_DMA7Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02150"></a>02150 {
<a name="l02155"></a>02155         _DMA7IF = 0;    <span class="comment">// interrupt flag reset</span>
<a name="l02156"></a>02156         <a class="code" href="ds_p_i_d33__definitions_8h.html#a4a4f245b2f0fef97b86e2c5ef04377c8">ADC_CALC_FLAG</a> = 1; <span class="comment">// enable ADC average calculus</span>
<a name="l02157"></a>02157 }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159 
<a name="l02160"></a><a class="code" href="ds_p_i_d33_8c.html#ad74b63a1925b6046d61edddfb86b4e42">02160</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#ad74b63a1925b6046d61edddfb86b4e42">_DMA6Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02161"></a>02161 {
<a name="l02167"></a>02167         _DMA6IF = 0;    <span class="comment">// interrupt flag reset</span>
<a name="l02168"></a>02168         <a class="code" href="ds_p_i_d33__definitions_8h.html#a6094c00b22c8cff7ac35581b37385dd0">MAP_BUFF_FLAG</a> = 1; <span class="comment">// ready to send another map grid row</span>
<a name="l02169"></a>02169 }
<a name="l02170"></a>02170 
<a name="l02171"></a><a class="code" href="ds_p_i_d33_8c.html#ab4d06def5ed6de95fa83307aa4e3333c">02171</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#ab4d06def5ed6de95fa83307aa4e3333c">_DMA5Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02172"></a>02172 {
<a name="l02179"></a>02179         _DMA5IF = 0;    <span class="comment">// interrupt flag reset</span>
<a name="l02180"></a>02180         <a class="code" href="ds_p_i_d33__definitions_8h.html#a6094c00b22c8cff7ac35581b37385dd0">MAP_BUFF_FLAG</a> = 1; <span class="comment">// ready to send another map grid row</span>
<a name="l02181"></a>02181 }
<a name="l02182"></a>02182 
<a name="l02183"></a><a class="code" href="ds_p_i_d33__prototypes_8h.html#a389b7eb64f95a2506c912c6e78df4a16">02183</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#ad6485e76241b72888aa9691a5fb35c67">_IC1Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02184"></a>02184 {
<a name="l02190"></a>02190         _IC1IF = 0;                                     <span class="comment">// interrupt flag reset</span>
<a name="l02191"></a>02191         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a955742b4d3aa6e546452f6157d58bfe6">IC1_FIRST</a>)<span class="comment">// first sample, stores TMR2 starting value [19b]</span>
<a name="l02192"></a>02192         {
<a name="l02193"></a>02193                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a4bf551a0c877abf1e148cd1ab1e7bf96">Ic1CurrPeriod</a> = IC1BUF;
<a name="l02194"></a>02194                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#acedf0e3776cd3c63d65c0d02bbde08a6">Tmr2OvflwCount1</a> == 0)
<a name="l02195"></a>02195                 {
<a name="l02196"></a>02196                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ad16093a0b9caf4347f28c74346ef9cbf">Ic1Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#a4bf551a0c877abf1e148cd1ab1e7bf96">Ic1CurrPeriod</a> - <a class="code" href="ds_p_i_d33__definitions_8h.html#ac68910378d8fd7daec94c8785564a451">Ic1PrevPeriod</a>);
<a name="l02197"></a>02197                 }
<a name="l02198"></a>02198                 <span class="keywordflow">else</span>
<a name="l02199"></a>02199                 {<span class="comment">// [7a]</span>
<a name="l02200"></a>02200 <span class="preprocessor">                #ifdef SLOW_ENC </span>
<a name="l02201"></a>02201 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#ad16093a0b9caf4347f28c74346ef9cbf">Ic1Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#a4bf551a0c877abf1e148cd1ab1e7bf96">Ic1CurrPeriod</a> + (0xFFFF - <a class="code" href="ds_p_i_d33__definitions_8h.html#ac68910378d8fd7daec94c8785564a451">Ic1PrevPeriod</a>)
<a name="l02202"></a>02202                          +(0xFFFF * (<a class="code" href="ds_p_i_d33__definitions_8h.html#acedf0e3776cd3c63d65c0d02bbde08a6">Tmr2OvflwCount1</a> - 1)));
<a name="l02203"></a>02203 <span class="preprocessor">                #else</span>
<a name="l02204"></a>02204 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#ad16093a0b9caf4347f28c74346ef9cbf">Ic1Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#a4bf551a0c877abf1e148cd1ab1e7bf96">Ic1CurrPeriod</a> + (0xFFFF - <a class="code" href="ds_p_i_d33__definitions_8h.html#ac68910378d8fd7daec94c8785564a451">Ic1PrevPeriod</a>));
<a name="l02205"></a>02205 <span class="preprocessor">                #endif</span>
<a name="l02206"></a>02206 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#acedf0e3776cd3c63d65c0d02bbde08a6">Tmr2OvflwCount1</a> = 0;    
<a name="l02207"></a>02207                 }
<a name="l02208"></a>02208                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ac68910378d8fd7daec94c8785564a451">Ic1PrevPeriod</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#a4bf551a0c877abf1e148cd1ab1e7bf96">Ic1CurrPeriod</a>;
<a name="l02209"></a>02209                 <span class="keywordflow">if</span> (QEI1CONbits.UPDN)   <span class="comment">// [7b]</span>
<a name="l02210"></a>02210                 {
<a name="l02211"></a>02211                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ab7bd731dcfe1abec7faf335334836fa4">Ic1Indx</a> ++;
<a name="l02212"></a>02212                 }
<a name="l02213"></a>02213                 <span class="keywordflow">else</span>
<a name="l02214"></a>02214                 {
<a name="l02215"></a>02215                         <a class="code" href="ds_p_i_d33__definitions_8h.html#ab7bd731dcfe1abec7faf335334836fa4">Ic1Indx</a> --;
<a name="l02216"></a>02216                 }
<a name="l02217"></a>02217         }
<a name="l02218"></a>02218         <span class="keywordflow">else</span>
<a name="l02219"></a>02219         {
<a name="l02220"></a>02220                 <a class="code" href="ds_p_i_d33__definitions_8h.html#ac68910378d8fd7daec94c8785564a451">Ic1PrevPeriod</a> = IC1BUF;
<a name="l02221"></a>02221                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a955742b4d3aa6e546452f6157d58bfe6">IC1_FIRST</a>=1;
<a name="l02222"></a>02222         }
<a name="l02223"></a>02223 }
<a name="l02224"></a>02224 
<a name="l02225"></a>02225 
<a name="l02226"></a><a class="code" href="ds_p_i_d33_8c.html#a423d37ea6bd35e2f8cc7bc848e383709">02226</a> <span class="keywordtype">void</span> <a class="code" href="ds_p_i_d33__common_8h.html#aa782d8adb551c231a7e1ea440eea466a">_ISR_PSV</a> <a class="code" href="ds_p_i_d33_8c.html#a423d37ea6bd35e2f8cc7bc848e383709">_IC2Interrupt</a>(<span class="keywordtype">void</span>)
<a name="l02227"></a>02227 {
<a name="l02233"></a>02233         _IC2IF = 0;                                     <span class="comment">// interrupt flag reset</span>
<a name="l02234"></a>02234         <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#a6e3011a1d22ee08bfd8a5eb0b7368b45">IC2_FIRST</a>)<span class="comment">// first sample, stores TMR2 starting value [19b]</span>
<a name="l02235"></a>02235         {
<a name="l02236"></a>02236                 <a class="code" href="ds_p_i_d33__definitions_8h.html#aa94f6b15d79dfb18914fabc1602093f5">Ic2CurrPeriod</a> = IC2BUF;
<a name="l02237"></a>02237                 <span class="keywordflow">if</span> (<a class="code" href="ds_p_i_d33__definitions_8h.html#ad63f62ab5ed4d15c4de921414dacbc2e">Tmr2OvflwCount2</a> == 0)
<a name="l02238"></a>02238                 {
<a name="l02239"></a>02239                         <a class="code" href="ds_p_i_d33__definitions_8h.html#aadf26a5d9fa50e3289240aa557a727e3">Ic2Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#aa94f6b15d79dfb18914fabc1602093f5">Ic2CurrPeriod</a> - <a class="code" href="ds_p_i_d33__definitions_8h.html#a88cf5b5cd0190022aa3b9315598fecc1">Ic2PrevPeriod</a>);
<a name="l02240"></a>02240                 }
<a name="l02241"></a>02241                 <span class="keywordflow">else</span>
<a name="l02242"></a>02242                 {<span class="comment">// [7a]</span>
<a name="l02243"></a>02243 <span class="preprocessor">                #ifdef SLOW_ENC </span>
<a name="l02244"></a>02244 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#aadf26a5d9fa50e3289240aa557a727e3">Ic2Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#aa94f6b15d79dfb18914fabc1602093f5">Ic2CurrPeriod</a> + (0xFFFF - <a class="code" href="ds_p_i_d33__definitions_8h.html#a88cf5b5cd0190022aa3b9315598fecc1">Ic2PrevPeriod</a>)
<a name="l02245"></a>02245                          +(0xFFFF * (<a class="code" href="ds_p_i_d33__definitions_8h.html#ad63f62ab5ed4d15c4de921414dacbc2e">Tmr2OvflwCount2</a> - 1)));
<a name="l02246"></a>02246 <span class="preprocessor">                #else</span>
<a name="l02247"></a>02247 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#aadf26a5d9fa50e3289240aa557a727e3">Ic2Period</a> += (<a class="code" href="ds_p_i_d33__definitions_8h.html#aa94f6b15d79dfb18914fabc1602093f5">Ic2CurrPeriod</a> + (0xFFFF - <a class="code" href="ds_p_i_d33__definitions_8h.html#a88cf5b5cd0190022aa3b9315598fecc1">Ic2PrevPeriod</a>));
<a name="l02248"></a>02248 <span class="preprocessor">                #endif</span>
<a name="l02249"></a>02249 <span class="preprocessor"></span>                        <a class="code" href="ds_p_i_d33__definitions_8h.html#ad63f62ab5ed4d15c4de921414dacbc2e">Tmr2OvflwCount2</a> = 0;    
<a name="l02250"></a>02250                 }
<a name="l02251"></a>02251                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a88cf5b5cd0190022aa3b9315598fecc1">Ic2PrevPeriod</a> = <a class="code" href="ds_p_i_d33__definitions_8h.html#aa94f6b15d79dfb18914fabc1602093f5">Ic2CurrPeriod</a>;
<a name="l02252"></a>02252                 <span class="keywordflow">if</span> (QEI2CONbits.UPDN)   <span class="comment">// [7b]</span>
<a name="l02253"></a>02253                 {
<a name="l02254"></a>02254                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a76cdd80a69f7854545e2b75064fb871a">Ic2Indx</a> ++;
<a name="l02255"></a>02255                 }
<a name="l02256"></a>02256                 <span class="keywordflow">else</span>
<a name="l02257"></a>02257                 {
<a name="l02258"></a>02258                         <a class="code" href="ds_p_i_d33__definitions_8h.html#a76cdd80a69f7854545e2b75064fb871a">Ic2Indx</a> --;
<a name="l02259"></a>02259                 }
<a name="l02260"></a>02260         }
<a name="l02261"></a>02261         <span class="keywordflow">else</span>
<a name="l02262"></a>02262         {
<a name="l02263"></a>02263                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a88cf5b5cd0190022aa3b9315598fecc1">Ic2PrevPeriod</a> = IC2BUF;
<a name="l02264"></a>02264                 <a class="code" href="ds_p_i_d33__definitions_8h.html#a6e3011a1d22ee08bfd8a5eb0b7368b45">IC2_FIRST</a>=1;
<a name="l02265"></a>02265         }
<a name="l02266"></a>02266 }
<a name="l02267"></a>02267 
<a name="l02268"></a>02268 
<a name="l02269"></a><a class="code" href="ds_p_i_d33_8c.html#a226557d5e42f7e29ddaff30606138459">02269</a> <span class="keywordtype">void</span> <a class="code" href="com_8c.html#a257b528f424a3d46f9842346fe9221d3">__attribute__</a> ((interrupt, no_auto_psv)) _U1ErrInterrupt(<span class="keywordtype">void</span>)
<a name="l02270"></a>02270 {
<a name="l02274"></a>02274         IFS4bits.U1EIF = 0;
<a name="l02275"></a>02275 }
<a name="l02276"></a>02276 
<a name="l02277"></a>02277 <span class="keywordtype">void</span> <a class="code" href="com_8c.html#a257b528f424a3d46f9842346fe9221d3">__attribute__</a> ((interrupt, no_auto_psv)) _U2ErrInterrupt(<span class="keywordtype">void</span>)
<a name="l02278"></a>02278 {
<a name="l02282"></a>02282         IFS4bits.U2EIF = 0;
<a name="l02283"></a>02283 }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285 <span class="comment">//{</span>
<a name="l02286"></a>02286 <span class="comment">/* Disabled------------------</span>
<a name="l02287"></a>02287 <span class="comment">void _ISR_PSV _CNInterrupt(void)        // change Notification [3]</span>
<a name="l02288"></a>02288 <span class="comment">{</span>
<a name="l02289"></a>02289 <span class="comment">        _CNIF = 0;              // interrupt flag reset</span>
<a name="l02290"></a>02290 <span class="comment">}</span>
<a name="l02291"></a>02291 <span class="comment"></span>
<a name="l02292"></a>02292 <span class="comment">void _ISR_PSV _INT1Interrupt(void)      // External Interrupt INT1 [8]</span>
<a name="l02293"></a>02293 <span class="comment">{</span>
<a name="l02294"></a>02294 <span class="comment">        _INT1IF = 0;    // interrupt flag reset</span>
<a name="l02295"></a>02295 <span class="comment">        ClrWdt();               // [1]</span>
<a name="l02296"></a>02296 <span class="comment">        LED1=0;                 // [1]</span>
<a name="l02297"></a>02297 <span class="comment">}</span>
<a name="l02298"></a>02298 <span class="comment"></span>
<a name="l02299"></a>02299 <span class="comment">void _ISR_PSV _U1TXInterrupt(void)      // UART TX [6a]</span>
<a name="l02300"></a>02300 <span class="comment">{</span>
<a name="l02301"></a>02301 <span class="comment">        _U1TXIF = 0;    // interrupt flag reset</span>
<a name="l02302"></a>02302 <span class="comment"></span>
<a name="l02303"></a>02303 <span class="comment">        if (UartTxCntr &lt; UartTxBuffSize)</span>
<a name="l02304"></a>02304 <span class="comment">        {</span>
<a name="l02305"></a>02305 <span class="comment">                WriteUART1(UartTxBuff[UartTxCntr]);</span>
<a name="l02306"></a>02306 <span class="comment">                UartTxCntr++;</span>
<a name="l02307"></a>02307 <span class="comment">        }</span>
<a name="l02308"></a>02308 <span class="comment">        else</span>
<a name="l02309"></a>02309 <span class="comment">        {// waits for UART sending complete to disable the peripheral</span>
<a name="l02310"></a>02310 <span class="comment">                TxFlag = 2;     </span>
<a name="l02311"></a>02311 <span class="comment">        }</span>
<a name="l02312"></a>02312 <span class="comment">}</span>
<a name="l02313"></a>02313 <span class="comment">------------------ Disabled */</span>
<a name="l02314"></a>02314 <span class="comment">//}</span>
<a name="l02315"></a>02315 <span class="comment">/*****************************************************************************/</span>
<a name="l02316"></a>02316 
<a name="l02317"></a>02317 
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="ds_p_i_d33_8c.html">dsPID33.c</a>      </li>
<html>

	<head>
<meta name=Titolo content=dsNavCon>
<meta name="Parole chiave" content="">
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="../dsNavCon/dsNavCon_file/filelist.xml">
<title>dsNavCon Odometry</title>

<style id="dynCom" type="text/css"><!-- --></style>
<script language="JavaScript"><!--
function msoCommentShow(anchor_id, com_id)
{
	if(msoBrowserCheck()) 
		{
		c = document.all(com_id);
		if (null != c)
			{
			a = document.all(anchor_id);
			var cw = c.offsetWidth;
			var ch = c.offsetHeight;
			var aw = a.offsetWidth;
			var ah = a.offsetHeight;
			var x  = a.offsetLeft;
			var y  = a.offsetTop;
			var el = a;
			while (el.tagName != "BODY") 
				{
				el = el.offsetParent;
				x = x + el.offsetLeft;
				y = y + el.offsetTop;
				}
			var bw = document.body.clientWidth;
			var bh = document.body.clientHeight;
			var bsl = document.body.scrollLeft;
			var bst = document.body.scrollTop;
			if (x + cw + ah / 2 > bw + bsl && x + aw - ah / 2 - cw >= bsl ) 
				{ c.style.left = x + aw - ah / 2 - cw; }
			else 
				{ c.style.left = x + ah / 2; }
			if (y + ch + ah / 2 > bh + bst && y + ah / 2 - ch >= bst ) 
				{ c.style.top = y + ah / 2 - ch; }
			else 
				{ c.style.top = y + ah / 2; }
			c.style.visibility = "visible";
}	}	}
function msoCommentHide(com_id) 
{
	if(msoBrowserCheck())
		{
		c = document.all(com_id);
		if (null != c)
		{
		c.style.visibility = "hidden";
		c.style.left = -1000;
		c.style.top = -1000;
		} } 
}
function msoBrowserCheck()
{
	ms = navigator.appVersion.indexOf("MSIE");
	vers = navigator.appVersion.substring(ms + 5, ms + 6);
	ie4 = (ms > 0) && (parseInt(vers) >= 4);
	return ie4;
}
if (msoBrowserCheck())
{
	document.styleSheets.dynCom.addRule(".msocomanchor","background: infobackground");
	document.styleSheets.dynCom.addRule(".msocomoff","display: none");
	document.styleSheets.dynCom.addRule(".msocomtxt","visibility: hidden");
	document.styleSheets.dynCom.addRule(".msocomtxt","position: absolute");
	document.styleSheets.dynCom.addRule(".msocomtxt","top: -1000");
	document.styleSheets.dynCom.addRule(".msocomtxt","left: -1000");
	document.styleSheets.dynCom.addRule(".msocomtxt","width: 33%");
	document.styleSheets.dynCom.addRule(".msocomtxt","background: infobackground");
	document.styleSheets.dynCom.addRule(".msocomtxt","color: infotext");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-top: 1pt solid threedlightshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-right: 2pt solid threedshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-bottom: 2pt solid threedshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","border-left: 1pt solid threedlightshadow");
	document.styleSheets.dynCom.addRule(".msocomtxt","padding: 3pt 3pt 3pt 3pt");
}
// --></script>
<style><!--
 /* Font Definitions */
@font-face
	{font-family:"Times New Roman";
	panose-1:0 2 2 6 3 5 4 5 2 3;}
@font-face
	{font-family:"Courier New";
	panose-1:0 2 7 3 9 2 2 5 2 4;}
@font-face
	{font-family:Wingdings;
	panose-1:0 5 2 1 2 1 8 4 8 7;}
@font-face
	{font-family:"ＭＳ 明朝";}
@font-face
	{font-family:Optima;
	panose-1:0 2 0 5 3 6 0 0 2 0;}
@font-face
	{font-family:"Lucida Grande";}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:"Times New Roman";}
h1
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:0cm;
	tab-stops:list 18.0pt;
	font-size:36.0pt;
	font-family:Optima;}
h2
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	text-indent:0cm;
	mso-line-height-alt:17.0pt;
	tab-stops:31.2pt list 36.0pt;
	font-size:18.0pt;
	font-family:Optima;}
h3
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	text-indent:14.2pt;
	line-height:17.0pt;
	tab-stops:48.2pt list 50.2pt;
	font-size:14.0pt;
	font-family:Optima;
	color:black;}
h4
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:43.2pt;
	text-indent:-14.85pt;
	line-height:17.0pt;
	tab-stops:48.2pt list 64.35pt;
	font-size:12.0pt;
	font-family:Optima;
	color:black;}
h5
	{margin-top:6.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:50.4pt;
	text-indent:-22.05pt;
	line-height:17.0pt;
	tab-stops:list 64.35pt left 90.7pt 99.25pt;
	font-size:12.0pt;
	font-family:Optima;
	color:black;}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:"Times New Roman";}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:36.0pt;
	font-family:Optima;
	font-style:italic;
	font-weight:bold;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0cm;
	margin-bottom:.0001pt;
	tab-stops:center 240.95pt right 481.9pt;
	font-size:12.0pt;
	font-family:"Times New Roman";}
span.MsoCommentReference
	{font-size:9.0pt;}
p.MsoTitle, li.MsoTitle, div.MsoTitle
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	font-size:18.0pt;
	font-family:Optima;
	font-weight:bold;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:Courier;}
table.MsoNormalTable
	{font-size:10.0pt;
	font-family:"Times New Roman";}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{margin:0cm;
	margin-bottom:.0001pt;
	font-size:12.0pt;
	font-family:"Times New Roman";}
p.Titolone, li.Titolone, div.Titolone
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:21.6pt;
	margin-bottom:.0001pt;
	text-align:center;
	text-indent:-21.6pt;
	mso-line-height-alt:17.0pt;
	tab-stops:list 21.6pt;
	font-size:36.0pt;
	font-family:Optima;
	font-weight:bold;}
p.Glossario1, li.Glossario1, div.Glossario1
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	text-align:center;
	mso-line-height-alt:17.0pt;
	tab-stops:31.2pt;
	font-size:18.0pt;
	font-family:Optima;
	font-weight:bold;}
p.Glossario2, li.Glossario2, div.Glossario2
	{margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	line-height:17.0pt;
	tab-stops:48.2pt;
	font-size:14.0pt;
	font-family:Optima;
	color:black;
	font-weight:bold;}
p.testo2, li.testo2, div.testo2
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:51.05pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:center 233.9pt right 404.0pt;
	font-size:10.0pt;
	font-family:Optima;
	color:black;}
p.Tabella, li.Tabella, div.Tabella
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:center 233.9pt right 404.0pt;
	font-size:10.0pt;
	font-family:Optima;
	color:black;}
p.Testo1, li.Testo1, div.Testo1
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:34.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:35.45pt 3.0cm center 212.65pt right 14.0cm;
	font-size:10.0pt;
	font-family:Optima;}
p.tabellina, li.tabellina, div.tabellina
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:34.0pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:63.8pt 148.85pt 177.2pt 219.7pt 269.35pt 12.0cm 382.75pt;
	font-size:8.0pt;
	font-family:Optima;
	font-weight:bold;}
p.Testo3, li.Testo3, div.Testo3
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:65.2pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:111.2pt;
	font-size:10.0pt;
	font-family:Optima;}
p.Testo4, li.Testo4, div.Testo4
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:90.7pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:111.2pt 5.0cm 6.0cm;
	font-size:10.0pt;
	font-family:Optima;}
p.Testo2Italic, li.Testo2Italic, div.Testo2Italic
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:51.05pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:center 233.9pt right 404.0pt;
	font-size:10.0pt;
	font-family:Optima;
	color:black;
	font-style:italic;}
p.Testo3Italic, li.Testo3Italic, div.Testo3Italic
	{margin-top:0cm;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:65.2pt;
	margin-bottom:.0001pt;
	text-align:justify;
	tab-stops:111.2pt;
	font-size:10.0pt;
	font-family:Optima;
	font-style:italic;}
@page Section1
	{size:595.3pt 841.9pt;
	margin:42.55pt 2.0cm 42.55pt 2.0cm;}
div.Section1
	{page:Section1;}
@page Section2
	{size:595.3pt 841.9pt;
	margin:42.55pt 2.0cm 42.55pt 2.0cm;}
div.Section2
	{page:Section2;}
 /* List Definitions */
@list l0:level1
	{text-indent:-18.0pt;
	tab-stops:list 36.0pt;
	font-family:Symbol;}
@list l0:level2
	{text-indent:-18.0pt;
	tab-stops:list 72.0pt;
	font-family:"Courier New";}
@list l1:level1
	{text-indent:-18.0pt;
	tab-stops:list 36.0pt;
	font-family:Symbol;}
@list l2:level1
	{text-indent:-18.0pt;
	tab-stops:list 36.0pt;
	font-family:Symbol;}
@list l3:level1
	{margin-left:21.6pt;
	text-indent:-21.6pt;
	tab-stops:list 21.6pt;}
@list l3:level2
	{margin-left:28.8pt;
	text-indent:-28.8pt;
	tab-stops:list 28.8pt;}
@list l3:level3
	{margin-left:36.0pt;
	text-indent:-36.0pt;
	tab-stops:list 36.0pt;}
@list l3:level4
	{margin-left:43.2pt;
	text-indent:-43.2pt;
	tab-stops:list 43.2pt;}
@list l3:level5
	{margin-left:50.4pt;
	text-indent:-50.4pt;
	tab-stops:list 50.4pt;}
@list l3:level6
	{margin-left:57.6pt;
	text-indent:-57.6pt;
	tab-stops:list 57.6pt;}
@list l3:level7
	{margin-left:64.8pt;
	text-indent:-64.8pt;
	tab-stops:list 64.8pt;}
@list l3:level8
	{margin-left:72.0pt;
	text-indent:-72.0pt;
	tab-stops:list 72.0pt;}
@list l3:level9
	{margin-left:79.2pt;
	text-indent:-79.2pt;
	tab-stops:list 79.2pt;}
@list l4:level1
	{margin-left:0cm;
	text-indent:0cm;
	tab-stops:list 18.0pt;
	font-size:1.0pt;}
@list l4:level2
	{margin-left:0cm;
	text-indent:0cm;
	tab-stops:list 36.0pt;
	font-size:14.0pt;}
@list l4:level3
	{margin-left:0cm;
	text-indent:14.2pt;
	tab-stops:list 50.2pt;
	font-size:10.0pt;
	font-weight:bold;
	font-style:normal;}
@list l4:level4
	{margin-left:43.2pt;
	text-indent:-14.85pt;
	tab-stops:list 64.35pt;
	font-size:8.0pt;}
@list l4:level5
	{margin-left:50.4pt;
	text-indent:-22.05pt;
	tab-stops:list 64.35pt;
	font-size:8.0pt;}
@list l4:level6
	{margin-left:57.6pt;
	text-indent:-57.6pt;
	tab-stops:list 57.6pt;}
@list l4:level7
	{margin-left:64.8pt;
	text-indent:-64.8pt;
	tab-stops:list 64.8pt;}
@list l4:level8
	{margin-left:72.0pt;
	text-indent:-72.0pt;
	tab-stops:list 72.0pt;}
@list l4:level9
	{margin-left:79.2pt;
	text-indent:-79.2pt;
	tab-stops:list 79.2pt;}
@list l5:level1
	{margin-left:72.0pt;
	text-indent:-18.0pt;
	tab-stops:list 72.0pt;
	font-family:Symbol;}
ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
--></style>
</head>

	<body lang=IT link=blue vlink=purple style="tab-interval:36.0pt">
		<div class=Section1>
			<div style="position:relative; width:805px; height:35; -adbe-g:p;">
			  <div style="position:relative; width:350; height:35; -adbe-g:p;">
			    <div style="position:absolute; top:-2px; left:8px; width:81px; height:35px;"> <span lang=EN-US style='font-size:12.0pt;font-family:"Times New Roman"'><a href="http://www.guiott.com/Rino/index.html"><img src="http://www.guiott.com/Rino/rino.jpg" alt="" width="81" height="35" align="absmiddle" border="0"></a></span></div>
			    <div colspan="2" style="position:absolute; top:7px; left:95px; width:175px; height:22px; -adbe-c:c; text-align: left;">
			      <div align="right"> <strong><font size="-1">updated on 13-12-2011</font></strong></div>
		        </div>
		      </div>
            </div>
	</div>
		<div class=Section1 align="center"></div>
		<div class=Section1>
			<p class=MsoNormal align=center style="text-align:center;tab-stops:right 411.1pt"></p>
		</div>
	</body>

</html>






